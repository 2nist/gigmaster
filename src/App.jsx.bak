/**
 * App.jsx - Refactored Main Application Component
 * 
 * Phase 0 Refactoring Complete:
 * - Uses specialized hooks for state management
 * - Imports page components
 * - Orchestrates game flow
 * - Minimal logic (300 lines vs 6,117 original)
 */

import React, { useEffect } from 'react';
import './styles.css';

// Import hooks
import {
  useGameState,
  useUIState,
  useModalState,
  useGameLogic,
  useEnhancedDialogue,
  useEventGeneration
} from './hooks';

// Import page components
import { LandingPage, GamePage } from './pages';
import { EnhancedEventModal } from './components/EnhancedEventModal';

// Import modals
import WriteSongModal from './components/Modals/WriteSongModal';
import AlbumBuilderModal from './components/Modals/AlbumBuilderModal';
import SaveModal from './components/Modals/SaveModal';
import LoadModal from './components/Modals/LoadModal';
import BandStatsModal from './components/Modals/BandStatsModal';

/**
 * Main App Component
 * 
 * Architecture:
 * - useGameState: Core game data
 * - useUIState: Navigation and UI state
 * - useModalState: Modal management
 * - useGameLogic: Game actions
 * - useEnhancedDialogue: Psychological state + narrative
 * - useEventGeneration: Procedural events
 */
function App() {
  // Initialize hooks
  const gameState = useGameState();
  const uiState = useUIState();
  const modalState = useModalState();
  const gameLogic = useGameLogic(gameState);
  const dialogueState = useEnhancedDialogue();
  const eventGen = useEventGeneration(
    gameState.gameData,
    dialogueState.psychologicalState,
    dialogueState.narrativeState
  );
  const [step, setStep] = useState(STEPS.LANDING);
  const [state, setState] = useState(initialState);
  const [selectedVenue, setSelectedVenue] = useState(null);
  const [currentEvent, setCurrentEvent] = useState(null);
  const [customFont, setCustomFont] = useState('');
  const [rivals, setRivals] = useState([]);
  const [desiredRoles, setDesiredRoles] = useState(['vocals', 'guitar', 'bass', 'drums']);
  const [editingMemberId, setEditingMemberId] = useState(null);
  const [lineupAddRole, setLineupAddRole] = useState('vocals');
  const [recruitOptions, setRecruitOptions] = useState([]);
  const [showStudioModal, setShowStudioModal] = useState(false);
  const [showTransportModal, setShowTransportModal] = useState(false);
  const [showGearModal, setShowGearModal] = useState(false);
  const [showAlbumBuilderModal, setShowAlbumBuilderModal] = useState(false);
  const [showLabelNegotiation, setShowLabelNegotiation] = useState(false);
  const [showWriteSongModal, setShowWriteSongModal] = useState(false);
  const [newSongTitle, setNewSongTitle] = useState('');
  const [labelOffer, setLabelOffer] = useState(null);
  const [negotiationStep, setNegotiationStep] = useState('offer'); // offer, counter, accept
  const [selectedBandStats, setSelectedBandStats] = useState(null); // For band stats modal
  const [currentTab, setCurrentTab] = useState('overview'); // overview, actions, band, music, upgrades, log
  const [leftTab, setLeftTab] = useState('snapshot'); // snapshot, meters, team, songs
  const [rightTab, setRightTab] = useState('topChart'); // topChart, albums, songChart
  const [gigsView, setGigsView] = useState('local'); // 'local' or 'tours'
  const [selectedTourType, setSelectedTourType] = useState(null);
  const [selectedTourRegion, setSelectedTourRegion] = useState('us');
  const [theme, setTheme] = useState('theme-modern'); // theme-warm, theme-neon, theme-pop, theme-modern
  const [darkMode, setDarkMode] = useState(false);
  const [showSaveModal, setShowSaveModal] = useState(false);
  const [showLoadModal, setShowLoadModal] = useState(false);
  const [saveSlots, setSaveSlots] = useState(() => {
    // Load save slots from localStorage
    try {
      const saved = localStorage.getItem('bandManager_saveSlots');
      return saved ? JSON.parse(saved) : {};
    } catch {
      return {};
    }
  });
  const [autoSaveEnabled, setAutoSaveEnabled] = useState(() => {
    const saved = localStorage.getItem('bandManager_autoSave');
    return saved === 'true';
  });
  const [showSettings, setShowSettings] = useState(false);
  const [showTooltip, setShowTooltip] = useState(null);
  const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });
  const [showTutorial, setShowTutorial] = useState(false);
  const [tutorialStep, setTutorialStep] = useState(0);
  const [showEventPopup, setShowEventPopup] = useState(false);
  const [eventPopupData, setEventPopupData] = useState(null);
  const [showWeeklyPopup, setShowWeeklyPopup] = useState(false);
  const [weeklyPopupData, setWeeklyPopupData] = useState(null);

  // Apply theme to body
  useEffect(() => {
    document.body.className = `${theme} ${darkMode ? 'dark' : ''}`;
  }, [theme, darkMode]);

  // Debug: Monitor songs changes
  useEffect(() => {
    console.log('[State Monitor] Songs updated:', state.songs?.length || 0, 'Titles:', state.songs?.map(s => s.title) || []);
  }, [state.songs]);

  const [fontOptions, setFontOptions] = useState([
    'Arial',
    // Heavy Metal & Hard Rock
    'Metal Mania',
    'New Rocker',
    'Creepster',
    'Russo One',
    'Ultra',
    'Shojumaru',
    'Pirata One',
    // Punk, Grunge & Garage Rock
    'Underdog',
    'Rock Salt',
    'Special Elite',
    'Bungee',
    'Road Rage',
    'Permanent Marker',
    'Bangers',
    // Indie, Alternative & Folk
    'Syne',
    'Space Grotesk',
    'Indie Flower',
    'Eczar',
    'Arapey',
    'Spectral',
    'Smythe',
    'Cormorant',
    // Electronic, Synthwave & Pop
    'Orbitron',
    'Monoton',
    'Righteous',
    'DotGothic16',
    'Tourney',
    'Exo 2',
    'Gugi',
    'RocknRoll One',
    // Modern Rock & Classic Professional
    'Bebas Neue',
    'Anton',
    'Oswald',
    'Montserrat',
    'Raleway',
    'Archivo Black',
    'Fjalla One',
    'Alfa Slab One',
    // Additional fonts
    'Poppins',
    'Syncopate',
    'Playfair Display',
    'Lobster',
    'Abril Fatface',
    'Lora',
    'Libre Baskerville',
    'Pacifico',
    'Unbounded',
    'Inter',
    'Roboto',
    'Press Start 2P',
    'Fira Sans',
    'Nunito',
    'Work Sans',
    'Manrope',
    'Barlow',
    'Sora',
    'Kanit'
  ]);

  // Auto-save functionality
  useEffect(() => {
    if (!autoSaveEnabled || step !== STEPS.GAME || !state.bandName) return;
    
    const autoSaveData = {
      state,
      rivals,
      step,
      theme,
      timestamp: new Date().toISOString()
    };
    
    try {
      localStorage.setItem('bandManager_autoSave', JSON.stringify(autoSaveData));
    } catch (err) {
      console.warn('Auto-save failed:', err);
    }
  }, [state.week, state.money, state.fame, autoSaveEnabled, step, state.bandName, state, rivals, theme]);

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Only handle shortcuts when in game
      if (step !== STEPS.GAME) return;
      
      // Ctrl/Cmd + S: Save
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        setShowSaveModal(true);
      }
      
      // Ctrl/Cmd + L: Load
      if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
        e.preventDefault();
        setShowLoadModal(true);
      }
      
      // Number keys for tabs (1-7)
      if (e.key >= '1' && e.key <= '7' && !e.ctrlKey && !e.metaKey && !e.shiftKey && !e.altKey) {
        const tabIndex = parseInt(e.key) - 1;
        const tabs = ['overview', 'actions', 'music', 'social', 'gigs', 'analytics', 'upgrades'];
        if (tabs[tabIndex]) {
          setCurrentTab(tabs[tabIndex]);
        }
      }
      
      // Escape: Close modals
      if (e.key === 'Escape') {
        setShowSaveModal(false);
        setShowLoadModal(false);
        setShowSettings(false);
        setShowAlbumBuilderModal(false);
        setShowLabelNegotiation(false);
        setShowStudioModal(false);
        setShowTransportModal(false);
        setShowGearModal(false);
        setSelectedBandStats(null);
      }
    };
    
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [step, currentTab]);

  useEffect(() => {
    if (!data) return;
    const fallbackNames = [
      'Neon Owls', 'Static Bloom', 'Velvet Volt', 'City Sirens', 'Moonlit Riot',
      'Crimson Echo', 'Glass Tiger', 'Royal Static', 'Analog Hearts', 'Shadow Parade',
      'Aurora Flux', 'Golden Alley', 'Paper Satellites', 'Silver Stereo', 'Echo Arcade',
      'Night Mechanics', 'Carbon Bloom', 'Gilded Youth', 'Starlit Exit', 'Metro Ghosts',
      'Satellite Choir', 'Neon District', 'Midnight Tenors'
    ];
    const pool = [...(data.bandNames || []), ...fallbackNames];
    const seeded = pool.slice(0, 24).map((name, idx) => {
      const fame = Math.floor(Math.random() * 200) + 50;
      const songCount = Math.floor(Math.random() * 8) + 3;
      const albumCount = Math.floor(fame / 100);
      
      // Generate songs for this rival (popularity proportional to fame)
      const songs = Array.from({ length: songCount }, (_, i) => {
        const basePop = Math.floor(fame * 0.5) + Math.floor(Math.random() * 30);
        const quality = Math.floor(60 + (fame / 5) + Math.random() * 20);
        return {
          title: `${data?.songTitles?.[idx * songCount + i] || `Song ${i + 1}`}`,
          popularity: Math.min(100, basePop),
          quality,
          weeklyStreams: Math.floor(basePop * 50 + Math.random() * 2000),
          age: Math.floor(Math.random() * 20),
          inAlbum: false
        };
      });
      
      // Generate albums for this rival
      const albums = Array.from({ length: albumCount }, (_, i) => {
        const albumQuality = Math.floor(60 + (fame / 4) + Math.random() * 25);
        const albumPop = Math.floor(fame * 0.6 + Math.random() * 30);
        return {
          name: `${name} ${i === 0 ? '' : `Vol. ${i + 1}`}`,
          quality: Math.min(100, albumQuality),
          popularity: Math.min(100, albumPop),
          chartScore: Math.floor(albumQuality * 0.8 + albumPop * 0.3),
          age: Math.floor(Math.random() * 30),
          songs: 8 + Math.floor(Math.random() * 5),
          promoBoost: Math.max(0, 10 - Math.floor(Math.random() * 8)),
          week: Math.floor(Math.random() * state.week) || 1
        };
      });
      
      return {
      name,
        fame,
      chartPosition: null,
        songs,
        albums,
        totalStreams: songs.reduce((sum, s) => sum + (s.weeklyStreams || 0), 0) + 
                     albums.reduce((sum, a) => sum + Math.floor((a.quality || 0) * 15), 0)
      };
    });
    setRivals(seeded);
  }, [data, state.week]);

  const availableVenues = useMemo(() => {
    if (!data) return [];
    return (data.venues || []).filter(v => state.fame >= v.fameRequired).slice(0, 3);
  }, [data, state.fame]);

  const chartLeaders = useMemo(() => {
    const playerBand = state.bandName
      ? {
          name: state.bandName,
          fame: state.fame,
          isPlayer: true,
          songs: state.songs || [],
          albums: state.albums || [],
          totalStreams: (state.songs || []).reduce((sum, s) => sum + (s.weeklyStreams || 0), 0) +
                       (state.albums || []).reduce((sum, a) => {
                         const albumStreams = Math.floor((a.quality || 0) * 150 + (a.popularity || 0) * 80) * Math.max(0.3, 1 - (a.age || 0) * 0.02);
                         return sum + albumStreams;
                       }, 0)
        }
      : null;
    
    const pool = playerBand ? [...rivals, playerBand] : [...rivals];
    const sorted = [...pool].sort((a, b) => b.fame - a.fame);
    const result = sorted.slice(0, 20).map((b, idx) => ({ ...b, position: idx + 1 }));
    
    if (playerBand) {
      console.log('[chartLeaders] Player band:', playerBand.name, 'Fame:', playerBand.fame, 'Songs:', playerBand.songs.length, 'Albums:', playerBand.albums.length);
    }
    
    return result;
  }, [rivals, state.bandName, state.fame, state.songs, state.albums]);

  const albumChart = useMemo(() => {
    // Player albums
    const playerAlbums = (Array.isArray(state.albums) ? state.albums : []).map((a) => ({
      ...a,
      bandName: state.bandName || 'Your Band',
      isPlayer: true,
      chartScore: a.chartScore ?? Math.max(0, Math.floor((a.quality || 0) * 0.8 + (a.popularity || 0) * 0.3)),
      totalStreams: Math.floor((a.quality || 0) * 150 + (a.popularity || 0) * 80) * (1 - (a.age || 0) * 0.02)
    }));
    
    // Debug logging
    if (playerAlbums.length > 0) {
      console.log('[albumChart] Player albums found:', playerAlbums.length, 'Album names:', playerAlbums.map(a => a.name));
    }
    
    // Rival albums
    const rivalAlbums = rivals.flatMap(r => 
      (r.albums || []).map(a => ({
        ...a,
        bandName: r.name,
        isPlayer: false,
        chartScore: a.chartScore || Math.max(0, Math.floor((a.quality || 0) * 0.8 + (a.popularity || 0) * 0.3)),
        totalStreams: Math.floor((a.quality || 0) * 150 + (a.popularity || 0) * 80) * Math.max(0.3, 1 - (a.age || 0) * 0.02)
      }))
    );
    
    // Combine and sort
    const allAlbums = [...playerAlbums, ...rivalAlbums];
    const sorted = allAlbums.sort((a, b) => (b.chartScore || 0) - (a.chartScore || 0));
    const result = sorted.slice(0, 20).map((a, idx) => ({ ...a, position: idx + 1 }));
    console.log('[albumChart] Final chart length:', result.length);
    return result;
  }, [state.albums, rivals, state.bandName]);

  const songChart = useMemo(() => {
    // Player songs
    const playerSongs = (Array.isArray(state.songs) ? state.songs : []).map(s => ({
      ...s,
      bandName: state.bandName || 'Your Band',
      isPlayer: true,
      chartScore: (s.popularity || 0) * 10 + (s.weeklyStreams || 0) * 0.1
    }));
    
    // Debug logging
    if (playerSongs.length > 0) {
      console.log('[songChart] Player songs found:', playerSongs.length, 'Song titles:', playerSongs.map(s => s.title));
    }
    
    // Rival songs
    const rivalSongs = rivals.flatMap(r => 
      (r.songs || []).map(s => ({
        ...s,
        bandName: r.name,
        isPlayer: false,
        chartScore: (s.popularity || 0) * 10 + (s.weeklyStreams || 0) * 0.1
      }))
    );
    
    // Combine and sort
    const allSongs = [...playerSongs, ...rivalSongs];
    const sorted = allSongs.sort((a, b) => (b.chartScore || 0) - (a.chartScore || 0));
    const result = sorted.slice(0, 30).map((s, idx) => ({ ...s, position: idx + 1 }));
    console.log('[songChart] Final chart length:', result.length);
    return result;
  }, [state.songs, rivals, state.bandName]);

  useEffect(() => {
    if (availableVenues.length && !selectedVenue) {
      setSelectedVenue(availableVenues[0]);
    }
    if (!availableVenues.length) {
      setSelectedVenue(null);
    }
  }, [availableVenues, selectedVenue]);

  const addLog = (entry, showPopup = false, popupData = null) => {
    setState((s) => ({
      ...s,
      log: [entry, ...s.log].slice(0, 12)
    }));
    
    // Show popup for important events
    if (showPopup || popupData) {
      setEventPopupData({
        title: popupData?.title || 'Event',
        message: entry,
        details: popupData?.details || null,
        type: popupData?.type || 'info', // 'info', 'success', 'warning', 'error'
        choices: popupData?.choices || []
      });
      setShowEventPopup(true);
    }
  };

  // Parse weekly summary into structured data
  const parseWeeklySummary = (summary, week) => {
    const parts = summary.split(' | ');
    const mainInfo = parts[0] || summary;
    const highlights = parts.slice(1).filter(p => p.trim());
    
    // Extract key metrics from main info
    const expensesMatch = mainInfo.match(/expenses \$(\d+)/);
    const royaltiesMatch = mainInfo.match(/royalties \$(\d+)/);
    const fansMatch = mainInfo.match(/fans \+(\d+)/);
    
    return {
      week,
      expenses: expensesMatch ? parseInt(expensesMatch[1]) : 0,
      royalties: royaltiesMatch ? parseInt(royaltiesMatch[1]) : 0,
      fanGrowth: fansMatch ? parseInt(fansMatch[1]) : 0,
      mainInfo,
      highlights,
      fullText: summary
    };
  };

  // Save game function
  const saveGame = (slotName) => {
    const saveData = {
      state,
      rivals,
      step,
      theme,
      timestamp: new Date().toISOString(),
      bandName: state.bandName,
      week: state.week,
      fame: state.fame,
      money: state.money
    };
    
    try {
      const updatedSlots = { ...saveSlots, [slotName]: saveData };
      setSaveSlots(updatedSlots);
      localStorage.setItem('bandManager_saveSlots', JSON.stringify(updatedSlots));
      addLog(`Game saved to slot: ${slotName}`);
      setShowSaveModal(false);
    } catch (err) {
      alert('Failed to save game. LocalStorage may be full.');
      console.error('Save error:', err);
    }
  };

  // Load game function
  const loadGame = (slotName) => {
    const saveData = saveSlots[slotName];
    if (!saveData) {
      alert('No save data found in this slot.');
      return;
    }
    
    try {
      setState(saveData.state);
      setRivals(saveData.rivals || []);
      setStep(saveData.step || STEPS.GAME);
      if (saveData.theme) setTheme(saveData.theme);
      addLog(`Game loaded from slot: ${slotName} (Week ${saveData.state.week})`);
      setShowLoadModal(false);
    } catch (err) {
      alert('Failed to load game. Save data may be corrupted.');
      console.error('Load error:', err);
    }
  };

  // Delete save slot
  const deleteSave = (slotName) => {
    if (!confirm(`Delete save slot "${slotName}"?`)) return;
    
    const updatedSlots = { ...saveSlots };
    delete updatedSlots[slotName];
    setSaveSlots(updatedSlots);
    localStorage.setItem('bandManager_saveSlots', JSON.stringify(updatedSlots));
  };

  const buildCandidate = (role, personalities = []) => buildMember(role, personalities);


  const renderInstrumentIcon = (role) => {
    const stroke = '#c084fc';
    const fill = '#1f2937';
    switch (role) {
      case 'drums':
        return (
          <svg width="36" height="36" viewBox="0 0 64 64" aria-hidden>
            <circle cx="20" cy="32" r="12" fill={fill} stroke={stroke} strokeWidth="3" />
            <circle cx="44" cy="32" r="12" fill={fill} stroke={stroke} strokeWidth="3" />
            <rect x="14" y="28" width="36" height="8" fill={stroke} opacity="0.5" />
          </svg>
        );
      case 'bass':
        return (
          <svg width="36" height="36" viewBox="0 0 64 64" aria-hidden>
            <rect x="12" y="10" width="8" height="44" fill={stroke} opacity="0.5" />
            <rect x="44" y="10" width="4" height="44" fill={stroke} />
            <rect x="22" y="22" width="12" height="20" fill={fill} stroke={stroke} strokeWidth="2" />
          </svg>
        );
      case 'guitar':
        return (
          <svg width="36" height="36" viewBox="0 0 64 64" aria-hidden>
            <rect x="40" y="8" width="4" height="32" fill={stroke} />
            <path d="M20 26c6-6 14-6 20 0s6 14 0 20-14 6-20 0-6-14 0-20z" fill={fill} stroke={stroke} strokeWidth="3" />
          </svg>
        );
      case 'synth':
        return (
          <svg width="36" height="36" viewBox="0 0 64 64" aria-hidden>
            <rect x="10" y="18" width="44" height="24" rx="4" fill={fill} stroke={stroke} strokeWidth="3" />
            <rect x="14" y="24" width="4" height="12" fill={stroke} />
            <rect x="22" y="24" width="4" height="12" fill={stroke} />
            <rect x="30" y="24" width="4" height="12" fill={stroke} />
            <rect x="38" y="24" width="4" height="12" fill={stroke} />
            <rect x="46" y="24" width="4" height="12" fill={stroke} />
          </svg>
        );
      case 'dj':
        return (
          <svg width="36" height="36" viewBox="0 0 64 64" aria-hidden>
            <circle cx="24" cy="32" r="12" fill={fill} stroke={stroke} strokeWidth="3" />
            <circle cx="40" cy="32" r="12" fill={fill} stroke={stroke} strokeWidth="3" />
            <circle cx="24" cy="32" r="4" fill={stroke} />
            <circle cx="40" cy="32" r="4" fill={stroke} />
          </svg>
        );
      default:
        return (
          <svg width="36" height="36" viewBox="0 0 64 64" aria-hidden>
            <path d="M20 20h24v24H20z" fill={fill} stroke={stroke} strokeWidth="3" />
          </svg>
        );
    }
  };

  const renderRadar = (stats) => {
    const axes = [
      { key: 'skill', label: 'Skill' },
      { key: 'creativity', label: 'Creativity' },
      { key: 'stagePresence', label: 'Stage' },
      { key: 'reliability', label: 'Reliability' }
    ];
    const center = 60;
    const radius = 42;
    const base = 12; // inner padding

    const pointFor = (pct, idx) => {
      const r = base + radius * pct;
      const angle = (-Math.PI / 2) + (idx * (Math.PI * 2) / axes.length);
      const x = center + r * Math.cos(angle);
      const y = center + r * Math.sin(angle);
      return { x, y };
    };

    const ringPoints = (pct) => axes.map((_, idx) => {
      const p = pointFor(pct, idx);
      return `${p.x},${p.y}`;
    }).join(' ');

    const dataPoints = axes.map((entry, idx) => {
      const pct = Math.max(0, Math.min(10, stats?.[entry.key] ?? 0)) / 10;
      const p = pointFor(pct, idx);
      return `${p.x},${p.y}`;
    }).join(' ');

    return (
      <div className="radar-wrap">
        <svg width="240" height="240" viewBox="0 0 120 120" className="radar" aria-hidden>
          <polygon points={ringPoints(1)} fill="#0d1324" stroke="#1f2937" strokeWidth="2" />
          {Array.from({ length: 9 }).map((_, i) => {
            const pct = (i + 1) / 10;
            return (
              <polygon key={pct} points={ringPoints(pct)} fill="none" stroke="#334155" strokeDasharray="3 3" />
            );
          })}
          {axes.map((entry, idx) => {
            const end = pointFor(1, idx);
            return (
              <g key={entry.key}>
                <line x1={center} y1={center} x2={end.x} y2={end.y} stroke="#475569" strokeWidth="1" />
                <text x={end.x} y={end.y} className="radar-label" textAnchor="middle" dominantBaseline="middle">{entry.label}</text>
              </g>
            );
          })}
          <polygon points={dataPoints} fill="rgba(124,58,237,0.32)" stroke="#c084fc" strokeWidth="2.5" />
        </svg>
      </div>
    );
  };

  const logoStyle = useMemo(() => {
    if (state.logoFont) {
      ensureFontLoaded(state.logoFont);
    }
    return calculateLogoStyle(state);
  }, [state.logoFont, state.logoWeight, state.logoSize, state.logoLetter, state.logoLineHeight, state.logoTextColor, state.logoBgColor, state.logoBgColor2, state.logoGradient, state.logoShadow, state.logoOutline, state.logoOutlineWidth, state.logoOutlineColor, state.logoUpper]);

  const processWeekEffects = (s) => {
    // Difficulty multipliers
    const difficulty = s.difficulty || 'normal';
    const costMultiplier = difficulty === 'easy' ? 0.8 : difficulty === 'hard' ? 1.2 : 1;
    const revenueMultiplier = difficulty === 'easy' ? 1.2 : difficulty === 'hard' ? 0.8 : 1;
    
    const baseExpenses = Math.floor(100 * costMultiplier);
    const memberSalaries = Math.floor(s.members.length * 50 * costMultiplier);
    const equipmentCosts = Math.floor(({ basic: 20, good: 50, professional: 100 }[s.equipment.instruments] || 20) * costMultiplier);
    const transportCosts = Math.floor(({ none: 0, van: 50, bus: 150, tourBus: 300 }[s.equipment.transport] || 0) * costMultiplier);
    const staffCosts = Math.floor((
      (s.staffManager === 'dodgy' ? 80 : s.staffManager === 'pro' ? 150 : 0) +
      (s.staffLawyer ? 90 : 0)
    ) * costMultiplier);
    
    // Label contract costs (independent has monthly fee)
    let labelCosts = 0;
    if (s.labelDeal) {
      if (s.labelDeal.type === 'independent') {
        labelCosts = Math.floor((s.labelDeal.monthlyFee || 20) * costMultiplier); // Monthly fee, roughly weekly
      }
      // Other label types don't have weekly fees, but take royalties (handled separately)
    }
    
    const weeklyExpenses = baseExpenses + memberSalaries + equipmentCosts + transportCosts + labelCosts;

    // Enhanced genre trend system with dynamic shifts
    let newTrend = s.trend;
    const trendNotes = [];
    
    // Track genre trends history
    const updatedGenreTrends = { ...(s.genreTrends || {}) };
    if (!updatedGenreTrends[s.genre]) {
      updatedGenreTrends[s.genre] = { popularity: 50, weeks: 0 };
    }
    
    // Seasonal trends (summer hits, holiday albums)
    const weekOfYear = s.week % 52;
    let seasonalBoost = 0;
    const seasonalNote = [];
    
    // Summer (weeks 20-35): Pop, Dance, Electronic get boost
    if (weekOfYear >= 20 && weekOfYear <= 35) {
      if (s.genre === 'Pop' || s.genre === 'Dance' || s.genre === 'Electronic') {
        seasonalBoost = 8;
        seasonalNote.push('Summer boost');
      }
    }
    
    // Holiday season (weeks 45-52, 1-5): Holiday music boost
    if ((weekOfYear >= 45 && weekOfYear <= 52) || (weekOfYear >= 1 && weekOfYear <= 5)) {
      if (s.genre === 'Pop' || s.genre === 'Rock') {
        seasonalBoost = 5;
        seasonalNote.push('Holiday season boost');
      }
    }
    
    // Dynamic genre trend system
    if (!newTrend || newTrend.weeks <= 0) {
      // 15% chance of new trend (slightly higher than before)
      if (Math.random() < 0.15) {
        const genre = randomFrom(data?.genres || GENRES);
        // Trends can be stronger or weaker
        const trendStrength = Math.random() < 0.3 ? 'major' : Math.random() < 0.6 ? 'moderate' : 'minor';
        const modifier = trendStrength === 'major' ? 18 + Math.floor(Math.random() * 8) :
                        trendStrength === 'moderate' ? 12 + Math.floor(Math.random() * 6) :
                        6 + Math.floor(Math.random() * 4);
        const weeks = trendStrength === 'major' ? 6 + Math.floor(Math.random() * 3) :
                     trendStrength === 'moderate' ? 4 + Math.floor(Math.random() * 2) :
                     2 + Math.floor(Math.random() * 2);
        newTrend = { genre, modifier, weeks, strength: trendStrength };
        trendNotes.push(`${trendStrength === 'major' ? 'ðŸ”¥ Major' : trendStrength === 'moderate' ? 'ðŸ“ˆ' : 'ðŸ“Š'} ${genre} trend! Lasts ${weeks} weeks (+${modifier}% popularity).`);
        
        // Update genre popularity tracking
        if (!updatedGenreTrends[genre]) {
          updatedGenreTrends[genre] = { popularity: 50, weeks: 0 };
        }
        updatedGenreTrends[genre].popularity = Math.min(100, updatedGenreTrends[genre].popularity + 10);
        updatedGenreTrends[genre].weeks = newTrend.weeks;
      }
    } else {
      newTrend = { ...newTrend, weeks: newTrend.weeks - 1 };
      if (newTrend.weeks === 0) {
        trendNotes.push(`${newTrend.genre} trend cooled off.`);
        // Genre popularity decays when trend ends
        if (updatedGenreTrends[newTrend.genre]) {
          updatedGenreTrends[newTrend.genre].popularity = Math.max(30, updatedGenreTrends[newTrend.genre].popularity - 5);
        }
        newTrend = null;
      } else {
        // Gradually reduce trend strength
        const decayRate = newTrend.strength === 'major' ? 1.5 : newTrend.strength === 'moderate' ? 1 : 0.5;
        newTrend.modifier = Math.max(2, newTrend.modifier - decayRate);
      }
    }

    let totalRoyalty = 0;
    
    // Album streaming revenue (2026: albums generate sustained streams)
    const albumStreamingRevenue = (s.albums || []).reduce((total, album) => {
      const albumAge = album.age || 0;
      const albumPopularity = album.popularity || 0;
      const albumQuality = album.quality || 0;
      
      // Albums generate streams based on quality and popularity
      // Newer albums generate more streams (decay over time)
      const freshness = Math.max(0.3, 1 - (albumAge * 0.02)); // Slow decay
      const baseAlbumStreams = Math.floor((albumQuality * 150) + (albumPopularity * 80));
      const albumStreams = Math.floor(baseAlbumStreams * freshness);
      
      // Album streams are distributed across all songs in the album
      // But also generate direct album-level revenue
      const albumStreamRevenue = Math.floor(albumStreams * 0.004); // Same rate as single streams
      
      return total + albumStreamRevenue;
    }, 0);
    
    // Song streaming revenue (preliminary calculation using unprocessed songs)
    // Note: Final calculation happens later using processed songs
    const songStreamingRevenue = (s.songs || []).reduce((total, song) => {
      // Estimate streams from popularity (this is refined later in the processed songs)
      const estimatedStreams = Math.floor((song.popularity || 0) * 60);
      return total + Math.floor(estimatedStreams * 0.004);
    }, 0);
    
    // Apply difficulty revenue multiplier (preliminary - final calculation is later)
    totalRoyalty = Math.floor((albumStreamingRevenue + songStreamingRevenue) * revenueMultiplier);

    // Label marketing benefits (playlist pitches, radio promo boost popularity)
    let labelMarketingBoost = 0;
    if (s.labelDeal && s.labelDeal.marketingBudget > 0) {
      // Marketing budget translates to popularity boost
      labelMarketingBoost = Math.floor(s.labelDeal.marketingBudget / 10); // Rough conversion
    }

    const albums = (s.albums || []).map((album) => {
      const age = (album.age || 0) + 1;
      const decay = Math.max(0, 14 - age); // stronger early weeks
      let promo = Math.max(0, (album.promoBoost || 0) - 1);
      
      // Label marketing adds to promo boost
      if (s.labelDeal && s.labelDeal.marketingBudget > 0) {
        promo = Math.min(20, promo + Math.floor(s.labelDeal.marketingBudget / 100)); // Marketing sustains promo
      }
      
      const score = Math.max(0, Math.floor(album.quality * 0.8 + decay + promo + labelMarketingBoost));
      return { ...album, age, promoBoost: promo, chartScore: score };
    });
    console.log('[processWeekEffects] Processing songs, input count:', (s.songs || []).length, 'Titles:', (s.songs || []).map(s => s.title));
    const songs = (s.songs || []).map((song) => {
      const basePopularity = song.popularity ?? Math.floor(song.quality * 0.6);
      const decayed = Math.max(0, basePopularity - 5 + Math.floor(Math.random() * 3));
      
      // Album boost: Songs in albums get popularity boost from album's promo
      let albumBoost = 0;
      if (song.inAlbum && s.albums && s.albums.length > 0) {
        const containingAlbum = s.albums.find(a => a.songTitles && a.songTitles.includes(song.title));
        if (containingAlbum) {
          albumBoost = Math.floor((containingAlbum.promoBoost || 0) * 0.5);
        }
      }
      
      const freshness = Math.max(0, 100 - (song.age || 0) * 3);

      const trendBonus = newTrend && song.genre === newTrend.genre ? newTrend.modifier : 0;
      
      // Regional boost based on geographic reputation (small boost if you're touring/have reputation)
      const totalReputation = Object.values(s.geographicReputation || {}).reduce((sum, rep) => sum + rep, 0);
      const regionalBoost = Math.min(5, Math.floor(totalReputation / 20)); // Max 5 point boost
      
      let popularity = Math.max(0, Math.floor((decayed + freshness) / 2 + trendBonus + seasonalBoost + albumBoost + regionalBoost));

      // Label benefits: Playlist pitches and radio promo boost
      if (s.labelDeal) {
        if (s.labelDeal.playlistPitch && Math.random() < 0.15) {
          // Label gets song on playlist (boost)
          const playlistBoost = Math.floor(Math.random() * 15) + 5;
          popularity = Math.min(100, popularity + playlistBoost);
          if (playlistBoost > 10) {
            trendNotes.push(`Label got "${song.title}" on a major playlist! +${playlistBoost} popularity.`);
          }
        }
        if (s.labelDeal.radioPromo && Math.random() < 0.12) {
          // Radio promotion boost
          const radioBoost = Math.floor(Math.random() * 8) + 3;
          popularity = Math.min(100, popularity + radioBoost);
        }
      }

      // Rare viral spike
      if (Math.random() < 0.03) {
        popularity = Math.min(100, popularity + 25);
        trendNotes.push(`Viral spike: "${song.title}" jumps in buzz!`);
      }

      const freshnessWeight = Math.max(0, 1 - ((song.age || 0) * 0.05));
      const streamBase = popularity * 60;
      const streamFresh = Math.floor(freshness * 6 * freshnessWeight);
      
      // Album boost: Songs in albums get streaming boost
      let streamBonus = song.videoBoost ? 400 : 0;
      if (song.inAlbum) {
        streamBonus += Math.floor(streamBase * 0.15); // 15% boost for being in an album
      }
      
      const weeklyStreams = Math.max(0, Math.floor(streamBase + streamFresh + streamBonus));
      const streamRevenue = Math.floor(weeklyStreams * 0.004); // ~$0.004 per stream

      const radioPlays = Math.floor(popularity / 12);
      const royalty = radioPlays * 2;
      
      return {
        ...song,
        popularity,
        age: (song.age || 0) + 1,
        earnings: (song.earnings || 0) + royalty + streamRevenue,
        plays: (song.plays || 0) + radioPlays,
        streams: (song.streams || 0) + weeklyStreams,
        weeklyStreams
      };
    });
    
    // Calculate total royalties from songs (radio + streams)
    const songRoyalties = songs.reduce((total, song) => {
      const weeklyStreams = song.weeklyStreams || 0;
      const streamRevenue = Math.floor(weeklyStreams * 0.004);
      const radioPlays = Math.floor((song.popularity || 0) / 12);
      const radioRevenue = radioPlays * 2;
      return total + streamRevenue + radioRevenue;
    }, 0);
    
    // Total gross revenue (before label split)
    const grossRevenue = albumStreamingRevenue + songRoyalties;
    
    // Apply label royalty split if under contract
    let labelRoyaltySplit = 0;
    let netRevenue = grossRevenue;
    if (s.labelDeal && s.labelDeal.type !== 'independent') {
      labelRoyaltySplit = Math.floor(grossRevenue * (s.labelDeal.royaltySplit || 0) / 100);
      netRevenue = grossRevenue - labelRoyaltySplit;
    }
    
    totalRoyalty = netRevenue;

    const fameGrowth = Math.floor(s.fame / 10);
    const songBonus = songs.length > 0 ? 5 : 0;
    const fanGrowth = fameGrowth + songBonus;
    
    // Social media organic growth (passive follower growth)
    const socialGrowth = {
      tiktok: Math.floor((s.socialMedia?.tiktok?.followers || 0) * 0.01), // 1% weekly growth
      instagram: Math.floor((s.socialMedia?.instagram?.followers || 0) * 0.008), // 0.8% weekly growth
      twitter: Math.floor((s.socialMedia?.twitter?.followers || 0) * 0.005) // 0.5% weekly growth
    };
    
    // Algorithm favor decay if not posting regularly
    const lastPostWeek = Math.max(
      s.socialMedia?.tiktok?.lastPost || 0,
      s.socialMedia?.instagram?.lastPost || 0,
      s.socialMedia?.twitter?.lastPost || 0
    );
    const weeksSincePost = s.week - lastPostWeek;
    const algorithmDecay = weeksSincePost > 2 ? Math.min(2, (weeksSincePost - 2) * 0.5) : 0;
    const newAlgorithmFavor = Math.max(0, (s.algorithmFavor || 0) - algorithmDecay);
    
    // Update social media with organic growth
    const updatedSocialMedia = {
      tiktok: {
        ...(s.socialMedia?.tiktok || { followers: 0, engagementRate: 0, lastPost: 0 }),
        followers: (s.socialMedia?.tiktok?.followers || 0) + socialGrowth.tiktok
      },
      instagram: {
        ...(s.socialMedia?.instagram || { followers: 0, engagementRate: 0, lastPost: 0 }),
        followers: (s.socialMedia?.instagram?.followers || 0) + socialGrowth.instagram
      },
      twitter: {
        ...(s.socialMedia?.twitter || { followers: 0, engagementRate: 0, lastPost: 0 }),
        followers: (s.socialMedia?.twitter?.followers || 0) + socialGrowth.twitter
      }
    };
    
    // Calculate monthly listeners from total followers and algorithm favor
    const totalFollowers = (updatedSocialMedia.tiktok.followers || 0) + 
                          (updatedSocialMedia.instagram.followers || 0) + 
                          (updatedSocialMedia.twitter.followers || 0);
    const newMonthlyListeners = Math.floor(totalFollowers * 0.3 + (newAlgorithmFavor * 50)); // Rough conversion

    // Handle active tour progression
    let updatedActiveTour = s.activeTour;
    let tourRevenue = 0;
    let tourReputationGain = {};
    let tourCompleteNote = '';
    
    if (s.activeTour) {
      const tour = { ...s.activeTour };
      tour.currentWeek = (tour.currentWeek || 0) + 1;
      
      // Calculate weekly tour revenue (per city)
      const regionRep = s.geographicReputation?.[tour.region] || 0;
      const baseRevenue = Math.floor((s.fame * 20) + (regionRep * 30));
      const weeklyRevenue = Math.floor(baseRevenue * (tour.cities / tour.duration));
      tour.revenue = (tour.revenue || 0) + weeklyRevenue;
      tourRevenue = weeklyRevenue;
      
      // Reputation gain from touring
      if (!tourReputationGain[tour.region]) {
        tourReputationGain[tour.region] = 0;
      }
      tourReputationGain[tour.region] += Math.floor(tour.cities / tour.duration);
      
      // Check if tour is complete
      if (tour.currentWeek >= tour.duration) {
        tourCompleteNote = ` | Completed ${tour.name}! Total revenue: $${tour.revenue}`;
        const finalRepGain = Math.floor(tour.cities * 2);
        tourReputationGain[tour.region] = finalRepGain;
        
        // Save to tour history
        const completedTour = { ...tour, completedWeek: s.week };
        updatedActiveTour = null;
        trendNotes.push(`Tour complete: ${tour.name} in ${GEOGRAPHIC_REGIONS.find(r => r.id === tour.region)?.name || tour.region}. +${finalRepGain} reputation, $${tour.revenue} total.`);
        
        // Update tour history (will be set in return statement)
        if (!s.tourHistory) s.tourHistory = [];
        s.tourHistory.push(completedTour);
      } else {
        updatedActiveTour = tour;
      }
    }

    // Update geographic reputation
    const updatedGeographicReputation = { ...(s.geographicReputation || { us: 0, uk: 0, europe: 0, asia: 0 }) };
    Object.keys(tourReputationGain).forEach(region => {
      updatedGeographicReputation[region] = (updatedGeographicReputation[region] || 0) + tourReputationGain[region];
    });

    // Merchandise sales (unlocks at 50 fame)
    const merchandiseRevenue = s.fame >= 50 ? Math.floor(((s.fame * 0.25) + (s.fans * 0.15)) * revenueMultiplier) : 0;
    const merchandiseNote = merchandiseRevenue > 0 ? `, merch $${merchandiseRevenue}` : '';

    // Handle label contract expiration
    let updatedLabelDeal = s.labelDeal;
    let labelExpiryNote = '';
    if (s.labelDeal && s.labelDeal.weeksRemaining !== undefined) {
      const newWeeksRemaining = Math.max(0, (s.labelDeal.weeksRemaining || 0) - 1);
      if (newWeeksRemaining === 0 && s.labelDeal.weeksRemaining > 0) {
        // Contract expired
        labelExpiryNote = ` | Contract with ${s.labelDeal.name} expired. You're independent again.`;
        updatedLabelDeal = null;
        trendNotes.push(`Contract expired: ${s.labelDeal.name}. You're independent again.`);
      } else if (newWeeksRemaining > 0) {
        updatedLabelDeal = { ...s.labelDeal, weeksRemaining: newWeeksRemaining };
      } else {
        updatedLabelDeal = null;
      }
    }
    
    const labelNote = labelRoyaltySplit > 0 ? ` (label took $${labelRoyaltySplit})` : '';
    const summary = [`Week ${s.week}: expenses $${weeklyExpenses}, royalties $${totalRoyalty}${labelNote}${merchandiseNote}${tourCompleteNote}, fans +${fanGrowth}${labelExpiryNote}`, ...trendNotes].join(' | ');

    // Check goals and achievements
    let updatedGoals = s.goals || [];
    let newAchievements = [];
    const totalStreams = (s.songs || []).reduce((sum, song) => sum + (song.streams || 0), 0) + 
                         (s.albums || []).reduce((sum, album) => {
                           const albumStreams = Math.floor((album.quality || 0) * 150 + (album.popularity || 0) * 80) * Math.max(0.3, 1 - (album.age || 0) * 0.02);
                           return sum + albumStreams;
                         }, 0);
    const totalHits = (s.songs || []).filter(song => (song.popularity || 0) > 60).length;
    
    // Calculate chart position (simplified - check if player band exists and fame ranking)
    const playerFame = s.bandName ? s.fame : 0;
    const chartPosition = playerFame > 0 ? Math.max(1, Math.floor(20 - (playerFame / 20))) : 21;
    
    // Check for #1 album (simplified check)
    const hasNumberOneAlbum = s.albums && s.albums.some(album => (album.popularity || 0) >= 90);
    
    updatedGoals = updatedGoals.map(goal => {
      if (goal.completed) return goal;
      
      let progress = goal.progress || 0;
      let completed = false;
      
      switch (goal.type) {
        case 'totalStreams':
          progress = totalStreams;
          completed = totalStreams >= goal.target;
          break;
        case 'stayIndependent':
          completed = !s.labelDeal || s.labelDeal.type === 'independent';
          break;
        case 'signMajorLabel':
          completed = s.labelDeal && s.labelDeal.type === 'major';
          break;
        case 'numberOneAlbum':
          completed = hasNumberOneAlbum;
          break;
        case 'tourRegions':
          const touredRegions = new Set();
          (s.tourHistory || []).forEach(tour => {
            if (tour.region) touredRegions.add(tour.region);
          });
          progress = touredRegions.size;
          completed = touredRegions.size >= goal.target;
          break;
        case 'goViral':
          completed = (s.viralMoments || []).some(m => m.platform === 'TikTok');
          break;
        case 'withinWeeks':
          completed = (s.week - (s.scenarioStartWeek || 1)) <= goal.target;
          break;
        case 'surviveWeeks':
          progress = s.week;
          completed = s.week >= goal.target;
          break;
        case 'maintainFame':
          completed = s.fame >= goal.target;
          break;
        case 'totalHits':
          progress = totalHits;
          completed = totalHits >= goal.target;
          break;
      }
      
      if (completed && !goal.completed) {
        newAchievements.push({ id: goal.id, name: goal.label, week: s.week });
        trendNotes.push(`âœ“ Goal achieved: ${goal.label}!`);
      }
      
      return { ...goal, progress, completed };
    });

    // Check for general achievements
    const existingAchievements = (s.achievements || []).map(a => a.id);
    
    if (!existingAchievements.includes('firstMillion') && totalStreams >= 1000000) {
      newAchievements.push({ id: 'firstMillion', name: 'First Million Streams', week: s.week });
      trendNotes.push('ðŸŽ‰ Achievement: First Million Streams!');
    }
    
    if (!existingAchievements.includes('top10') && chartPosition > 0 && chartPosition <= 10) {
      newAchievements.push({ id: 'top10', name: 'Top 10 Chart Position', week: s.week });
      trendNotes.push('ðŸŽ‰ Achievement: Top 10!');
    }
    
    if (!existingAchievements.includes('numberOne') && chartPosition === 1) {
      newAchievements.push({ id: 'numberOne', name: '#1 on Charts', week: s.week });
      trendNotes.push('ðŸ† Achievement: #1 on Charts!');
    }
    
    if (!existingAchievements.includes('majorLabel') && s.labelDeal && s.labelDeal.type === 'major') {
      newAchievements.push({ id: 'majorLabel', name: 'Major Label Deal', week: s.week });
      trendNotes.push('ðŸŽ‰ Achievement: Major Label Deal!');
    }
    
    if (!existingAchievements.includes('viral') && (s.viralMoments || []).length > 0) {
      newAchievements.push({ id: 'viral', name: 'Viral Moment', week: s.week });
      trendNotes.push('ðŸŽ‰ Achievement: Viral Moment!');
    }

    // Check if all scenario goals are complete
    const scenarioComplete = updatedGoals.length > 0 && updatedGoals.every(g => g.completed);
    if (scenarioComplete && !s.scenarioComplete) {
      trendNotes.push(`ðŸ† SCENARIO COMPLETE! You achieved all goals for ${SCENARIOS.find(sc => sc.id === s.scenario)?.name || 'your scenario'}!`);
    }

    // Update career stats
    const updatedCareerStats = {
      ...(s.careerStats || {}),
      totalWeeks: (s.careerStats?.totalWeeks || 0) + 1,
      totalRevenue: (s.totalRevenue || 0) + totalRoyalty + merchandiseRevenue + tourRevenue,
      totalStreams: ((s.songs || []).reduce((sum, song) => sum + (song.streams || 0), 0) + 
                     (s.albums || []).reduce((sum, album) => sum + (album.streams || 0), 0)),
      albumsReleased: (s.albums || []).length,
      songsReleased: (s.songs || []).length,
      toursCompleted: (s.tourHistory || []).length,
      awardsWon: (s.achievements || []).length,
      peakFame: Math.max(s.fame, s.careerStats?.peakFame || 0),
      peakFans: Math.max(s.fans, s.careerStats?.peakFans || 0),
      peakChartPosition: Math.min(chartPosition, s.careerStats?.peakChartPosition || 21)
    };

    // Legacy tier and hall of fame (based on career achievements)
    let newLegacyTier = s.legacyTier || 'none';
    let hallOfFame = s.hallOfFame || false;
    
    if (!hallOfFame && updatedCareerStats.peakFame >= 500 && updatedCareerStats.totalRevenue >= 5000000) {
      hallOfFame = true;
      newLegacyTier = 'legend';
      trendNotes.push('ðŸ† HALL OF FAME! You are a music legend!');
    } else if (updatedCareerStats.peakFame >= 300 && updatedCareerStats.totalRevenue >= 2000000) {
      newLegacyTier = 'icon';
    } else if (updatedCareerStats.peakFame >= 150 && updatedCareerStats.totalRevenue >= 500000) {
      newLegacyTier = 'star';
    }

    // Band status (active by default unless set otherwise)
    const bandStatus = s.bandStatus || 'active';

    // Ensure songs and albums arrays are preserved
    const finalSongs = Array.isArray(songs) && songs.length > 0 ? songs : (s.songs || []);
    const finalAlbums = Array.isArray(albums) && albums.length > 0 ? albums : (s.albums || []);
    console.log('[processWeekEffects] Returning songs, final count:', finalSongs.length, 'Titles:', finalSongs.map(s => s.title));
    console.log('[processWeekEffects] Returning albums, final count:', finalAlbums.length, 'Names:', finalAlbums.map(a => a.name));

    return {
      next: {
        ...s,
        albums: finalAlbums,
        songs: finalSongs,
        labelDeal: updatedLabelDeal,
        socialMedia: updatedSocialMedia,
        algorithmFavor: newAlgorithmFavor,
        monthlyListeners: newMonthlyListeners,
        activeTour: updatedActiveTour,
        geographicReputation: updatedGeographicReputation,
        tourHistory: updatedActiveTour === null && s.activeTour ? [...(s.tourHistory || []), { ...s.activeTour, completedWeek: s.week }] : (s.tourHistory || []),
        goals: updatedGoals,
        achievements: [...(s.achievements || []), ...newAchievements],
        scenarioComplete: scenarioComplete || s.scenarioComplete,
        genreTrends: updatedGenreTrends,
        careerStats: updatedCareerStats,
        legacyTier: newLegacyTier,
        hallOfFame: hallOfFame,
        bandStatus: bandStatus,
        weeklyExpenses: weeklyExpenses + staffCosts,
        money: s.money - (weeklyExpenses + staffCosts) + totalRoyalty + merchandiseRevenue + tourRevenue,
        fans: s.fans + fanGrowth,
        totalRevenue: (s.totalRevenue || 0) + totalRoyalty + merchandiseRevenue + tourRevenue,
        totalMerchandise: (s.totalMerchandise || 0) + merchandiseRevenue,
        trend: newTrend && newTrend.weeks > 0 ? newTrend : null,
        trainingCooldown: Math.max(0, (s.trainingCooldown || 0) - 1),
        promoteCooldown: Math.max(0, (s.promoteCooldown || 0) - 1),
        tourBan: Math.max(0, (s.tourBan || 0) - 1)
      },
      summary
    };
  };

  const maybeTriggerEvent = (chance) => {
    if (!data?.dramaEvents || !data.dramaEvents.length) return;
    const roll = Math.random();
    if (roll < chance) {
      const pick = data.dramaEvents[Math.floor(Math.random() * data.dramaEvents.length)];
      setCurrentEvent(pick);
      addLog(`Drama: ${pick.title}`);
      
      // Show popup for drama events with choices
      setEventPopupData({
        title: pick.title,
        message: pick.description,
        type: 'warning',
        choices: pick.choices || [],
        isEvent: true
      });
      setShowEventPopup(true);
    }
  };

  const driftRivalsWeekly = (currentWeek) => {
    setRivals((prev) => prev.map((r) => {
      const smallDrift = (Math.random() * 12) - 6; // -6 to +6
      const surge = Math.random() < 0.12 ? Math.random() * 25 : 0;
      const slump = Math.random() < 0.1 ? -(Math.random() * 18) : 0;
      const nextFame = Math.max(20, Math.floor(r.fame + smallDrift + surge + slump));
      
      // Update songs (popularity decay/growth, new releases)
      const updatedSongs = (r.songs || []).map(song => {
        const decay = Math.random() < 0.3 ? -2 : Math.random() < 0.6 ? 0 : 1;
        const newPop = Math.max(0, Math.min(100, (song.popularity || 0) + decay));
        const newAge = (song.age || 0) + 1;
        const streamBase = newPop * 50;
        const weeklyStreams = Math.floor(streamBase + Math.random() * 2000);
        return {
          ...song,
          popularity: newPop,
          age: newAge,
          weeklyStreams
        };
      });
      
      // Occasionally add new songs (famous bands release more)
      if (Math.random() < (0.05 + (nextFame / 2000))) {
        const basePop = Math.floor(nextFame * 0.5) + Math.floor(Math.random() * 30);
        const titles = data?.songTitles || ['New Song'];
        const randomTitle = titles[Math.floor(Math.random() * titles.length)];
        updatedSongs.push({
          title: randomTitle,
          popularity: Math.min(100, basePop),
          quality: Math.floor(60 + (nextFame / 5) + Math.random() * 20),
          weeklyStreams: Math.floor(basePop * 50 + Math.random() * 2000),
          age: 0,
          inAlbum: false
        });
      }
      
      // Update albums (age, promo decay)
      const updatedAlbums = (r.albums || []).map(album => {
        const newAge = (album.age || 0) + 1;
        const newPromo = Math.max(0, (album.promoBoost || 0) - 0.5);
        const decay = Math.max(0, 14 - newAge);
        const newScore = Math.floor((album.quality || 0) * 0.8 + decay + newPromo);
        return {
          ...album,
          age: newAge,
          promoBoost: newPromo,
          chartScore: newScore
        };
      });
      
      // Occasionally release new albums (famous bands release more)
      if (Math.random() < (0.02 + (nextFame / 5000)) && updatedSongs.length >= 8) {
        const albumQuality = Math.floor(60 + (nextFame / 4) + Math.random() * 25);
        const albumPop = Math.floor(nextFame * 0.6 + Math.random() * 30);
        updatedAlbums.push({
          name: `${r.name} ${updatedAlbums.length === 0 ? '' : `Vol. ${updatedAlbums.length + 1}`}`,
          quality: Math.min(100, albumQuality),
          popularity: Math.min(100, albumPop),
          chartScore: Math.floor(albumQuality * 0.8 + albumPop * 0.3),
          age: 0,
          songs: 8 + Math.floor(Math.random() * 5),
          promoBoost: 12,
          week: currentWeek || 1
        });
      }
      
      const totalStreams = updatedSongs.reduce((sum, s) => sum + (s.weeklyStreams || 0), 0) + 
                          updatedAlbums.reduce((sum, a) => sum + Math.floor((a.quality || 0) * 15 * Math.max(0.3, 1 - (a.age || 0) * 0.02)), 0);
      
      return { 
        ...r, 
        fame: nextFame,
        songs: updatedSongs,
        albums: updatedAlbums,
        totalStreams
      };
    }));
  };

  const dramaChance = useMemo(() => {
    const sizeFactor = Math.min(0.05, Math.max(0, (state.members.length - 2) * 0.02));
    const moraleFactor = state.morale < 40 ? 0.18 : state.morale < 60 ? 0.1 : 0.0;
    const weekFactor = Math.min(0.1, Math.max(0, (state.week - 1) * 0.004));
    const base = 0.18;
    const chance = base + sizeFactor + moraleFactor + weekFactor;
    return Math.min(0.65, Math.max(0.05, chance));
  }, [state.members.length, state.morale, state.week]);

  const riskMeter = useMemo(() => {
    const avgDrama = state.members.length
      ? state.members.reduce((sum, m) => sum + (m.stats?.drama ?? 5), 0) / state.members.length
      : 5;
    const fameHeat = Math.min(0.1, Math.max(0, (state.fame - 80) / 800));
    const moraleDrag = state.morale < 50 ? (50 - state.morale) / 500 : 0;
    const banPressure = state.tourBan > 0 ? 0.04 : 0;
    const base = 0.06 + fameHeat + moraleDrag + banPressure + Math.max(0, (avgDrama - 5) * 0.02);
    const clamped = Math.min(0.28, Math.max(0.02, base));
    return { value: clamped, label: `${Math.round(clamped * 100)}%`, avgDrama: Math.round(avgDrama * 10) / 10 };
  }, [state.members, state.fame, state.morale, state.tourBan]);

  const advanceWeek = (updater, entry, context = 'neutral') => {
    try {
    let weeklySummary = null;
      let newWeek = 0;
    setState((s) => {
        try {
          const withWeek = { ...s, week: (s.week || 0) + 1 };
          newWeek = withWeek.week;
      const updated = updater(withWeek);
          // Ensure members is always an array
          if (!updated.members || !Array.isArray(updated.members)) {
            updated.members = s.members || [];
          }
          updated.members = adjustMemberStats(updated.members, updated.morale || 50, context);
      const { next, summary } = processWeekEffects(updated);
      weeklySummary = summary;
      return next;
        } catch (error) {
          console.error('Error in advanceWeek setState:', error);
          // Return current state on error to prevent crash
          return s;
        }
    });
    if (entry) addLog(entry);
    if (weeklySummary) {
      addLog(weeklySummary);
      
      // Show weekly summary popup
      const parsedSummary = parseWeeklySummary(weeklySummary, newWeek);
      setWeeklyPopupData(parsedSummary);
      setShowWeeklyPopup(true);
    }
      driftRivalsWeekly(newWeek);
    maybeTriggerEvent(dramaChance);
      maybeSyncLicensing();
      maybeBrandPartnership();
      maybePlaylistPlacement();
      maybeIndustryAward();
      maybeChartBattle();
      maybeModernEvent();
    maybeMemberQuit();
    maybeTroubleEvent();
      maybeReunionTour();
      maybeSoloCareer();
    } catch (error) {
      console.error('Error in advanceWeek:', error);
      addLog(`Error advancing week: ${error.message || 'Unknown error'}`);
    }
  };

  const startGame = () => {
    // If no scenario selected, default to sandbox
    if (!state.scenario) {
      const sandbox = SCENARIOS.find(s => s.id === 'sandbox');
      setState((s) => ({
        ...s,
        scenario: 'sandbox',
        goals: [],
        achievements: []
      }));
    }
    setStep(STEPS.CREATE);
  };
  const toggleRole = (role) => {
    setDesiredRoles((prev) => {
      if (prev.includes(role)) {
        if (prev.length <= 2) return prev; // keep minimum of 2
        return prev.filter((r) => r !== role);
      }
      if (prev.length >= 6) return prev; // cap at 6
      return [...prev, role];
    });
  };

  const addLineupRole = (role) => {
    setDesiredRoles((prev) => {
      if (prev.length >= 6) return prev;
      return [...prev, role];
    });
  };

  const applyLineupPreset = (roles) => {
    setDesiredRoles(roles.slice(0, 6));
  };

  const createBand = () => {
    if (desiredRoles.length < 2) {
      alert('Pick at least 2 band members.');
      return;
    }
    const personalities = data?.memberPersonalities || ['creative', 'technical', 'charismatic', 'rebel'];
    const built = desiredRoles.map((role) => buildMember(role, personalities));
    setState(s => ({
      ...s,
      bandName: s.bandName || 'Your Band',
      members: built,
      log: ['Band formed and ready to rock.']
    }));
    setEditingMemberId(null);
    setStep(STEPS.LOGO);
  };

  const finishLogo = () => setStep(STEPS.GAME);

  const setFont = (font) => {
    ensureFontLoaded(font);
    setState((s) => ({ ...s, logoFont: font }));
  };
  const addFontOption = (fontName) => {
    if (!fontName) return;
    const normalized = fontName.trim();
    if (!normalized) return;
    ensureFontLoaded(normalized);
    setFontOptions((opts) => (opts.includes(normalized) ? opts : [...opts, normalized]));
    setFont(normalized);
  };
  const loadCustomFont = () => {
    addFontOption(customFont);
    setCustomFont('');
  };

  useEffect(() => {
    // Preload initial Google fonts (skip Arial)
    fontOptions.filter((f) => f.toLowerCase() !== 'arial').forEach(ensureFontLoaded);
  }, [fontOptions]);

  useEffect(() => {
    // Ensure current logo font is loaded when on logo screen
    if (step === STEPS.LOGO && state.logoFont) {
      ensureFontLoaded(state.logoFont);
    }
  }, [step, state.logoFont]);

  const writeSong = (customTitle = null) => {
    const studio = STUDIO_TIERS[state.studioTier];
    const difficulty = state.difficulty || 'normal';
    const costMultiplier = difficulty === 'easy' ? 0.8 : difficulty === 'hard' ? 1.2 : 1;
    const cost = Math.floor(studio.recordCost * costMultiplier);
    
    if (state.money < cost) {
      addLog(`Not enough money to record (need $${cost})`, true, {
        title: 'Insufficient Funds',
        message: `You need $${cost} to record a song at ${studio.name}.`,
        type: 'warning'
      });
      return;
    }

    const titles = data?.songTitles || ['New Song'];
    const unusedTitles = titles.filter((t) => !state.songs.find((s) => s.title === t));
    const defaultTitle = unusedTitles.length
      ? unusedTitles[Math.floor(Math.random() * unusedTitles.length)]
      : titles[Math.floor(Math.random() * titles.length)] + ' (Remix)';
    
    const title = customTitle && customTitle.trim() ? customTitle.trim() : defaultTitle;
    
    // Check if title already exists
    if (state.songs && state.songs.find((s) => s.title === title)) {
      addLog(`A song with the title "${title}" already exists. Please choose a different title.`, true, {
        title: 'Duplicate Title',
        message: `A song with the title "${title}" already exists. Please choose a different title.`,
        type: 'warning'
      });
      return;
    }
    
    const baseQuality = Math.floor(58 + Math.random() * 26);
    const quality = Math.min(100, baseQuality + studio.qualityBonus);
    const popularity = Math.floor(quality * 0.6) + studio.popBonus;
    
    const newSong = { 
          title, 
          quality, 
          popularity, 
          earnings: 0, 
          plays: 0, 
          age: 0,
          streams: 0,
          weeklyStreams: 0,
          freshness: 80 + studio.freshnessBonus * 10,
      videoBoost: false,
      inAlbum: false // Track if song is part of an album
    };

    // Advance week and add the song - the song will be processed by processWeekEffects
    console.log('[writeSong] Adding song:', title, 'Current songs count:', state.songs?.length || 0);
    
    advanceWeek(
      (s) => {
        // Ensure we have a valid songs array and add the new song
        const currentSongs = Array.isArray(s.songs) ? s.songs : [];
        const updatedSongs = [...currentSongs, newSong];
        
        console.log('[writeSong updater] Current songs:', currentSongs.length, 'After adding:', updatedSongs.length, 'Song titles:', updatedSongs.map(s => s.title));
        
        return {
          ...s,
          money: s.money - cost,
          songs: updatedSongs, // This will be processed by processWeekEffects
        morale: clampMorale(s.morale + 4)
        };
      },
      `Laid down "${title}" at ${studio.name}. The track has solid quality (${quality}%) and should get decent radio play. -$${cost}`,
      'write'
    );
    
    // Close modal and reset
    setShowWriteSongModal(false);
    setNewSongTitle('');
  };

  const recordAlbum = (selectedSongTitles) => {
    if (selectedSongTitles.length < 8) {
      alert('Need at least 8 songs to release an album (maximum 12).');
      return;
    }
    if (selectedSongTitles.length > 12) {
      alert('Albums can have at most 12 songs.');
      return;
    }

    const studio = STUDIO_TIERS[state.studioTier];
    const selectedSongs = state.songs.filter(s => selectedSongTitles.includes(s.title));
    
    // Check if any songs are already in an album
    const alreadyInAlbum = selectedSongs.some(s => s.inAlbum);
    if (alreadyInAlbum) {
      alert('One or more selected songs are already part of another album.');
      return;
    }

    // Calculate album quality (average of song qualities + studio bonus)
    const avgQuality = selectedSongs.reduce((sum, s) => sum + (s.quality || 0), 0) / selectedSongs.length;
    const albumQuality = Math.min(100, Math.floor(avgQuality + studio.qualityBonus * 1.5));
    
    // Album popularity starts higher than individual songs
    const avgPopularity = selectedSongs.reduce((sum, s) => sum + (s.popularity || 0), 0) / selectedSongs.length;
    const albumPopularity = Math.min(100, Math.floor(avgPopularity * 1.2 + studio.popBonus * 2));
    
    // Album release cost: higher than single recording
    const baseCost = studio.recordCost * selectedSongs.length * 0.8; // Slight discount vs individual
    const albumReleaseCost = Math.floor(baseCost * 1.5); // Extra cost for mastering, artwork, etc.
    
    if (state.money < albumReleaseCost) {
      alert(`Need $${albumReleaseCost} to release an album (includes mastering, artwork, distribution).`);
      return;
    }

    // Generate album name - mix of band name, song titles, and made-up titles
    const albumType = Math.random();
    let albumName;
    
    if (albumType < 0.33) {
      // 33% chance: Use band name (self-titled albums)
      const selfTitledVariants = [
        `${state.bandName}`,
        `${state.bandName} - Self-Titled`,
        `${state.bandName} (Self-Titled)`,
        `The ${state.bandName} Album`,
        `${state.bandName} Vol. ${(state.albums?.length || 0) + 1}`
      ];
      albumName = randomFrom(selfTitledVariants);
    } else if (albumType < 0.66) {
      // 33% chance: Use a song title from the album
      const titleSong = randomFrom(selectedSongs);
      const songTitleVariants = [
        titleSong.title,
        `${titleSong.title} (and Other Songs)`,
        `Songs from ${titleSong.title}`,
        `The ${titleSong.title} Album`
      ];
      albumName = randomFrom(songTitleVariants);
    } else {
      // 34% chance: Made-up creative titles
      const madeUpTitles = [
        `The ${state.genre} Sessions`,
        `Live at ${randomFrom(['Studio', 'The Basement', 'Electric Dreams', 'Analog Heaven', 'Midnight', 'The Garage'])}`,
        `The ${randomFrom(['Great', 'Long', 'Strange', 'Wild', 'Dark', 'Bright', 'Lost', 'Found'])} ${randomFrom(['Road', 'Trip', 'Night', 'Day', 'Journey', 'Dream', 'Awakening'])}`,
        `${randomFrom(['Midnight', 'Dawn', 'Twilight', 'Eclipse', 'Solstice'])} ${randomFrom(['Sessions', 'Tales', 'Stories', 'Chronicles', 'Legends'])}`,
        `${randomFrom(['Electric', 'Acoustic', 'Digital', 'Analog', 'Neon'])} ${randomFrom(['Dreams', 'Reality', 'Fantasy', 'Escape', 'Return'])}`,
        `The ${randomFrom(['First', 'Second', 'Third', 'Final', 'Next'])} ${randomFrom(['Chapter', 'Act', 'Movement', 'Phase', 'Era'])}`,
        `${randomFrom(['Between', 'Beyond', 'Within', 'Without'])} ${randomFrom(['Lines', 'Time', 'Space', 'Reality'])}`,
        `The ${randomFrom(['Sound', 'Voice', 'Echo', 'Silence'])} of ${randomFrom(['Tomorrow', 'Yesterday', 'Now', 'Forever'])}`,
        `${randomFrom(['Colors', 'Shades', 'Hues', 'Tones'])} of ${randomFrom(['Sound', 'Music', 'Life', 'Time'])}`,
        `In ${randomFrom(['Search', 'Pursuit', 'Memory', 'Honor'])} of ${randomFrom(['Truth', 'Beauty', 'Freedom', 'Love'])}`
      ];
      albumName = randomFrom(madeUpTitles);
    }

    advanceWeek(
      (s) => {
        // Mark songs as being in an album
        const updatedSongs = s.songs.map(song => 
          selectedSongTitles.includes(song.title)
            ? { ...song, inAlbum: true }
            : song
        );

        // Create album entry
        const newAlbum = {
          name: albumName,
          week: s.week,
          quality: albumQuality,
          popularity: albumPopularity,
          chartScore: albumPopularity,
          age: 0,
          promoBoost: 12, // Initial promo boost from release
          songs: selectedSongTitles.length,
          songTitles: selectedSongTitles
        };

        // Update label contract obligations if under contract
        let updatedLabelDeal = s.labelDeal;
        if (s.labelDeal && s.labelDeal.obligations) {
          updatedLabelDeal = {
            ...s.labelDeal,
            obligations: {
              ...s.labelDeal.obligations,
              albumsDelivered: (s.labelDeal.obligations.albumsDelivered || 0) + 1
            }
          };
        }

        return {
          ...s,
          money: s.money - albumReleaseCost,
          songs: updatedSongs,
          albums: [...(s.albums || []), newAlbum],
          labelDeal: updatedLabelDeal,
          morale: clampMorale(s.morale + 8), // Big morale boost
          fame: s.fame + Math.floor(albumPopularity * 0.15) // Fame boost from album release
        };
      },
      `Released "${albumName}"! ${selectedSongTitles.length} tracks, quality ${albumQuality}%. Album release generates buzz and boosts all included songs. -$${albumReleaseCost}`,
      'album'
    );

    setShowAlbumBuilderModal(false);
    setSelectedSongsForAlbum([]);
  };

  const upgradeStudio = (tierId) => {
    const studio = STUDIO_TIERS[tierId];
    if (state.studioTier >= tierId) {
      setState((s) => ({ ...s, log: [...s.log, `Already own ${studio.name} or better`] }));
      return;
    }
    if (state.money < studio.cost) {
      setState((s) => ({ ...s, log: [...s.log, `Need $${studio.cost} to upgrade to ${studio.name}`] }));
      return;
    }
    setState((s) => ({
      ...s,
      money: s.money - studio.cost,
      studioTier: tierId,
      log: [...s.log, `Upgraded to ${studio.name}! Now recording at ${studio.recordCost}/song`]
    }));
    setShowStudioModal(false);
  };

  const upgradeTransport = (tierId) => {
    const transport = TRANSPORT_TIERS[tierId];
    if (state.transportTier >= tierId) {
      setState((s) => ({ ...s, log: [...s.log, `Already own ${transport.name} or better`] }));
      return;
    }
    if (state.money < transport.cost) {
      setState((s) => ({ ...s, log: [...s.log, `Need $${transport.cost} to upgrade to ${transport.name}`] }));
      return;
    }
    setState((s) => ({
      ...s,
      money: s.money - transport.cost,
      transportTier: tierId,
      log: [...s.log, `Upgraded to ${transport.name}! Gig earnings +${Math.round((transport.gigBonus - 1) * 100)}%`]
    }));
    setShowTransportModal(false);
  };

  const upgradeGear = (tierId) => {
    const gear = GEAR_TIERS[tierId];
    if (state.gearTier >= tierId) {
      setState((s) => ({ ...s, log: [...s.log, `Already own ${gear.name} or better`] }));
      return;
    }
    if (state.money < gear.cost) {
      setState((s) => ({ ...s, log: [...s.log, `Need $${gear.cost} to upgrade to ${gear.name}`] }));
      return;
    }
    setState((s) => ({
      ...s,
      money: s.money - gear.cost,
      gearTier: tierId,
      log: [...s.log, `Upgraded to ${gear.name}! Quality +${gear.qualityBonus}%, Sound +${gear.soundBonus}%, Gig earnings +${Math.round((gear.gigBonus - 1) * 100)}%`]
    }));
    setShowGearModal(false);
  };

  const rehearse = () => {
    const moraleGain = 6;
    const fameGain = Math.floor(Math.random() * 3); // softer fame trickle
    advanceWeek(
      (s) => ({
        ...s,
        morale: clampMorale(s.morale + moraleGain),
        fame: s.fame + fameGain
      }),
      `Rehearsed hard. Morale +${moraleGain}${fameGain ? `, Fame +${fameGain}` : ''}`,
      'rehearse'
    );
  };

  const rest = () => {
    advanceWeek(
      (s) => ({
        ...s,
        morale: clampMorale(s.morale + 10)
      }),
      'Took a breather. Morale +10',
      'rest'
    );
  };

  const startTour = (tourType, region) => {
    if (state.activeTour) {
      addLog('Already on a tour! Finish current tour first.');
      return;
    }
    
    if (state.money < tourType.cost) {
      addLog(`Need $${tourType.cost} to start ${tourType.name}.`);
      return;
    }

    const tour = {
      type: tourType.id,
      name: tourType.name,
      region: region,
      cities: tourType.cities,
      startWeek: state.week,
      duration: tourType.duration,
      currentWeek: 0,
      revenue: 0,
      reputationGain: 0
    };

    setState((s) => ({
      ...s,
      money: s.money - tourType.cost,
      activeTour: tour
    }));

    addLog(`Started ${tourType.name} in ${GEOGRAPHIC_REGIONS.find(r => r.id === region)?.name || region}! Touring for ${tourType.duration} weeks. -$${tourType.cost}`);
  };

  const bookGig = (venue) => {
    if (!venue) {
      addLog('Error: Invalid venue selected.');
      return;
    }
    
    // Safety checks for transport and gear tiers
    const transportTier = state.transportTier ?? 0;
    const gearTier = state.gearTier ?? 0;
    const transport = TRANSPORT_TIERS[transportTier] || TRANSPORT_TIERS[0];
    const gear = GEAR_TIERS[gearTier] || GEAR_TIERS[0];
    
    if (!transport || !gear) {
      addLog('Error: Invalid equipment configuration.');
      return;
    }
    
    // Safety checks for venue properties
    const venueBasePay = venue.basePay || 0;
    const venueCapacity = venue.capacity || 0;
    
    const basePay = venueBasePay + Math.floor((state.fame || 0) * 1.5);
    const transportMultiplier = transport.gigBonus || 1.0;
    const gearMultiplier = gear.gigBonus || 1.0;
    const pay = Math.floor(basePay * transportMultiplier * gearMultiplier);
    const fameGain = Math.max(2, Math.floor(venueCapacity / 80) + 3);
    const fanGain = Math.floor(venueCapacity / 28);
    
    // Calculate performance quality based on equipment, morale, and band state
    const equipmentQuality = ((state.gearTier || 0) * 0.25) + ((state.transportTier || 0) * 0.1);
    const moraleBonus = Math.max(-1, ((state.morale || 50) - 50) / 50); // -1 to +1
    const bandQuality = Math.min(1, Math.max(0, equipmentQuality + moraleBonus * 0.2 + Math.random() * 0.2));
    
    // Select description based on performance quality
    let description;
    try {
      const venueName = venue?.name || 'the venue';
    if (bandQuality > 0.65) {
        const descFunc = randomFrom(GIG_SUCCESS_DESCRIPTIONS);
        description = descFunc(venue, venueCapacity, pay, fameGain);
    } else if (bandQuality > 0.35) {
        const descFunc = randomFrom(GIG_OKAY_DESCRIPTIONS);
        description = descFunc(venue, venueCapacity, pay, fameGain);
    } else {
        const descFunc = randomFrom(GIG_POOR_DESCRIPTIONS);
        description = descFunc(venue, venueCapacity, pay, fameGain);
      }
      // Fallback if description is undefined or empty
      if (!description || description.trim() === '') {
        description = `Played a gig at ${venueName}. Earned $${pay} and gained ${fameGain} fame.`;
      }
    } catch (error) {
      console.error('Error generating gig description:', error);
      const venueName = venue?.name || 'the venue';
      description = `Played a gig at ${venueName}. Earned $${pay} and gained ${fameGain} fame.`;
    }
    
    try {
    advanceWeek(
      (s) => ({
        ...s,
          money: (s.money || 0) + pay,
          fame: (s.fame || 0) + fameGain,
          morale: clampMorale((s.morale || 50) + 4),
          fans: (s.fans || 0) + fanGain
      }),
      description,
      'gig'
    );
      
      // Show popup with gig results
      addLog(description, true, {
        title: `Gig at ${venue?.name || 'Venue'}`,
        message: description,
        details: {
          earnings: `$${pay.toLocaleString()}`,
          fameGain: `+${fameGain}`,
          fanGain: `+${fanGain}`,
          moraleGain: '+4'
        },
        type: bandQuality > 0.65 ? 'success' : bandQuality > 0.35 ? 'info' : 'warning'
      });
    } catch (error) {
      console.error('Error in bookGig advanceWeek:', error);
      addLog(`Error playing gig: ${error.message || 'Unknown error'}`, true, {
        title: 'Error',
        message: `Error playing gig: ${error.message || 'Unknown error'}`,
        type: 'error'
      });
    }
  };

  const generateLabelOffer = (fame) => {
    // Determine what label tier to offer based on fame
    let availableTiers = DISTRIBUTION_TIERS.filter(tier => fame >= tier.fameReq);
    if (availableTiers.length === 0) availableTiers = [DISTRIBUTION_TIERS[0]]; // At least offer independent
    
    // Higher fame = better offers
    let tierIndex = 0;
    if (fame >= 300) tierIndex = 3; // Major
    else if (fame >= 150) tierIndex = 2; // 360
    else if (fame >= 50) tierIndex = 1; // Distribution
    else tierIndex = 0; // Independent
    
    const baseTier = DISTRIBUTION_TIERS[tierIndex];
    
    // Label makes initial offer (may be worse than base tier)
    const negotiationRange = Math.random();
    let offerTier = baseTier;
    
    if (negotiationRange < 0.3 && tierIndex > 0) {
      // Label offers tier below (tries to lowball)
      offerTier = DISTRIBUTION_TIERS[tierIndex - 1];
    }
    
    // Vary the terms within the tier
    const advanceVariance = 0.8 + (Math.random() * 0.4); // 80% to 120% of base
    const royaltyVariance = (Math.random() * 10) - 5; // Â±5% from base
    
    const labelNames = ['Crimson Records', 'Neon Label', 'Electric Sound', 'Underground Music Co', 'Digital Distribution', 'Indie Collective'];
    const labelName = labelNames[Math.floor(Math.random() * labelNames.length)];
    
    return {
      type: offerTier.id,
      name: labelName,
      advance: Math.floor(offerTier.advance * advanceVariance),
      royaltySplit: Math.max(0, Math.min(70, offerTier.royaltySplit + royaltyVariance)), // Max 70% (you get minimum 30%)
      marketingBudget: Math.floor(offerTier.marketingBudget * (0.9 + Math.random() * 0.2)),
      contractLength: offerTier.contractLength,
      ...offerTier
    };
  };

  const resolveEvent = (choice) => {
    // Handle Record Label Interest specially - trigger negotiation
    if (currentEvent?.title === 'Record Label Interest!') {
      if (choice.text.includes('Negotiate') || choice.text.includes('Sign')) {
        const offer = generateLabelOffer(state.fame);
        setLabelOffer(offer);
        setShowLabelNegotiation(true);
        setNegotiationStep('offer');
        setCurrentEvent(null);
        return;
      } else if (choice.text.includes('Stay independent')) {
        addLog('Stayed independent. Keeping full control but no label backing.');
        setCurrentEvent(null);
        return;
      }
    }
    
    const applySpecial = (special) => {
      if (!special) return { money: 0, morale: 0, fame: 0, note: null };
      switch (special) {
        case 'royalties':
          return { money: 300, morale: 5, fame: 5, note: 'Bonus royalties hit your account.' };
        case 'tour':
          return { money: 0, morale: -5, fame: 18, note: 'Tour hype boosts fame over time.' };
        case 'drugUse':
          return { money: 0, morale: -8, fame: 5, note: 'Hangover hurts morale.' };
        case 'drugRefuse':
          return { money: 0, morale: 5, fame: -2, note: 'Clean reputation steadies morale.' };
        case 'drugBuy':
          return { money: -200, morale: 0, fame: 0, note: 'Costly vice, no real upside.' };
        case 'hospitalCare':
          return { money: -200, morale: -6, fame: 0, note: 'Paid hospital bill. Member recovers.' };
        case 'hospitalSkip':
          return { money: 0, morale: -12, fame: -6, note: 'Skipping care hurt your reputation.' };
        case 'rehabPay':
          return { money: -400, morale: -4, fame: 0, note: 'Member in rehab; drama eased.' };
        case 'rehabSkip':
          return { money: 0, morale: -8, fame: -4, note: 'Ignored rehab; drama worsens.' };
        case 'bustedFine':
          return { money: -350, morale: -4, fame: 4, note: 'Paid fine, press coverage boosts notoriety.' };
        case 'bustedFight':
          return { money: -500, morale: -6, fame: 6, note: 'Legal fight; short ban applied.' };
        case 'syncLicensing':
          return { money: 0, morale: 5, fame: 0, note: 'Song placed in media. Great exposure!' };
        case 'brandPartnership':
          return { money: 0, morale: 10, fame: 0, note: 'Brand partnership boosts visibility and credibility.' };
        case 'playlistPlacement':
          return { money: 0, morale: 10, fame: 0, note: 'Playlist placement will boost streams significantly!' };
        case 'awardNomination':
          return { money: 0, morale: 10, fame: 0, note: 'Award nomination boosts credibility and exposure.' };
        case 'awardWin':
          return { money: 0, morale: 15, fame: 0, note: 'Winning an award is huge for your career!' };
        case 'chartBattle':
          return { money: 0, morale: 5, fame: 5, note: 'Chart battle pushes you to #1!' };
        case 'reunionTour':
          setState((s) => ({
            ...s,
            bandStatus: 'active', // Temporarily reactivate
            reunionTours: [...(s.reunionTours || []), { week: s.week, duration: choice.reunionDuration }]
          }));
          return { money: 0, morale: 15, fame: 0, note: 'Reunion tour brings the band back together!' };
        case 'soloCareerLeave':
          setState((s) => ({
            ...s,
            members: s.members.filter(m => m.id !== choice.memberId)
          }));
          return { money: 0, morale: 10, fame: -5, note: 'Member left for solo career. Band continues.' };
        case 'soloCareerStay':
          return { money: -500, morale: -5, fame: 0, note: 'Member stays but morale dips slightly.' };
        case 'soloCareerDual':
          return { money: -1000, morale: 5, fame: 5, note: 'Supporting member\'s solo career while staying in band!' };
        case 'tiktokViral':
          setState((s) => ({
            ...s,
            viralMoments: [...(s.viralMoments || []), { type: 'tiktok', week: s.week, impact: 'major' }],
            algorithmFavor: Math.min(100, (s.algorithmFavor || 0) + 10)
          }));
          return { money: 0, morale: 0, fame: 0, note: 'TikTok viral moment boosts algorithm favor!' };
        case 'streamingMilestone':
          setState((s) => ({
            ...s,
            monthlyListeners: (s.monthlyListeners || 0) + Math.floor(Math.random() * 50000) + 25000
          }));
          return { money: 0, morale: 0, fame: 0, note: 'Streaming milestone increases monthly listeners!' };
        case 'nftOffer':
          return { money: 0, morale: 0, fame: 0, note: 'NFT collection launched. Controversial but profitable.' };
        case 'algorithmBoost':
          setState((s) => ({
            ...s,
            algorithmFavor: Math.min(100, (s.algorithmFavor || 0) + 15),
            monthlyListeners: (s.monthlyListeners || 0) + Math.floor(Math.random() * 100000) + 50000
          }));
          return { money: 0, morale: 0, fame: 0, note: 'Algorithm boost significantly increases listeners and favor!' };
        case 'fanFunded':
          return { money: 0, morale: 0, fame: 0, note: 'Fan-funded project shows strong fan support!' };
        case 'spotifyPlaylist':
          setState((s) => ({
            ...s,
            playlistPlacements: [...(s.playlistPlacements || []), { 
              playlistName: 'Spotify Editorial', 
              type: 'editorial', 
              week: s.week, 
              boost: 25 
            }],
            algorithmFavor: Math.min(100, (s.algorithmFavor || 0) + 8)
          }));
          return { money: 0, morale: 0, fame: 0, note: 'Spotify editorial playlist placement boosts streams!' };
        default:
          return { money: 0, morale: 0, fame: 0, note: null };
      }
    };

    const special = applySpecial(choice.special);
    const memberId = currentEvent?.memberId;

    const adjustMembers = (members) => {
      if (!memberId) return members;
      return members.map((m) => {
        if (m.id !== memberId) return m;
        const stats = { ...m.stats };
        switch (choice.special) {
          case 'hospitalCare':
            stats.drama = clampStat((stats.drama ?? 5) - 0.3);
            stats.reliability = clampStat((stats.reliability ?? 5.5) + 0.1);
            break;
          case 'hospitalSkip':
            stats.reliability = clampStat((stats.reliability ?? 5.5) - 0.4);
            stats.drama = clampStat((stats.drama ?? 5) + 0.2);
            break;
          case 'rehabPay':
            stats.drama = clampStat((stats.drama ?? 5) - 0.8);
            stats.reliability = clampStat((stats.reliability ?? 5.5) + 0.2);
            break;
          case 'rehabSkip':
            stats.drama = clampStat((stats.drama ?? 5) + 0.6);
            stats.reliability = clampStat((stats.reliability ?? 5.5) - 0.2);
            break;
          default:
            break;
        }
        return { ...m, stats };
      });
    };

    setState((s) => ({
      ...s,
      money: s.money + (choice.fineOverride ? -choice.fineOverride : 0) + (choice.money || 0) + (special.money || 0),
      morale: clampMorale(s.morale + (choice.morale || 0) + (special.morale || 0)),
      fame: s.fame + (choice.fame || 0) + (special.fame || 0),
      fans: s.fans + (choice.fans || 0),
      tourBan: choice.specialBan ? Math.max(s.tourBan || 0, choice.specialBan) : s.tourBan,
      members: adjustMembers(s.members)
    }));

    const logNote = special.note ? ` (${special.note})` : '';
    addLog(`${currentEvent.title}: ${choice.text}${logNote}`);
    setCurrentEvent(null);
  };

  const signLabelDeal = (offer, isCounterOffer = false) => {
    const deal = {
      type: offer.type,
      name: offer.name,
      advance: offer.advance,
      royaltySplit: offer.royaltySplit,
      marketingBudget: offer.marketingBudget,
      contractLength: offer.contractLength,
      weeksRemaining: offer.contractLength,
      obligations: {
        albumsDelivered: 0,
        albumsRequired: Math.floor(offer.contractLength / 26), // Roughly 1 album per 6 months
        toursRequired: Math.floor(offer.contractLength / 52) // At least 1 tour per year
      },
      playlistPitch: offer.playlistPitch,
      syncLicensing: offer.syncLicensing,
      radioPromo: offer.radioPromo
    };

    setState((s) => ({
      ...s,
      labelDeal: deal,
      money: s.money + offer.advance,
      morale: clampMorale(s.morale + 10),
      fame: s.fame + Math.floor(offer.advance / 50) // Fame boost from signing
    }));

    addLog(`Signed with ${offer.name}! ${offer.type === 'independent' ? 'DIY distribution' : `${offer.type} deal`}. Advance: $${offer.advance}. Contract: ${offer.contractLength} weeks.`);
    setShowLabelNegotiation(false);
    setLabelOffer(null);
    setNegotiationStep('offer');
  };

  const counterOffer = () => {
    if (!labelOffer) return;
    
    // Improve terms slightly (label might accept)
    const improvedOffer = {
      ...labelOffer,
      advance: Math.floor(labelOffer.advance * 1.1), // +10% advance
      royaltySplit: Math.max(0, labelOffer.royaltySplit - 3), // -3% royalty (you keep more)
      marketingBudget: Math.floor(labelOffer.marketingBudget * 1.05) // +5% marketing
    };
    
    // 60% chance label accepts counter, 40% they walk away or make final offer
    if (Math.random() < 0.6) {
      setLabelOffer(improvedOffer);
      setNegotiationStep('accept');
      addLog(`Label accepted your counter-offer! Better terms secured.`);
    } else {
      // Label makes final "take it or leave it" offer
      const finalOffer = {
        ...labelOffer,
        advance: Math.floor(labelOffer.advance * 1.05), // Slight improvement
        royaltySplit: Math.max(0, labelOffer.royaltySplit - 1.5) // Small improvement
      };
      setLabelOffer(finalOffer);
      setNegotiationStep('final');
      addLog(`Label made a final offer. Take it or leave it.`);
    }
  };

  const maybeMemberQuit = () => {
    if (!state.members.length) return;
    const lowMoraleBand = state.morale < 30;
    const candidates = state.members.filter((m) => {
      const personalMorale = m.stats?.morale ?? 5;
      const dramaProne = m.stats?.drama ?? 5;
      const base = lowMoraleBand ? 0.03 : 0.01;
      const moralePenalty = personalMorale < 4 ? (4 - personalMorale) * 0.01 : 0;
      const dramaPenalty = dramaProne > 7 ? (dramaProne - 7) * 0.008 : 0;
      const quitChance = base + moralePenalty + dramaPenalty;
      return Math.random() < quitChance;
    });
    if (candidates.length === 0) return;
    const quitter = candidates[Math.floor(Math.random() * candidates.length)];
    setState((s) => ({ ...s, members: s.members.filter((m) => m.id !== quitter.id) }));
    const personalities = data?.memberPersonalities || ['creative', 'technical', 'charismatic', 'rebel'];
    const options = [
      buildCandidate(randomFrom(ROLE_OPTIONS).key, personalities),
      buildCandidate(randomFrom(ROLE_OPTIONS).key, personalities)
    ];
    setRecruitOptions(options);
    
    // Show popup for member quit
    setEventPopupData({
      title: 'ðŸš¨ Band Member Quit!',
      message: `${memberDisplayName(quitter)} quit the band due to tension and low morale. You'll need to find a replacement to fill their role.`,
      type: 'warning',
      choices: [
        {
          text: 'View Replacement Candidates',
          money: 0,
          morale: 0,
          fame: 0,
          onClick: () => {
            // The recruit options are already set, just close popup
            setShowEventPopup(false);
          }
        },
        {
          text: 'Continue Without Replacement (for now)',
          money: 0,
          morale: 0,
          fame: 0,
          onClick: () => {
            setShowEventPopup(false);
          }
        }
      ]
    });
    setShowEventPopup(true);
    addLog(`${memberDisplayName(quitter)} quit the band due to tension. Two candidates are available to audition.`);
  };

  const maybeSyncLicensing = () => {
    // Sync licensing opportunities (TV/film/games) - more likely with labels
    if (state.songs.length === 0) return;
    
    const baseChance = state.labelDeal?.syncLicensing ? 0.08 : 0.02; // Much higher with label
    const fameBoost = state.fame > 200 ? 0.03 : state.fame > 100 ? 0.02 : 0;
    const chance = baseChance + fameBoost;
    
    if (Math.random() >= chance) return;
    
    const syncTypes = [
      { type: 'TV Show', basePay: 5000, fame: 15 },
      { type: 'Film', basePay: 8000, fame: 25 },
      { type: 'Video Game', basePay: 3000, fame: 10 },
      { type: 'Commercial', basePay: 12000, fame: 20 }
    ];
    
    const sync = syncTypes[Math.floor(Math.random() * syncTypes.length)];
    const topSongs = [...state.songs].sort((a,b) => (b.popularity || 0) - (a.popularity || 0));
    const selectedSong = topSongs[0];
    
    if (!selectedSong) return;
    
    // Label takes cut if you have a label deal
    const labelCut = state.labelDeal && state.labelDeal.type !== 'independent' 
      ? Math.floor(sync.basePay * (state.labelDeal.royaltySplit || 0) / 100)
      : 0;
    const netPay = sync.basePay - labelCut;
    
    const eventData = {
      title: `Sync Licensing Opportunity: ${sync.type}`,
      titleIcon: Music,
      description: `A ${sync.type.toLowerCase()} wants to license "${selectedSong.title}" for their production. They're offering $${sync.basePay.toLocaleString()} for the rights.${labelCut > 0 ? ` Your label takes $${labelCut.toLocaleString()} (${state.labelDeal.royaltySplit}%), leaving you $${netPay.toLocaleString()}.` : ''}`,
      choices: [
        { 
          text: `Accept ($${netPay.toLocaleString()}${labelCut > 0 ? ' net' : ''})`, 
          money: netPay, 
          morale: 5, 
          fame: sync.fame,
          special: 'syncLicensing'
        },
        { 
          text: 'Decline - too low', 
          money: 0, 
          morale: 0, 
          fame: 0 
        }
      ]
    };
    setCurrentEvent(eventData);
    // Show popup
    setEventPopupData({
      title: eventData.title,
      message: eventData.description,
      type: 'success',
      choices: eventData.choices,
      isEvent: true
    });
    setShowEventPopup(true);
  };

  const maybeBrandPartnership = () => {
    // Brand partnership opportunities - unlocks with higher fame
    if (state.fame < 100) return; // Need some fame for brands to notice
    
    const baseChance = state.labelDeal ? 0.06 : 0.02;
    const fameBoost = Math.min(0.08, (state.fame - 100) / 2000);
    const chance = baseChance + fameBoost;
    
    if (Math.random() >= chance) return;
    
    const brands = [
      { name: 'Energy Drink', basePay: 15000, fame: 30, fans: 200 },
      { name: 'Fashion Brand', basePay: 20000, fame: 25, fans: 300 },
      { name: 'Tech Company', basePay: 25000, fame: 35, fans: 400 },
      { name: 'Streaming Service', basePay: 18000, fame: 40, fans: 500 }
    ];
    
    const brand = brands[Math.floor(Math.random() * brands.length)];
    
    // Label takes cut if 360 deal or major label
    const labelCut = (state.labelDeal?.type === '360' || state.labelDeal?.type === 'major')
      ? Math.floor(brand.basePay * (state.labelDeal.royaltySplit || 0) / 100)
      : 0;
    const netPay = brand.basePay - labelCut;
    
    const eventData = {
      title: `Brand Partnership: ${brand.name}`,
      titleIcon: Briefcase,
      description: `${brand.name} wants to partner with your band for a campaign. They're offering $${brand.basePay.toLocaleString()} for sponsored content, product placement, and social media promotion.${labelCut > 0 ? ` Your label takes $${labelCut.toLocaleString()} (${state.labelDeal.royaltySplit}%), leaving you $${netPay.toLocaleString()}.` : ''}`,
      choices: [
        { 
          text: `Accept Partnership ($${netPay.toLocaleString()}${labelCut > 0 ? ' net' : ''}, +${brand.fans} fans)`, 
          money: netPay, 
          morale: 10, 
          fame: brand.fame,
          fans: brand.fans,
          special: 'brandPartnership'
        },
        { 
          text: 'Decline - stay authentic', 
          money: 0, 
          morale: 5, 
          fame: 0 
        }
      ]
    };
    setCurrentEvent(eventData);
    // Show popup
    setEventPopupData({
      title: eventData.title,
      message: eventData.description,
      type: 'success',
      choices: eventData.choices,
      isEvent: true
    });
    setShowEventPopup(true);
  };

  const maybeIndustryAward = () => {
    // Industry award events (Grammys, etc.) - requires fame and quality releases
    if (state.fame < 100) return; // Need some fame for nominations
    if (state.songs.length === 0 && state.albums.length === 0) return;
    
    const baseChance = state.fame > 200 ? 0.08 : state.fame > 150 ? 0.05 : 0.03;
    if (Math.random() >= baseChance) return;
    
    const awards = [
      { name: 'Grammy Awards', type: 'nomination', fame: 30, money: 0, nominationChance: 0.4 },
      { name: 'Brit Awards', type: 'nomination', fame: 25, money: 0, nominationChance: 0.45 },
      { name: 'MTV Music Awards', type: 'nomination', fame: 20, money: 500, nominationChance: 0.5 },
      { name: 'Billboard Music Awards', type: 'nomination', fame: 22, money: 0, nominationChance: 0.45 }
    ];
    
    const award = awards[Math.floor(Math.random() * awards.length)];
    const isNomination = Math.random() < award.nominationChance;
    
    if (isNomination) {
      // Nomination - chance to win
      const won = Math.random() < 0.3; // 30% chance to win after nomination
      
      if (won) {
        const eventData = {
          title: `ðŸ† ${award.name} - WINNER!`,
          titleIcon: Trophy,
          description: `Congratulations! You won at the ${award.name}! This is huge for your career - massive exposure and credibility.`,
          choices: [
            { 
              text: `Amazing! (+${award.fame * 2} fame, +$${award.money + 5000})`, 
              money: award.money + 5000, 
              morale: 15, 
              fame: award.fame * 2,
              special: 'awardWin'
            }
          ]
        };
        setCurrentEvent(eventData);
        // Show popup
        setEventPopupData({
          title: eventData.title,
          message: eventData.description,
          type: 'success',
          choices: eventData.choices,
          isEvent: true
        });
        setShowEventPopup(true);
      } else {
        const eventData = {
          title: `${award.name} - Nominated!`,
          titleIcon: Trophy,
          description: `You've been nominated for ${award.name}! Great recognition for your work. The ceremony is next week - fingers crossed!`,
          choices: [
            { 
              text: `Honored! (+${award.fame} fame)`, 
              money: award.money, 
              morale: 10, 
              fame: award.fame,
              special: 'awardNomination'
            }
          ]
        };
        setCurrentEvent(eventData);
        // Show popup
        setEventPopupData({
          title: eventData.title,
          message: eventData.description,
          type: 'success',
          choices: eventData.choices,
          isEvent: true
        });
        setShowEventPopup(true);
      }
      
      // Track in industry events
      setState((s) => ({
        ...s,
        industryEvents: [...(s.industryEvents || []), {
          name: award.name,
          type: won ? 'win' : 'nomination',
          week: s.week
        }]
      }));
    }
  };

  const maybeChartBattle = () => {
    // Chart battle mechanics - when close to #1 position
    if (!state.bandName || state.fame < 50) return;
    
    // Calculate player position (simplified - based on fame ranking)
    const playerFame = state.fame;
    const playerPosition = playerFame > 0 ? Math.max(1, Math.floor(20 - (playerFame / 15))) : 21;
    
    if (playerPosition < 2 || playerPosition > 5) return; // Only trigger if in top 5
    
    // 8% chance when in contention zone
    if (Math.random() >= 0.08) return;
    
    // Find a nearby rival
    const nearbyRivals = rivals.filter(r => Math.abs(r.fame - playerFame) < playerFame * 0.3);
    if (nearbyRivals.length === 0) return;
    
    const rival = randomFrom(nearbyRivals);
    const battleType = playerPosition === 1 ? 'defend' : 'climb';
    
    const eventData = {
      title: `ðŸ“Š Chart Battle: ${rival.name}`,
      titleIcon: TrendingUp,
      description: `${battleType === 'defend' ? 'You\'re at #1, but' : 'You\'re close to #1 and'} ${rival.name} is challenging your position! Both bands are releasing new material and competing for chart dominance.`,
      choices: [
        { 
          text: 'Push Harder (+5 fame, -$300 promo cost)', 
          money: -300, 
          morale: 5, 
          fame: 5,
          special: 'chartBattle'
        },
        { 
          text: 'Play It Cool (maintain position)', 
          money: 0, 
          morale: 3, 
          fame: 2
        }
      ]
    };
    setCurrentEvent(eventData);
    // Show popup
    setEventPopupData({
      title: eventData.title,
      message: eventData.description,
      type: 'info',
      choices: eventData.choices,
      isEvent: true
    });
    setShowEventPopup(true);
    
    setState((s) => ({
      ...s,
      chartBattles: [...(s.chartBattles || []), {
        rival: rival.name,
        week: s.week,
        type: battleType
      }]
    }));
  };

  const maybePlaylistPlacement = () => {
    // Playlist placement opportunities - higher chance with label and algorithm favor
    if (state.songs.length === 0) return;
    
    const baseChance = state.labelDeal?.playlistPitch ? 0.12 : 0.04;
    const algorithmBoost = (state.algorithmFavor || 0) / 1000; // Up to 10% boost
    const fameBoost = state.fame > 200 ? 0.03 : state.fame > 100 ? 0.02 : 0;
    const chance = baseChance + algorithmBoost + fameBoost;
    
    if (Math.random() >= chance) return;
    
    const playlistTypes = [
      { name: 'Discover Weekly', type: 'algorithmic', boost: 15 },
      { name: 'Release Radar', type: 'algorithmic', boost: 20 },
      { name: 'Today\'s Top Hits', type: 'editorial', boost: 30 },
      { name: 'Rock Classics', type: 'editorial', boost: 25 },
      { name: 'New Music Friday', type: 'editorial', boost: 35 },
      { name: 'Indie Mix', type: 'user-generated', boost: 10 },
      { name: 'Viral Hits', type: 'algorithmic', boost: 25 }
    ];
    
    const playlist = playlistTypes[Math.floor(Math.random() * playlistTypes.length)];
    const topSongs = [...state.songs].sort((a,b) => (b.popularity || 0) - (a.popularity || 0));
    const selectedSong = topSongs[0];
    
    if (!selectedSong) return;
    
    const eventData = {
      title: `Playlist Placement: ${playlist.name}`,
      titleIcon: ListMusic,
      description: `Your song "${selectedSong.title}" was added to ${playlist.name} (${playlist.type} playlist)! This will boost your streams by ${playlist.boost}% for the next few weeks.`,
      choices: [
        { 
          text: 'Amazing!', 
          money: 0, 
          morale: 10, 
          fame: Math.floor(playlist.boost / 2),
          special: 'playlistPlacement'
        }
      ]
    };
    setCurrentEvent(eventData);
    // Show popup
    setEventPopupData({
      title: eventData.title,
      message: eventData.description,
      type: 'success',
      choices: eventData.choices,
      isEvent: true
    });
    setShowEventPopup(true);
    
    // Add to playlist placements
    setState((s) => ({
      ...s,
      playlistPlacements: [...(s.playlistPlacements || []), {
        playlistName: playlist.name,
        type: playlist.type,
        week: s.week,
        boost: playlist.boost
      }],
      algorithmFavor: Math.min(100, (s.algorithmFavor || 0) + 3)
    }));
  };

  const maybeModernEvent = () => {
    // Modern events (TikTok, streaming, social media, etc.)
    if (!data?.modernEvents || !data.modernEvents.length) return;
    if (state.songs.length === 0) return; // Need music for modern events
    
    const baseChance = 0.05; // 5% base chance
    const fameBoost = state.fame > 100 ? 0.03 : state.fame > 50 ? 0.02 : 0.01;
    const socialBoost = (state.socialMedia?.tiktok || 0) > 10000 ? 0.02 : 0;
    const chance = baseChance + fameBoost + socialBoost;
    
    if (Math.random() >= chance) return;
    
    const event = randomFrom(data.modernEvents);
    const eventData = {
      title: event.title,
      description: event.description,
      choices: event.choices.map(choice => ({
        ...choice,
        onClick: () => resolveEvent(choice)
      }))
    };
    setCurrentEvent(eventData);
    // Show popup
    setEventPopupData({
      title: eventData.title,
      message: eventData.description,
      type: 'info',
      choices: eventData.choices,
      isEvent: true
    });
    setShowEventPopup(true);
  };

  const maybeTroubleEvent = () => {
    if (!state.members.length) return;
    const avgDrama = state.members.reduce((sum, m) => sum + (m.stats?.drama ?? 5), 0) / state.members.length;
    const lowMorale = state.morale < 40;
    const fameHeat = state.fame > 140 ? 0.05 : 0;
    const base = 0.06 + fameHeat + (lowMorale ? 0.05 : 0) + Math.max(0, (avgDrama - 5) * 0.015);
    const chance = Math.min(0.22, base);
    if (Math.random() >= chance) return;

    const member = randomFrom(state.members);
    const crisisRoll = Math.random();
    if (crisisRoll < 0.5) {
      const eventData = {
        title: 'HOSPITAL RUN',
        titleIcon: Ambulance,
        description: `${memberDisplayName(member)} collapsed after a rough night of partying. The rest of the band found them passed out backstage. Get them proper medical attention ($200), or risk serious backlash and health problems.`,
        memberId: member.id,
        choices: [
          { text: 'Pay Hospital ($200)', money: -200, morale: 0, fame: 0, special: 'hospitalCare' },
          { text: 'Skip the Bill', money: 0, morale: 0, fame: 0, special: 'hospitalSkip' }
        ]
      };
      setCurrentEvent(eventData);
      // Show popup
      setEventPopupData({
        title: eventData.title,
        message: eventData.description,
        type: 'warning',
        choices: eventData.choices,
        isEvent: true
      });
      setShowEventPopup(true);
    } else if (crisisRoll < 0.8) {
      const eventData = {
        title: 'REHAB INTERVENTION',
        titleIcon: AlertTriangle,
        description: `${memberDisplayName(member)}'s substance abuse is spiraling out of control. They're missing rehearsals, showing up late to gigs, and the drama is affecting everyone. A close friend suggests professional rehab ($400). It'll cost time and money, but could save the band.`,
        memberId: member.id,
        choices: [
          { text: 'Send to Rehab ($400)', money: -400, morale: 0, fame: 0, special: 'rehabPay' },
          { text: 'Let Them Figure It Out', money: 0, morale: 0, fame: 0, special: 'rehabSkip' }
        ]
      };
      setCurrentEvent(eventData);
      // Show popup
      setEventPopupData({
        title: eventData.title,
        message: eventData.description,
        type: 'warning',
        choices: eventData.choices,
        isEvent: true
      });
      setShowEventPopup(true);
    } else {
      const managerFactor = state.staffManager === 'pro' ? 0.9 : state.staffManager === 'dodgy' ? 1.1 : 1;
      const lawyerFactor = state.staffLawyer ? 0.8 : 1;
      const fineFactor = managerFactor * lawyerFactor;
      const banReduce = state.staffLawyer ? 1 : 0;
      const finePay = Math.max(150, Math.round(350 * fineFactor));
      const fineFight = Math.max(200, Math.round(500 * fineFactor));
      const eventData = {
        title: 'BUSTED BY POLICE',
        titleIcon: AlertCircle,
        description: `Vice squad raided the tour van outside a nightclub. Found some controlled substances. The tabloids are already on it. The cops want money NOW. You can pay the fine and move on, or fight it in courtâ€”which will be messier but might reduce the ban.`,
        choices: [
          { text: `Pay Fine ($${finePay}) - Quick Resolution`, money: -finePay, morale: 0, fame: 0, special: 'bustedFine', specialBan: Math.max(0, 1 - banReduce), fineOverride: finePay },
          { text: `Fight in Court ($${fineFight}) - Risky But Defiant`, money: -fineFight, morale: 0, fame: 0, special: 'bustedFight', specialBan: Math.max(0, 2 - banReduce), fineOverride: fineFight }
        ]
      };
      setCurrentEvent(eventData);
      // Show popup
      setEventPopupData({
        title: eventData.title,
        message: eventData.description,
        type: 'error',
        choices: eventData.choices,
        isEvent: true
      });
      setShowEventPopup(true);
    }
  };

  const maybeReunionTour = () => {
    // Reunion tour opportunities after band break-up or retirement
    if (state.bandStatus !== 'broken_up' && state.bandStatus !== 'retired') return;
    if (state.fame < 100) return; // Need some legacy fame
    
    // Only trigger if band was broken up or retired for a while
    const weeksSinceBreakup = state.week - (state.careerStats?.breakupWeek || state.week);
    if (weeksSinceBreakup < 10) return; // Must be broken up for at least 10 weeks
    
    const baseChance = state.fame > 300 ? 0.12 : state.fame > 200 ? 0.08 : 0.05;
    if (Math.random() >= baseChance) return;
    
    const reunionTypes = [
      { name: 'One-Off Reunion Show', duration: 1, revenue: state.fame * 50 },
      { name: 'Reunion Tour', duration: 4, revenue: state.fame * 200 },
      { name: 'Full Reunion Tour', duration: 8, revenue: state.fame * 400 }
    ];
    
    const reunion = reunionTypes[Math.floor(Math.random() * reunionTypes.length)];
    
    const eventData = {
      title: 'ðŸŽ¤ Reunion Tour Offer',
      titleIcon: Mic,
      description: `After ${weeksSinceBreakup} weeks apart, there's demand for a ${reunion.name.toLowerCase()}! This could be a chance to reunite temporarily and capitalize on your legacy. Estimated revenue: $${reunion.revenue.toLocaleString()}.`,
      choices: [
        { 
          text: `Accept - Reunite! (+${reunion.duration} weeks, $${reunion.revenue.toLocaleString()})`, 
          money: reunion.revenue, 
          morale: 15, 
          fame: Math.floor(state.fame * 0.1),
          special: 'reunionTour',
          reunionDuration: reunion.duration
        },
        { 
          text: 'Decline - We\'re done', 
          money: 0, 
          morale: 0, 
          fame: 0
        }
      ]
    };
    setCurrentEvent(eventData);
    // Show popup
    setEventPopupData({
      title: eventData.title,
      message: eventData.description,
      type: 'success',
      choices: eventData.choices,
      isEvent: true
    });
    setShowEventPopup(true);
  };

  const maybeSoloCareer = () => {
    // Members leaving for solo careers - only if band is successful
    if (state.bandStatus !== 'active') return;
    if (state.members.length <= 2) return; // Can't leave if only 2 members
    if (state.fame < 150) return; // Need significant fame for solo offers
    
    const baseChance = state.fame > 300 ? 0.06 : state.fame > 200 ? 0.04 : 0.02;
    if (Math.random() >= baseChance) return;
    
    // Pick a member with high stage presence or creativity (solo artist traits)
    const soloCandidates = state.members
      .filter(m => (m.stats?.stagePresence || 0) > 7 || (m.stats?.creativity || 0) > 7)
      .sort((a, b) => ((b.stats?.stagePresence || 0) + (b.stats?.creativity || 0)) - ((a.stats?.stagePresence || 0) + (a.stats?.creativity || 0)));
    
    if (soloCandidates.length === 0) return;
    
    const member = soloCandidates[0];
    const soloFame = Math.floor(state.fame * 0.3); // Solo career starts with fraction of band fame
    
    const eventData = {
      title: `ðŸŽ¸ Solo Career Opportunity: ${member.firstName} ${member.lastName}`,
      titleIcon: User,
      description: `${member.firstName} ${member.lastName} has been offered a solo career opportunity. They're considering leaving the band to pursue it. They could start with ${soloFame} fame based on their band success. What do you do?`,
      memberId: member.id,
      choices: [
        { 
          text: 'Let them go - Good luck! (-1 member, +10 morale for rest)', 
          money: 0, 
          morale: 10, 
          fame: -5,
          special: 'soloCareerLeave',
          memberId: member.id
        },
        { 
          text: 'Convince them to stay (+$500 bonus, -5 morale)', 
          money: -500, 
          morale: -5, 
          fame: 0,
          special: 'soloCareerStay'
        },
        { 
          text: 'Support solo while staying in band (+$1000, +5 morale)', 
          money: -1000, 
          morale: 5, 
          fame: 5,
          special: 'soloCareerDual'
        }
      ]
    };
    setCurrentEvent(eventData);
    // Show popup
    setEventPopupData({
      title: eventData.title,
      message: eventData.description,
      type: 'warning',
      choices: eventData.choices,
      isEvent: true
    });
    setShowEventPopup(true);
  };

  const latestAlbum = useMemo(() => {
    if (!state.albums?.length) return null;
    return [...state.albums].sort((a, b) => (b.week || 0) - (a.week || 0))[0];
  }, [state.albums]);

  const adjustMemberStats = (members, bandMorale, context) => {
    if (!members || !Array.isArray(members)) {
      return [];
    }
    return members.map((m) => {
      const stats = { ...m.stats };
      const moraleNow = stats.morale ?? 5;
      const dramaNow = stats.drama ?? 5;

      // Band morale pulls member morale slightly toward it (normalize band 0-100 to 1-10 scale)
      const bandMoraleScaled = bandMorale / 10;
      const moralePull = (bandMoraleScaled - moraleNow) * 0.12;
      stats.morale = clampStat(moraleNow + moralePull + (context === 'rest' ? 0.4 : 0));

      // Reliability shifts with morale and drama
      const moraleInfluence = (stats.morale - 6) * 0.035;
      const dramaDrag = (dramaNow - 5) * 0.06;
      stats.reliability = clampStat((stats.reliability ?? 5.5) + moraleInfluence - dramaDrag);

      // Contextual boosts
      if (context === 'rehearse') {
        stats.stagePresence = clampStat((stats.stagePresence ?? 5) + 0.2);
        stats.skill = clampStat((stats.skill ?? 5) + 0.08);
      }
      if (context === 'gig') {
        stats.stagePresence = clampStat((stats.stagePresence ?? 5) + 0.3);
        stats.skill = clampStat((stats.skill ?? 5) + 0.12);
        stats.drama = clampStat((stats.drama ?? 5) + 0.1); // gigs can be stressful
      }
      if (context === 'write') {
        stats.creativity = clampStat((stats.creativity ?? 5) + 0.18);
        stats.drama = clampStat((stats.drama ?? 5) + 0.04);
      }
      if (context === 'rest') {
        stats.drama = clampStat((stats.drama ?? 5) - 0.35);
      }

      // Gentle weekly drift to keep it dynamic
      const decay = 0.12;
      stats.stagePresence = clampStat((stats.stagePresence ?? 5) - decay + (Math.random() * 0.26 - 0.1));
      stats.skill = clampStat((stats.skill ?? 5) - decay + (Math.random() * 0.22 - 0.08));
      stats.creativity = clampStat((stats.creativity ?? 5) - 0.08 + (Math.random() * 0.22 - 0.08));
      stats.drama = clampStat((stats.drama ?? 5) - 0.05 + (Math.random() * 0.18 - 0.08));
      stats.reliability = clampStat((stats.reliability ?? 5.5) - 0.07 + (Math.random() * 0.18 - 0.08));

      return { ...m, stats };
    });
  };

  const hireCandidate = (candidate) => {
    setState((s) => {
      if (s.members.length >= 6) return s;
      return { ...s, members: [...s.members, candidate] };
    });
    setRecruitOptions([]);
    addLog(`Hired ${memberDisplayName(candidate)} as ${candidate.role}.`);
  };

  const skipRecruit = () => {
    setRecruitOptions([]);
    addLog('Skipped recruiting new members this week.');
  };

  const updateMember = (id, updates) => {
    setState((s) => ({
      ...s,
      members: s.members.map((m) => {
        if (m.id !== id) return m;
        const next = { ...m, ...updates };
        next.name = `${next.firstName} ${next.lastName}`;
        // Update avatar seed when name changes
        if (updates.firstName || updates.lastName) {
          next.avatarSeed = `${next.firstName} ${next.lastName}`;
        }
        return next;
      })
    }));
  };

  const removeMember = (id) => {
    setState((s) => {
      if (s.members.length <= 2) return s;
      return { ...s, members: s.members.filter((m) => m.id !== id) };
    });
    if (editingMemberId === id) setEditingMemberId(null);
  };

  const addMember = () => {
    setState((s) => {
      if (s.members.length >= 6) return s;
      const personalities = data?.memberPersonalities || ['creative', 'technical', 'charismatic', 'rebel'];
      const nextRole = ROLE_OPTIONS.find((r) => !s.members.some((m) => m.role === r.key))?.key || 'vocals';
      return { ...s, members: [...s.members, buildMember(nextRole, personalities)] };
    });
  };

  if (loading) return (
    <div className="screen" style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '100vh' }}>
      <div className="spinner"></div>
      <p style={{ marginTop: '20px', color: '#94a3b8' }}>Loading game data...</p>
    </div>
  );
  if (error) return <div className="screen"><p>Error loading data: {error.message}</p></div>;

  return (
    <div className="app">
      <header className="header">
        <div className="header-content">
          <div className="header-left">
            <h1 style={{ ...logoStyle, background: '#000000' }}>{state.bandName || 'GIGMASTER'}</h1>
            <p className="subtitle">GIGMASTER â†’ Band â†’ Logo â†’ Game</p>
          </div>
          {step === STEPS.GAME && (
            <div className="header-actions">
              {!state.tutorialCompleted && (
                <button className="btn-secondary mobile-btn" onClick={() => setShowTutorial(true)} title="Tutorial">
                  <span className="mobile-hide-text">Tutorial</span>
                  <span className="mobile-show-text">?</span>
                </button>
              )}
              <button className="btn-secondary mobile-btn" onClick={() => setShowSaveModal(true)} title="Save game (Ctrl+S)">
                Save
              </button>
              <button className="btn-secondary mobile-btn" onClick={() => setShowLoadModal(true)} title="Load game (Ctrl+L)">
                Load
              </button>
              <button className="btn-secondary mobile-btn" onClick={() => setShowSettings(true)} title="Settings">
                <span className="mobile-hide-text">Settings</span>
                <span className="mobile-show-text">âš™</span>
              </button>
            </div>
          )}
        </div>
      </header>

      {step === STEPS.LANDING && (
        <div className="landing-page">
          <div className="landing-sky">
            {Array.from({ length: 50 }).map((_, i) => (
              <div
                key={`star-${i}`}
                className="star"
                style={{
                  left: `${10 + (i * 7.3) % 80}%`,
                  top: `${5 + (i * 3.7) % 25}%`,
                  animationDelay: `${(i * 0.1) % 2}s`,
                  animationDuration: `${2 + (i % 3)}s`
                }}
              />
            ))}
            {Array.from({ length: 8 }).map((_, i) => (
              <div
                key={`streak-${i}`}
                className="light-streak"
                style={{
                  left: `${10 + i * 12}%`,
                  top: `${5 + (i % 3) * 8}%`,
                  transform: `rotate(${-35 + i * 8}deg)`,
                  opacity: 0.3 + (i % 3) * 0.1
                }}
              />
            ))}
          </div>
          
          <div className="landing-grid">
            {Array.from({ length: 20 }).map((_, i) => (
              <div key={`h-${i}`} className="grid-line grid-line-horizontal" style={{ top: `${30 + i * 3.5}%` }} />
            ))}
            {Array.from({ length: 15 }).map((_, i) => {
              const baseAngle = -25;
              const angle = baseAngle + (i * 4);
              return (
                <div
                  key={`d-${i}`}
                  className={`grid-line grid-line-diagonal ${i % 2 === 0 ? 'grid-blue' : 'grid-pink'}`}
                  style={{ 
                    transform: `rotate(${angle}deg)`,
                    transformOrigin: '50% 100%',
                    bottom: '20%',
                    left: `${40 + (i - 7) * 2}%`
                  }}
                />
              );
            })}
          </div>
          
          <div className="landing-horizon" />
          
          <div className="landing-content">
            <h1 className="gigmaster-logo">GIGMASTER</h1>
            <div className="landing-options">
              <div className="landing-buttons">
                <button 
                  className="landing-btn landing-btn-primary"
                  onClick={() => setStep(STEPS.SCENARIO)}
                >
                  Start Game
                </button>
                <button 
                  className="landing-btn landing-btn-secondary"
                  onClick={() => setShowLoadModal(true)}
                >
                  Load Game
                </button>
              </div>
              <div className="landing-difficulty">
                <select 
                  value={state.difficulty || 'normal'} 
                  onChange={(e) => setState((s) => ({ ...s, difficulty: e.target.value }))}
                  className="landing-select"
                >
                  <option value="easy">Easy</option>
                  <option value="normal">Normal</option>
                  <option value="hard">Hard</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      )}


      {step === STEPS.SCENARIO && (
        <section className="screen card">
          <h2>Choose Your Scenario</h2>
          <p style={{ color: '#94a3b8', marginBottom: '20px' }}>
            Select a scenario to define your goals and starting conditions, or play in sandbox mode for free play.
          </p>
          <div className="grid" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '16px' }}>
            {SCENARIOS.map((scenario) => (
              <div 
                key={scenario.id} 
                className="mini-card" 
                style={{
                  border: '1px solid #334155',
                  cursor: 'pointer',
                  transition: 'transform 0.2s, border-color 0.2s'
                }}
                onClick={() => {
                  setState((s) => ({
                    ...s,
                    scenario: scenario.id,
                    money: scenario.initialMoney,
                    fame: scenario.initialFame,
                    goals: scenario.goals.map(g => ({ ...g, completed: false, progress: 0 })),
                    achievements: [],
                    scenarioStartWeek: 1
                  }));
                  setStep(STEPS.CREATE);
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.transform = 'translateY(-2px)';
                  e.currentTarget.style.borderColor = '#7c3aed';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.transform = 'translateY(0)';
                  e.currentTarget.style.borderColor = '#334155';
                }}
              >
                <h3 style={{ marginTop: 0 }}>{scenario.name}</h3>
                <p style={{ fontSize: '0.9em', color: '#94a3b8', marginBottom: '12px' }}>
                  {scenario.description}
                </p>
                <div style={{ fontSize: '0.85em', marginBottom: '12px', padding: '8px', background: '#000000', borderRadius: '4px' }}>
                  <div>Starting Money: <strong>${scenario.initialMoney}</strong></div>
                  <div>Starting Fame: <strong>{scenario.initialFame}</strong></div>
                </div>
                {scenario.goals.length > 0 && (
                  <div style={{ fontSize: '0.85em', color: '#64748b' }}>
                    <strong>Goals:</strong>
                    <ul style={{ margin: '4px 0 0 0', paddingLeft: '20px' }}>
                      {scenario.goals.map((goal, idx) => (
                        <li key={idx}>{goal.label}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            ))}
          </div>
        </section>
      )}

      {step === STEPS.CREATE && (
        <section className="screen card">
          <h2>Band Creation</h2>
          <label>Band Name</label>
          <input
            value={state.bandName}
            onChange={(e) => setState((s) => ({ ...s, bandName: e.target.value }))}
            placeholder="Enter band name"
          />
          <label>Genre</label>
          <select value={state.genre} onChange={(e) => {
            const newGenre = e.target.value;
            const newTheme = GENRE_THEMES[newGenre] || 'theme-modern';
            setState((s) => ({ ...s, genre: newGenre }));
            setTheme(newTheme);
          }}>
            {(data?.genres || GENRES).map(g => (
              <option key={g}>{g}</option>
            ))}
          </select>
          <div className="card" style={{ marginTop: 8 }}>
            <h3>Band Setup (2-6)</h3>
            <p style={{ color: '#94a3b8' }}>Click to toggle roles. Current count: {desiredRoles.length}</p>
            <div className="role-grid">
              {ROLE_OPTIONS.map((role) => {
                const active = desiredRoles.includes(role.key);
                return (
                  <button
                    key={role.key}
                    className={`btn role-btn ${active ? 'active' : ''}`}
                    onClick={() => toggleRole(role.key)}
                    type="button"
                  >
                    {role.label}
                  </button>
                );
              })}
            </div>
            <div className="preset-row">
              <select value={lineupAddRole} onChange={(e) => setLineupAddRole(e.target.value)} style={{ maxWidth: 200 }}>
                {ROLE_OPTIONS.map((r) => <option key={r.key} value={r.key}>{r.label}</option>)}
              </select>
              <button className="btn" type="button" onClick={() => addLineupRole(lineupAddRole)} disabled={desiredRoles.length >= 6}>Add Slot</button>
              <span style={{ color: '#94a3b8', fontSize: 12 }}>Duplicates allowed (e.g., dual vocals)</span>
            </div>
            <div className="preset-row">
              <span>Presets:</span>
              <div className="preset-buttons">
                <button className="btn" onClick={() => applyLineupPreset(['vocals','guitar','bass','drums'])} type="button">Rock 4-piece</button>
                <button className="btn" onClick={() => applyLineupPreset(['vocals','vocals','synth','dj'])} type="button">Dual Vox + DJ</button>
                <button className="btn" onClick={() => applyLineupPreset(['vocals','guitar','synth','bass','drums'])} type="button">Electro Band</button>
                <button className="btn" onClick={() => applyLineupPreset(['vocals','vocals','guitar','bass','drums','synth'])} type="button">Big 6-piece</button>
              </div>
            </div>
          </div>
          <button className="btn" onClick={createBand}>Create Band & Design Logo</button>
        </section>
      )}

      {step === STEPS.LOGO && (
        <section className="screen card">
          <h2>Logo Designer</h2>
          <div className="logo-preview" style={logoStyle}>{state.bandName || 'Your Band'}</div>
          <div className="card" style={{ marginBottom: 12 }}>
            <h3>Logo Designer</h3>
            <div className="grid" style={{ marginBottom: 8 }}>
              <div className="mini-card">
                <p><strong>Font</strong></p>
                <select
                  value={state.logoFont}
                  onChange={(e) => setFont(e.target.value)}
                  style={{ width: '100%', marginBottom: 6 }}
                >
                  {fontOptions.map((font) => (
                    <option key={font} value={font} style={{ fontFamily: `'${font}', Arial` }}>
                      {font}
                    </option>
                  ))}
                </select>
                <div style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12 }}>
                  <label>Weight</label>
                  <select value={state.logoWeight || 700} onChange={(e) => setState((s) => ({ ...s, logoWeight: Number(e.target.value) }))}>
                    {[400,500,600,700,800,900].map((w) => <option key={w} value={w}>{w}</option>)}
                  </select>
                </div>
                <div style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12, marginTop: 6 }}>
                  <label>Size</label>
                  <input type="range" min="18" max="72" value={state.logoSize || 32} onChange={(e) => setState((s) => ({ ...s, logoSize: Number(e.target.value) }))} />
                  <span>{state.logoSize || 32}px</span>
                </div>
                <div style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12, marginTop: 6 }}>
                  <label>Letter</label>
                  <input type="range" min="-2" max="12" step="0.5" value={state.logoLetter || 0} onChange={(e) => setState((s) => ({ ...s, logoLetter: Number(e.target.value) }))} />
                  <span>{state.logoLetter || 0}px</span>
                </div>
                <div style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12, marginTop: 6 }}>
                  <label>Line</label>
                  <input type="range" min="0.8" max="1.6" step="0.05" value={state.logoLineHeight || 1.1} onChange={(e) => setState((s) => ({ ...s, logoLineHeight: Number(e.target.value) }))} />
                  <span>{state.logoLineHeight || 1.1}</span>
                </div>
                <label style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12, marginTop: 6 }}>
                  <input type="checkbox" checked={!!state.logoUpper} onChange={(e) => setState((s) => ({ ...s, logoUpper: e.target.checked }))} />
                  Uppercase
                </label>
              </div>
              <div className="mini-card">
                <p><strong>Colors</strong></p>
                <div style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12 }}>
                  <span>Text</span>
                  <input type="color" value={state.logoTextColor} onChange={(e) => setState((s) => ({ ...s, logoTextColor: e.target.value }))} />
                </div>
                <div style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12, marginTop: 6 }}>
                  <span>Background</span>
                  <input type="color" value={state.logoBgColor} onChange={(e) => setState((s) => ({ ...s, logoBgColor: e.target.value }))} />
                </div>
                <label style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12, marginTop: 6 }}>
                  <input type="checkbox" checked={!!state.logoGradient} onChange={(e) => setState((s) => ({ ...s, logoGradient: e.target.checked }))} />
                  Gradient
                </label>
                {state.logoGradient && (
                  <div style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12, marginTop: 6 }}>
                    <span>To</span>
                    <input type="color" value={state.logoBgColor2 || '#1e293b'} onChange={(e) => setState((s) => ({ ...s, logoBgColor2: e.target.value }))} />
                  </div>
                )}
              </div>
              <div className="mini-card">
                <p><strong>Effects</strong></p>
                <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap' }}>
                  {['none','soft','strong'].map((sfx) => (
                    <button key={sfx} className="btn" style={{ padding: '6px 10px', fontSize: '12px' }} onClick={() => setState((s) => ({ ...s, logoShadow: sfx }))}>
                      Shadow: {sfx}
                    </button>
                  ))}
                </div>
                <label style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12, marginTop: 6 }}>
                  <input type="checkbox" checked={!!state.logoOutline} onChange={(e) => setState((s) => ({ ...s, logoOutline: e.target.checked }))} />
                  Outline
                </label>
                {state.logoOutline && (
                  <div style={{ display: 'flex', gap: 6, alignItems: 'center', fontSize: 12, marginTop: 6 }}>
                    <span>Width</span>
                    <input type="range" min="0" max="4" step="0.2" value={state.logoOutlineWidth || 1} onChange={(e) => setState((s) => ({ ...s, logoOutlineWidth: Number(e.target.value) }))} />
                    <span>{state.logoOutlineWidth || 1}px</span>
                    <input type="color" value={state.logoOutlineColor || '#000000'} onChange={(e) => setState((s) => ({ ...s, logoOutlineColor: e.target.value }))} />
                  </div>
                )}
              </div>
              <div className="mini-card">
                <p><strong>Add Google Font</strong></p>
                <input
                  value={customFont}
                  onChange={(e) => setCustomFont(e.target.value)}
                  placeholder="Type any Google font name"
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      loadCustomFont();
                    }
                  }}
                />
                <button className="btn" onClick={loadCustomFont}>Add & Use</button>
                <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', marginTop: 8 }}>
                  {['Inter','Roboto','Space Grotesk','Playfair Display','Press Start 2P','Poppins','Fira Sans','Kanit'].map((f) => (
                    <button key={f} className="btn" style={{ padding: '6px 10px', fontSize: '12px' }} onClick={() => addFontOption(f)}>
                      {f}
                    </button>
                  ))}
                </div>
              </div>
            </div>
            <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', marginTop: 8 }}>
              {[
                { name: 'Bold Neon', cfg: { logoWeight: 800, logoSize: 36, logoTextColor: '#f472b6', logoBgColor: '#111827', logoShadow: 'strong', logoUpper: true, logoLetter: 1 } },
                { name: 'Retro Wave', cfg: { logoWeight: 700, logoSize: 32, logoTextColor: '#7dd3fc', logoBgColor: '#0f172a', logoBgColor2: '#312e81', logoGradient: true, logoShadow: 'soft', logoLetter: 2 } },
                { name: 'Clean Sans', cfg: { logoWeight: 600, logoSize: 28, logoTextColor: '#e2e8f0', logoBgColor: '#0b1220', logoShadow: 'none', logoLetter: 0, logoUpper: false } },
                { name: 'Outline Pop', cfg: { logoWeight: 800, logoSize: 34, logoTextColor: '#ffffff', logoBgColor: '#0f172a', logoShadow: 'soft', logoOutline: true, logoOutlineColor: '#0ea5e9', logoOutlineWidth: 1.5 } },
                { name: 'Serif Luxe', cfg: { logoWeight: 700, logoSize: 30, logoTextColor: '#fef3c7', logoBgColor: '#111827', logoShadow: 'soft', logoUpper: false, logoLetter: 0.5 } }
              ].map((tpl) => (
                <button
                  key={tpl.name}
                  className="btn"
                  style={{ padding: '8px 12px', fontSize: '12px' }}
                  onClick={() => setState((s) => ({ ...s, ...tpl.cfg }))}
                >
                  {tpl.name}
                </button>
              ))}
            </div>
          </div>
          <button className="btn" onClick={finishLogo}>Finish Logo & Start Career</button>
        </section>
      )}

      {step === STEPS.GAME && (
        <section className="screen">
          <div className="main-layout">
            <aside className="sidebar">
              {/* Left Sidebar Tabs */}
              <div style={{ display: 'flex', gap: '4px', marginBottom: '12px', flexWrap: 'wrap' }}>
                {[
                  { id: 'snapshot', label: 'Snapshot', icon: Activity },
                  { id: 'meters', label: 'Meters', icon: BarChart3 },
                  { id: 'team', label: 'Team', icon: Users },
                  { id: 'songs', label: 'Songs', icon: ListMusic }
                ].map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setLeftTab(tab.id)}
                    style={{
                      flex: 1,
                      minWidth: '70px',
                      padding: '6px 8px',
                      border: 'none',
                      background: leftTab === tab.id ? '#1e40af' : '#334155',
                      color: '#fff',
                      cursor: 'pointer',
                      borderRadius: '4px',
                      fontSize: '0.75em',
                      fontWeight: leftTab === tab.id ? 'bold' : 'normal',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '4px'
                    }}
                  >
                    <tab.icon size={12} />
                    {tab.label}
                  </button>
                ))}
              </div>
              
              {/* SNAPSHOT TAB */}
              {leftTab === 'snapshot' && (
                <div className="card">
                  <h2>Band Snapshot</h2>
                  <p>{state.bandName} â€¢ {state.genre}</p>
                  <div className="sidebar-stats">
                    <div><span>Week</span><strong>{state.week}</strong></div>
                    <div><span>Money</span><strong>${state.money}</strong></div>
                    <div><span>Fame</span><strong>{state.fame}</strong></div>
                    <div><span>Fans</span><strong>{state.fans}</strong></div>
                    <div><span>Morale</span><strong>{state.morale}%</strong></div>
                    <div><span>Expenses</span><strong>${state.weeklyExpenses}</strong></div>
                    <div><span>Staff</span><strong>{state.staffManager !== 'none' ? `${state.staffManager} mgr` : 'none'}{state.staffLawyer ? ' + lawyer' : ''}</strong></div>
                    <div><span>Label</span><strong>{state.labelDeal ? state.labelDeal.type : 'Independent'}</strong></div>
                    <div><span>Transport</span><strong>{TRANSPORT_TIERS[state.transportTier].name}</strong></div>
                    <div><span>Studio</span><strong>{STUDIO_TIERS[state.studioTier].name}</strong></div>
                    {state.labelDeal && (
                      <div style={{ gridColumn: '1 / -1', background: '#1e3a8a', borderColor: '#3b82f6', fontSize: '0.85em', padding: '8px', borderRadius: '4px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <strong>{state.labelDeal.name}</strong>
                          <span>{state.labelDeal.weeksRemaining || 0}w left</span>
                        </div>
                        <div style={{ fontSize: '0.75em', color: '#94a3b8' }}>
                          {100 - (state.labelDeal.royaltySplit || 0)}% royalties â€¢ ${state.labelDeal.marketingBudget || 0}/wk marketing
                        </div>
                      </div>
                    )}
                    {state.fame >= 50 && (
                      <div style={{ gridColumn: '1 / -1', background: '#064e3b', borderColor: '#10b981', display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}><DollarSign size={12} /> Merch Sales</span>
                        <strong>${Math.floor((state.fame * 0.25) + (state.fans * 0.15))}/wk</strong>
                      </div>
                    )}
                    {state.fame >= 45 && state.fame < 50 && (
                      <div style={{ gridColumn: '1 / -1', background: '#422006', borderColor: '#fbbf24', fontSize: '0.85em', display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <span>ðŸŽ¯ Unlock at 50 fame!</span>
                        <strong>{state.fame}/50</strong>
                      </div>
                    )}
                  </div>
                </div>
              )}
              
              {/* METERS TAB */}
              {leftTab === 'meters' && (
                <>
                  <div className="card">
                    <h3>Drama Meter</h3>
                    <p style={{ color: '#94a3b8', marginTop: -4 }}>Chance of a drama event this week.</p>
                    <div className="meter">
                      <div className="meter-fill" style={{ width: `${Math.round(dramaChance * 100)}%` }} />
                    </div>
                    <p style={{ fontWeight: 700 }}>{Math.round(dramaChance * 100)}% chance</p>
                    <p style={{ color: '#94a3b8', fontSize: 12 }}>Low morale and bigger bands increase drama.</p>
                  </div>
                  <div className="card">
                    <h3>Risk Meter</h3>
                    <p style={{ color: '#94a3b8', marginTop: -4 }}>Trouble odds (hospital/rehab/busted).</p>
                    <div className="meter">
                      <div className="meter-fill" style={{ width: `${Math.round(riskMeter.value * 100)}%`, background: '#f97316' }} />
                    </div>
                    <p style={{ fontWeight: 700 }}>{riskMeter.label} risk â€¢ Avg drama {riskMeter.avgDrama}</p>
                    <p style={{ color: '#94a3b8', fontSize: 12 }}>Higher drama, fame heat, and low morale raise risk.</p>
                  </div>
                </>
              )}
              
              {/* TEAM TAB */}
              {leftTab === 'team' && (
                <>
                  <div className="card">
                    <h3>Staffing</h3>
                    <p style={{ color: '#94a3b8', marginTop: -4 }}>Hire help; increases weekly expenses.</p>
                    <div className="grid" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))' }}>
                      <div>
                        <p><strong>Manager</strong></p>
                        <button className="btn btn-small" onClick={() => setState((s) => ({ ...s, staffManager: 'none' }))} disabled={state.staffManager === 'none'}>None</button>
                        <button className="btn btn-small" onClick={() => setState((s) => ({ ...s, staffManager: 'dodgy' }))} disabled={state.staffManager === 'dodgy'}>Dodgy ($80/wk)</button>
                        <button className="btn btn-small" onClick={() => setState((s) => ({ ...s, staffManager: 'pro' }))} disabled={state.staffManager === 'pro'}>Pro ($150/wk)</button>
                      </div>
                      <div>
                        <p><strong>Lawyer</strong></p>
                        <button className="btn btn-small" onClick={() => setState((s) => ({ ...s, staffLawyer: false }))} disabled={!state.staffLawyer}>None</button>
                        <button className="btn btn-small" onClick={() => setState((s) => ({ ...s, staffLawyer: true }))} disabled={state.staffLawyer}>Hire ($90/wk)</button>
                      </div>
                    </div>
                  </div>
                  <div className="card">
                    <h3>Band Members</h3>
                    <div className="member-actions">
                      <button className="btn" onClick={addMember} disabled={state.members.length >= 6}>Add Member</button>
                      <span style={{ color: '#94a3b8', fontSize: 12 }}>2-6 members â€¢ click a card to edit</span>
                    </div>
                    <div className="members members-cards">
                      {state.members.map((m) => {
                        const editing = editingMemberId === m.id;
                        const roleLabel = ROLE_OPTIONS.find((r) => r.key === m.role)?.label || m.role;
                        return (
                          <div
                            key={m.id}
                            className={`member-card ${editing ? 'editing' : ''}`}
                            onClick={() => setEditingMemberId(editing ? null : m.id)}
                          >
                            <div className="member-top">
                              {m.avatarSeed && (
                                <img 
                                  src={getAvatarUrl(m.avatarSeed, m.avatarStyle || 'open-peeps', m.role)} 
                                  alt={memberDisplayName(m)}
                                  style={{ 
                                    width: '48px', 
                                    height: '48px', 
                                    borderRadius: '50%',
                                    border: '2px solid #334155',
                                    backgroundColor: '#1e293b',
                                    objectFit: 'cover',
                                    filter: 'grayscale(100%)'
                                  }}
                                />
                              )}
                              {!m.avatarSeed && (
                              <div className="instrument-icon">{renderInstrumentIcon(m.role)}</div>
                              )}
                              <div>
                                <div className="member-name">{memberDisplayName(m)}</div>
                                <div className="member-role">{roleLabel} â€¢ {m.personality}</div>
                              </div>
                            </div>
                            <div className="member-radar">{renderRadar(m.stats || {})}</div>
                            {editing && (
                              <div className="member-edit" onClick={(e) => e.stopPropagation()}>
                                <div className="grid" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))' }}>
                                  <div>
                                    <label>First</label>
                                    <input value={m.firstName} onChange={(e) => updateMember(m.id, { firstName: e.target.value })} />
                                  </div>
                                  <div>
                                    <label>Last</label>
                                    <input value={m.lastName} onChange={(e) => updateMember(m.id, { lastName: e.target.value })} />
                                  </div>
                                  <div>
                                    <label>Nickname</label>
                                    <input value={m.nickname} onChange={(e) => updateMember(m.id, { nickname: e.target.value })} placeholder="Optional" />
                                  </div>
                                  <div>
                                    <label>Instrument</label>
                                    <select value={m.role} onChange={(e) => updateMember(m.id, { role: e.target.value })}>
                                      {ROLE_OPTIONS.map((r) => (
                                        <option key={r.key} value={r.key}>{r.label}</option>
                                      ))}
                                    </select>
                                  </div>
                                  <div>
                                    <label>Avatar Style</label>
                                    <select 
                                      value={m.avatarStyle || 'open-peeps'} 
                                      onChange={(e) => updateMember(m.id, { avatarStyle: e.target.value })}
                                    >
                                      <option value="lorelei">Lorelei (Musician Style)</option>
                                      <option value="open-peeps">Open Peeps (Human)</option>
                                      <option value="avataaars">Avataaars (Human)</option>
                                      <option value="personas">Personas (Human)</option>
                                      <option value="adventurer">Adventurer (Human)</option>
                                      <option value="pixel-art">Pixel Art</option>
                                      <option value="notionists">Notionists</option>
                                    </select>
                                  </div>
                                </div>
                                <div className="member-edit-actions">
                                  <button className="btn" onClick={() => setEditingMemberId(null)}>Done</button>
                                  <button className="btn danger" onClick={() => removeMember(m.id)} disabled={state.members.length <= 2}>Remove</button>
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </>
              )}
              
              {/* SONGS TAB */}
              {leftTab === 'songs' && (
                <div className="card">
                  <h3>Your Songs</h3>
                  {state.songs.length === 0 && <p>No songs yet. Write something!</p>}
                  {state.songs.length > 0 && (
                    <div className="members">
                      {[...state.songs].sort((a,b) => (b.popularity||0) - (a.popularity||0)).map((s) => (
                        <div key={s.title} className="member">
                          <div><strong>{s.title}</strong></div>
                          <div style={{ fontSize: 12, color: '#94a3b8' }}>
                            Q{Math.round(s.quality)} â€¢ Pop {s.popularity || 0} â€¢ Age {s.age || 0}w â€¢ Streams {s.streams || 0} (wk {s.weeklyStreams || 0}) â€¢ Plays {s.plays || 0}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </aside>

            <div className="center-column">
              <div className="card" style={{ marginBottom: '16px' }}>
                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', borderBottom: '1px solid #334155', paddingBottom: '12px' }}>
                  {[
                    { id: 'overview', label: 'Overview', icon: Activity, tooltip: 'View your band stats, goals, and achievements (1)', shortLabel: 'Overview' },
                    { id: 'actions', label: 'Actions', icon: Zap, tooltip: 'Record songs, release albums, and take actions (2)', shortLabel: 'Actions' },
                    { id: 'music', label: 'Music', icon: Music, tooltip: 'View your songs and albums (3)', shortLabel: 'Music' },
                    { id: 'social', label: 'Social', icon: Share2, tooltip: 'Manage social media and engagement (4)', shortLabel: 'Social' },
                    { id: 'gigs', label: 'Gigs', icon: Mic, tooltip: 'Book gigs and plan tours (5)', shortLabel: 'Gigs' },
                    { id: 'analytics', label: 'Analytics', icon: BarChart3, tooltip: 'View revenue breakdown and statistics (6)', shortLabel: 'Analytics' },
                    { id: 'upgrades', label: 'Upgrades', icon: Gem, tooltip: 'Upgrade studio, transport, and gear (7)', shortLabel: 'Upgrades' },
                    { id: 'log', label: 'Log', icon: FileText, tooltip: 'View game event log', shortLabel: 'Log' }
                  ].map(tab => (
                    <button
                      key={tab.id}
                      className="tab-button"
                      onClick={() => setCurrentTab(tab.id)}
                      onMouseEnter={(e) => {
                        if (tab.tooltip) {
                          setShowTooltip(tab.tooltip);
                          const rect = e.target.getBoundingClientRect();
                          setTooltipPosition({ x: rect.left + rect.width / 2, y: rect.top - 10 });
                        }
                      }}
                      onMouseLeave={() => setShowTooltip(null)}
                      style={{
                        padding: '10px 12px',
                        border: 'none',
                        background: currentTab === tab.id ? '#1e40af' : '#334155',
                        color: '#fff',
                        cursor: 'pointer',
                        borderRadius: '6px',
                        fontSize: '0.9em',
                        fontWeight: currentTab === tab.id ? 'bold' : 'normal',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '6px',
                        minHeight: '44px',
                        flex: '1 1 calc(50% - 4px)',
                        minWidth: 'calc(50% - 4px)'
                      }}
                    >
                      <tab.icon size={16} />
                      <span className="tab-label-full">{tab.label}</span>
                      <span className="tab-label-short">{tab.shortLabel || tab.label}</span>
                    </button>
                  ))}
                </div>
              </div>

              {/* OVERVIEW TAB */}
              {currentTab === 'overview' && (
                <>
                  {state.scenario && state.goals && state.goals.length > 0 && (
                    <div className="card" style={{ marginBottom: '16px', background: '#064e3b', borderColor: '#10b981' }}>
                      <h2>Scenario Goals</h2>
                      <p style={{ fontSize: '0.9em', color: '#94a3b8', marginBottom: '12px' }}>
                        {SCENARIOS.find(s => s.id === state.scenario)?.name || 'Scenario'}
                      </p>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {state.goals.map((goal, idx) => {
                          const progress = goal.type === 'totalStreams' || goal.type === 'tourRegions' || goal.type === 'surviveWeeks' || goal.type === 'totalHits'
                            ? Math.min(100, (goal.progress / goal.target) * 100)
                            : goal.completed ? 100 : 0;
                          return (
                            <div key={idx} style={{ 
                              padding: '10px', 
                              background: '#000000', 
                              borderRadius: '6px',
                              border: goal.completed ? '1px solid #10b981' : '1px solid #334155'
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                                <span style={{ fontWeight: goal.completed ? 'bold' : 'normal', color: goal.completed ? '#10b981' : '#e2e8f0' }}>
                                  {goal.completed && 'âœ“ '}{goal.label}
                                </span>
                                {goal.type === 'totalStreams' || goal.type === 'tourRegions' || goal.type === 'surviveWeeks' || goal.type === 'totalHits' && (
                                  <span style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                                    {goal.progress}/{goal.target}
                                  </span>
                                )}
                              </div>
                              {(goal.type === 'totalStreams' || goal.type === 'tourRegions' || goal.type === 'surviveWeeks' || goal.type === 'totalHits') && !goal.completed && (
                                <div className="meter" style={{ marginTop: '4px' }}>
                                  <div className="meter-fill" style={{ 
                                    width: `${progress}%`,
                                    background: progress >= 100 ? '#10b981' : '#3b82f6'
                                  }} />
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                      {state.scenarioComplete && (
                        <div style={{ 
                          marginTop: '12px', 
                          padding: '12px', 
                          background: '#10b981', 
                          borderRadius: '6px',
                          textAlign: 'center',
                          fontWeight: 'bold',
                          color: '#0a1120'
                        }}>
                          ðŸ† SCENARIO COMPLETE! All goals achieved!
                        </div>
                      )}
                    </div>
                  )}

                  {(state.achievements || []).length > 0 && (
                    <div className="card" style={{ marginBottom: '16px' }}>
                      <h2>Achievements</h2>
                      <div className="grid" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '8px' }}>
                        {[...(state.achievements || [])]
                          .sort((a, b) => (b.week || 0) - (a.week || 0))
                          .map((achievement, idx) => (
                            <div key={idx} style={{ 
                              padding: '8px', 
                              background: '#000000', 
                              borderRadius: '6px',
                              border: '1px solid #334155',
                              textAlign: 'center'
                            }}>
                              <div style={{ fontSize: '1.5em', marginBottom: '4px' }}>ðŸ†</div>
                              <div style={{ fontSize: '0.85em', fontWeight: 'bold' }}>{achievement.name}</div>
                              <div style={{ fontSize: '0.75em', color: '#64748b', marginTop: '2px' }}>
                                Week {achievement.week || 0}
                              </div>
                            </div>
                          ))}
                      </div>
                    </div>
                  )}

                  {state.trend && (
                    <div className="card" style={{ marginBottom: '16px', background: '#064e3b', borderColor: '#10b981' }}>
                      <h2>Current Genre Trend</h2>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <div style={{ fontSize: '1.5em' }}>
                          {state.trend.strength === 'major' ? 'ðŸ”¥' : state.trend.strength === 'moderate' ? 'ðŸ“ˆ' : 'ðŸ“Š'}
                        </div>
                        <div>
                          <div style={{ fontWeight: 'bold', fontSize: '1.1em' }}>{state.trend.genre}</div>
                          <div style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                            +{state.trend.modifier}% popularity â€¢ {state.trend.weeks} weeks remaining
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {(state.industryEvents || []).length > 0 && (
                    <div className="card" style={{ marginBottom: '16px' }}>
                      <h2>Industry Events</h2>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {[...(state.industryEvents || [])]
                          .sort((a, b) => (b.week || 0) - (a.week || 0))
                          .slice(0, 5)
                          .map((event, idx) => (
                            <div key={idx} style={{ 
                              padding: '10px', 
                              background: event.type === 'win' ? '#064e3b' : '#0a1120', 
                              borderRadius: '6px',
                              border: `1px solid ${event.type === 'win' ? '#10b981' : '#334155'}`
                            }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <Trophy size={20} color={event.type === 'win' ? '#10b981' : '#94a3b8'} />
                                <div>
                                  <div style={{ fontWeight: 'bold' }}>
                                    {event.type === 'win' ? 'ðŸ† Won' : 'ðŸ“‹ Nominated'}: {event.name}
                                  </div>
                                  <div style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                                    Week {event.week || 0}
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                      </div>
                    </div>
                  )}

                  <div className="stats">
                    <div className="stat">Money: ${state.money}</div>
                    <div className="stat">Fame: {state.fame}</div>
                    <div className="stat">Morale: {state.morale}%</div>
                    <div className="stat">Fans: {state.fans}</div>
                    <div className="stat">Week: {state.week}</div>
                    <div className="stat">Weekly Expenses: ${state.weeklyExpenses}</div>
                    {state.totalMerchandise > 0 && (
                      <div className="stat" style={{ background: '#064e3b', borderColor: '#10b981', display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <DollarSign size={16} /> Merch: ${state.totalMerchandise} total
                      </div>
                    )}
                  </div>
                  <div className="card">
                    <h2>Upgrades Summary</h2>
                    <div className="grid" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))' }}>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '4px', border: '1px solid #334155' }}>
                        <p style={{ color: '#94a3b8', fontSize: '0.9em', display: 'flex', alignItems: 'center', gap: '6px' }}><Radio size={14} /> Studio</p>
                        <p style={{ fontWeight: 'bold' }}>{STUDIO_TIERS[state.studioTier].name}</p>
                        <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Quality +{STUDIO_TIERS[state.studioTier].qualityBonus}%</p>
                      </div>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '4px', border: '1px solid #334155' }}>
                        <p style={{ color: '#94a3b8', fontSize: '0.9em', display: 'flex', alignItems: 'center', gap: '6px' }}><TrendingUp size={14} /> Transport</p>
                        <p style={{ fontWeight: 'bold' }}>{TRANSPORT_TIERS[state.transportTier].name}</p>
                        <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Earnings Ã—{TRANSPORT_TIERS[state.transportTier].gigBonus.toFixed(2)}</p>
                      </div>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '4px', border: '1px solid #334155' }}>
                        <p style={{ color: '#94a3b8', fontSize: '0.9em', display: 'flex', alignItems: 'center', gap: '6px' }}>
                          {React.createElement(GEAR_TIERS[state.gearTier].icon, { size: 14 })} Gear
                        </p>
                        <p style={{ fontWeight: 'bold' }}>{GEAR_TIERS[state.gearTier].name}</p>
                        <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Earnings Ã—{GEAR_TIERS[state.gearTier].gigBonus.toFixed(2)}</p>
                      </div>
                    </div>
                  </div>
                  <div className="card">
                    <h2>Band Status</h2>
                    <div className="grid" style={{ gridTemplateColumns: '1fr 1fr' }}>
                      <div>
                        <p><strong>Members:</strong> {state.members.length} / 6</p>
                        <p><strong>Songs:</strong> {state.songs.length}</p>
                        <p><strong>Manager:</strong> {state.staffManager !== 'none' ? `${state.staffManager} (${state.staffManager === 'dodgy' ? '$80' : '$150'}/wk)` : 'None'}</p>
                      </div>
                      <div>
                        <p><strong>Lawyer:</strong> {state.staffLawyer ? 'Yes ($90/wk)' : 'No'}</p>
                        <p><strong>Label:</strong> {state.labelDeal ? `${state.labelDeal.name} (${state.labelDeal.type})` : 'Independent'}</p>
                        <p><strong>Albums:</strong> {(state.albums || []).length}</p>
                        <p><strong>Tour Ban:</strong> {state.tourBan > 0 ? `${state.tourBan} week(s)` : 'None'}</p>
                        {state.labelDeal && (
                          <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                            Contract: {state.labelDeal.weeksRemaining}/{state.labelDeal.contractLength} weeks remaining
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  <div className="card">
                    <h2>Revenue Breakdown (This Week)</h2>
                    <div style={{ display: 'grid', gap: '12px' }}>
                      {(() => {
                        // Calculate estimated weekly revenue
                        const songStreams = (state.songs || []).reduce((sum, s) => sum + (s.weeklyStreams || 0), 0);
                        const albumStreams = (state.albums || []).reduce((sum, a) => {
                          const freshness = Math.max(0.3, 1 - (a.age || 0) * 0.02);
                          return sum + Math.floor(((a.quality || 0) * 150 + (a.popularity || 0) * 80) * freshness);
                        }, 0);
                        const totalStreams = songStreams + albumStreams;
                        const grossStreamRevenue = Math.floor(totalStreams * 0.004);
                        const grossRadioRevenue = (state.songs || []).reduce((sum, s) => {
                          return sum + (Math.floor((s.popularity || 0) / 12) * 2);
                        }, 0);
                        const grossRevenue = grossStreamRevenue + grossRadioRevenue;
                        const labelCut = state.labelDeal && state.labelDeal.type !== 'independent'
                          ? Math.floor(grossRevenue * (state.labelDeal.royaltySplit || 0) / 100)
                          : 0;
                        const netRevenue = grossRevenue - labelCut;
                        const merchRevenue = state.fame >= 50 ? Math.floor((state.fame * 0.25) + (state.fans * 0.15)) : 0;
                        
                        return (
                          <>
                            <div style={{ 
                              padding: '10px', 
                              background: '#000000', 
                              borderRadius: '6px',
                              border: '1px solid #334155'
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                <span style={{ color: '#94a3b8' }}>ðŸ’° Streaming Revenue</span>
                                <strong>${grossStreamRevenue.toLocaleString()}</strong>
                              </div>
                              <div style={{ fontSize: '0.8em', color: '#64748b' }}>
                                {(totalStreams / 1000).toFixed(1)}k streams Ã— $0.004
                              </div>
                            </div>
                            
                            <div style={{ 
                              padding: '10px', 
                              background: '#000000', 
                              borderRadius: '6px',
                              border: '1px solid #334155'
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                <span style={{ color: '#94a3b8' }}>ðŸ“» Radio Revenue</span>
                                <strong>${grossRadioRevenue.toLocaleString()}</strong>
                              </div>
                            </div>
                            
                            {state.labelDeal && state.labelDeal.type !== 'independent' && labelCut > 0 && (
                              <div style={{ 
                                padding: '10px', 
                                background: '#7c2d12', 
                                borderRadius: '6px',
                                border: '1px solid #f59e0b'
                              }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                  <span style={{ color: '#fbbf24' }}>ðŸ“‰ Label Royalty Split</span>
                                  <strong style={{ color: '#f59e0b' }}>-${labelCut.toLocaleString()}</strong>
                                </div>
                                <div style={{ fontSize: '0.8em', color: '#fbbf24' }}>
                                  {state.labelDeal.royaltySplit}% to {state.labelDeal.name}
                                </div>
                              </div>
                            )}
                            
                            {merchRevenue > 0 && (
                              <div style={{ 
                                padding: '10px', 
                                background: '#000000', 
                                borderRadius: '6px',
                                border: '1px solid #334155'
                              }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                  <span style={{ color: '#94a3b8' }}>ðŸ›ï¸ Merchandise</span>
                                  <strong>${merchRevenue.toLocaleString()}</strong>
                                </div>
                              </div>
                            )}
                            
                            <div style={{ 
                              padding: '12px', 
                              background: '#064e3b', 
                              borderRadius: '6px',
                              border: '2px solid #10b981',
                              marginTop: '8px'
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span style={{ fontWeight: 'bold', color: '#10b981' }}>Net Weekly Income</span>
                                <strong style={{ fontSize: '1.2em', color: '#10b981' }}>
                                  ${(netRevenue + merchRevenue).toLocaleString()}
                                </strong>
                              </div>
                              {state.labelDeal && state.labelDeal.marketingBudget > 0 && (
                                <div style={{ fontSize: '0.85em', color: '#94a3b8', marginTop: '6px' }}>
                                  + Label marketing boost: ${state.labelDeal.marketingBudget}/wk
                                </div>
                              )}
                            </div>
                          </>
                        );
                      })()}
                    </div>
                  </div>
                </>
              )}

              {/* ACTIONS TAB */}
              {currentTab === 'actions' && (
                <div className="card">
                  <h2>Weekly Actions</h2>
                  <div className="grid">
                    <div className="mini-card">
                      <h3>Write & Record Song</h3>
                      <p>Record a new single at {STUDIO_TIERS[state.studioTier].name}</p>
                      <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Cost: ${STUDIO_TIERS[state.studioTier].recordCost} | Quality +{STUDIO_TIERS[state.studioTier].qualityBonus}</p>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <button className="btn" onClick={() => {
                          const studio = STUDIO_TIERS[state.studioTier];
                          const difficulty = state.difficulty || 'normal';
                          const costMultiplier = difficulty === 'easy' ? 0.8 : difficulty === 'hard' ? 1.2 : 1;
                          const cost = Math.floor(studio.recordCost * costMultiplier);
                          
                          if (state.money < cost) {
                            addLog(`Not enough money to record (need $${cost})`, true, {
                              title: 'Insufficient Funds',
                              message: `You need $${cost} to record a song at ${studio.name}.`,
                              type: 'warning'
                            });
                            return;
                          }
                          
                          // Generate a default title
                          const titles = data?.songTitles || ['New Song'];
                          const unusedTitles = titles.filter((t) => !state.songs.find((s) => s.title === t));
                          const defaultTitle = unusedTitles.length
                            ? unusedTitles[Math.floor(Math.random() * unusedTitles.length)]
                            : titles[Math.floor(Math.random() * titles.length)] + ' (Remix)';
                          
                          setNewSongTitle(defaultTitle);
                          setShowWriteSongModal(true);
                        }} style={{ flex: 1 }}>Write Song</button>
                        <button className="btn-secondary" onClick={() => setShowStudioModal(true)}>Studios</button>
                      </div>
                    </div>
                    <div className="mini-card">
                      <h3>Release Album</h3>
                      <p>Compile 8-12 songs into an album</p>
                      <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                        {state.songs.filter(s => !s.inAlbum).length} available songs â€¢ Albums provide sustained streaming revenue
                      </p>
                      <button 
                        className="btn" 
                        onClick={() => {
                          if (state.songs.filter(s => !s.inAlbum).length < 8) {
                            alert('You need at least 8 songs that aren\'t already in an album to release one.');
                            return;
                          }
                          setShowAlbumBuilderModal(true);
                        }}
                        disabled={state.songs.filter(s => !s.inAlbum).length < 8}
                        style={{ width: '100%' }}
                      >
                        {state.songs.filter(s => !s.inAlbum).length < 8 ? 'Need 8+ Songs' : 'Build Album'}
                      </button>
                    </div>
                    <div className="mini-card">
                      <h3>Label & Distribution</h3>
                      {state.labelDeal ? (
                        <>
                          <p><strong>{state.labelDeal.name}</strong></p>
                          <p style={{ fontSize: '0.85em', color: '#94a3b8', marginTop: '4px' }}>
                            {state.labelDeal.type} â€¢ {state.labelDeal.weeksRemaining || 0} weeks left
                          </p>
                          <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                            You keep {100 - (state.labelDeal.royaltySplit || 0)}% royalties
                          </p>
                          <p style={{ fontSize: '0.85em', color: '#3b82f6' }}>
                            Marketing: ${state.labelDeal.marketingBudget || 0}/wk
                          </p>
                        </>
                      ) : (
                        <>
                          <p>Currently Independent</p>
                          <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                            Label offers appear as random events. Higher fame = better deals.
                          </p>
                        </>
                      )}
                    </div>
                    <div className="mini-card">
                      <h3>Do Nothing</h3>
                      <p>Take a week off. Rest, recover, let things settle.</p>
                      <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                        Rest can improve morale and health. Sometimes less is more.
                      </p>
                      <button 
                        className="btn-secondary" 
                        onClick={() => {
                          advanceWeek(
                            (s) => ({
                              ...s,
                              morale: Math.min(100, s.morale + 2 + Math.floor(Math.random() * 3)),
                              fans: Math.max(0, s.fans - Math.floor(s.fans * 0.02)) // Small fan decay
                            }),
                            'You took a week off. Band morale improved, but some fans lost interest.'
                          );
                        }}
                        style={{ width: '100%' }}
                      >
                        Take Week Off
                      </button>
                    </div>
                    <div className="mini-card">
                      <h3>Collaboration</h3>
                      <p>Feature another artist on a track for cross-promotion.</p>
                      <button className="btn" onClick={() => {
                        if (state.songs.length === 0) {
                          alert('You need at least one song to collaborate on!');
                          return;
                        }
                        if (state.fame < 50) {
                          alert('You need at least 50 fame for other artists to want to collaborate.');
                          return;
                        }
                        
                        const baseCost = 600;
                        const difficulty = state.difficulty || 'normal';
                        const costMultiplier = difficulty === 'easy' ? 0.8 : difficulty === 'hard' ? 1.2 : 1;
                        const finalCost = Math.floor(baseCost * costMultiplier);
                        
                        if (state.money < finalCost) {
                          alert(`Need $${finalCost} for collaboration (includes production and artist fee).`);
                          return;
                        }
                        
                        const topSong = [...state.songs].sort((a,b) => (b.popularity||0) - (a.popularity||0))[0];
                        const collaboratorNames = ['Ava Martinez', 'Jake Rivers', 'Luna Chen', 'Max Powers', 'Zoe Black', 'Ryan Stone', 'Maya Patel', 'Alex Cross'];
                        const collaborator = collaboratorNames[Math.floor(Math.random() * collaboratorNames.length)];
                        
                        advanceWeek(
                          (s) => {
                            const songs = s.songs.map(song => 
                              song.title === topSong.title
                                ? { 
                                    ...song, 
                                    popularity: Math.min(100, (song.popularity || 0) + 15),
                                    title: `${song.title} (feat. ${collaborator})`
                                  }
                                : song
                            );
                            
                            const newCollaboration = {
                              songTitle: topSong.title,
                              collaborator,
                              week: s.week,
                              cost: finalCost,
                              popularityBoost: 15
                            };
                            
                            return {
                              ...s,
                              songs,
                              money: s.money - finalCost,
                              fame: s.fame + 8,
                              collaborations: [...(s.collaborations || []), newCollaboration]
                            };
                          },
                          `Collaborated with ${collaborator} on "${topSong.title}"! Cross-promotion boosts popularity. -$${finalCost}, +8 fame.`,
                          'collaboration'
                        );
                      }} disabled={state.songs.length === 0 || state.fame < 50 || state.money < 600}>
                        Collaborate (${state.difficulty === 'easy' ? 480 : state.difficulty === 'hard' ? 720 : 600})
                      </button>
                      {state.collaborations && state.collaborations.length > 0 && (
                        <p style={{ fontSize: '0.85em', color: '#94a3b8', marginTop: '8px' }}>
                          {state.collaborations.length} collaboration{state.collaborations.length !== 1 ? 's' : ''}
                        </p>
                      )}
                    </div>
                    <div className="mini-card">
                      <h3>Rehearse</h3>
                      <p>Sharpen performance. Small fame bump.</p>
                      <button className="btn" onClick={rehearse}>Rehearse</button>
                    </div>
                    <div className="mini-card">
                      <h3>Training</h3>
                      <p>Paid coaching gives a modest bump to one stat across the band. No back-to-back weeks.</p>
                      <select onChange={(e) => setState((s) => ({ ...s, trainingFocus: e.target.value }))} value={state.trainingFocus || 'stagePresence'}>
                        <option value="stagePresence">Stage</option>
                        <option value="skill">Skill</option>
                        <option value="creativity">Creativity</option>
                        <option value="reliability">Reliability</option>
                      </select>
                      <button className="btn" onClick={() => {
                        if (state.trainingCooldown > 0) return;
                        const focus = state.trainingFocus || 'stagePresence';
                        const baseCost = 220 + Math.max(0, state.members.length - 3) * 35;
                        advanceWeek(
                          (s) => ({
                            ...s,
                            money: s.money - baseCost,
                            trainingCooldown: 2,
                            members: s.members.map((m) => {
                              const current = m.stats?.[focus] ?? 5;
                              const diminishing = Math.max(0.05, 0.26 - current * 0.025);
                              return {
                                ...m,
                                stats: { ...m.stats, [focus]: clampStat(current + diminishing) }
                              };
                            })
                          }),
                          `Training focused on ${focus}. Cost $${baseCost}. Diminishing gains at higher stats.`,
                          'train'
                        );
                      }} disabled={state.trainingCooldown > 0}>
                        {state.trainingCooldown > 0 ? `Cooldown (${state.trainingCooldown}w)` : 'Train'}
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* MUSIC TAB */}
              {currentTab === 'music' && (
                <>
                  <div className="card">
                    <h2>Your Albums</h2>
                    {(!state.albums || state.albums.length === 0) ? (
                      <p style={{ color: '#94a3b8' }}>No albums yet. Release one when you have 8+ songs ready!</p>
                    ) : (
                      <div className="members" style={{ marginBottom: '20px' }}>
                        {[...(state.albums || [])].sort((a,b) => (b.week || 0) - (a.week || 0)).map((album) => (
                          <div key={album.name + album.week} className="member" style={{ 
                            border: latestAlbum && album.name === latestAlbum.name ? '2px solid #3b82f6' : '1px solid #334155',
                            background: latestAlbum && album.name === latestAlbum.name ? '#1e3a8a' : '#000000'
                          }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                              <strong>{album.name}</strong>
                              {latestAlbum && album.name === latestAlbum.name && (
                                <span style={{ fontSize: '0.75em', color: '#60a5fa', background: '#1e40af', padding: '2px 6px', borderRadius: '4px' }}>LATEST</span>
                              )}
                            </div>
                            <div style={{ fontSize: 12, color: '#94a3b8', marginTop: '4px' }}>
                              {album.songs || 0} tracks â€¢ Q{album.quality || 0} â€¢ Pop {album.popularity || 0} â€¢ Age {album.age || 0}w
                            </div>
                            <div style={{ fontSize: 11, color: '#64748b', marginTop: '4px' }}>
                              Chart Score: {album.chartScore || 0} â€¢ Promo: +{album.promoBoost || 0}
                            </div>
                            {album.songTitles && album.songTitles.length > 0 && (
                              <details style={{ marginTop: '6px' }}>
                                <summary style={{ fontSize: '11px', color: '#64748b', cursor: 'pointer' }}>View Tracklist</summary>
                                <div style={{ marginTop: '4px', paddingLeft: '12px', fontSize: '11px', color: '#94a3b8' }}>
                                  {album.songTitles.slice(0, 5).map((title, idx) => (
                                    <div key={idx}>â€¢ {title}</div>
                                  ))}
                                  {album.songTitles.length > 5 && <div>... and {album.songTitles.length - 5} more</div>}
                                </div>
                              </details>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                  
                  <div className="card">
                    <h2>Your Songs</h2>
                    {state.songs.length === 0 && <p>No songs yet. Record something in the Actions tab!</p>}
                    {state.songs.length > 0 && (
                      <>
                        <div style={{ marginBottom: '12px', fontSize: '0.9em', color: '#94a3b8' }}>
                          {state.songs.filter(s => !s.inAlbum).length} singles available for albums â€¢ {state.songs.filter(s => s.inAlbum).length} in albums
                        </div>
                      <div className="members">
                        {[...state.songs].sort((a,b) => (b.popularity||0) - (a.popularity||0)).map((s) => (
                            <div key={s.title} className="member" style={{
                              opacity: s.inAlbum ? 0.6 : 1,
                              borderColor: s.inAlbum ? '#475569' : undefined
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <strong>{s.title}</strong>
                                {s.inAlbum && (
                                  <span style={{ fontSize: '0.7em', color: '#64748b', background: '#000000', padding: '2px 6px', borderRadius: '4px' }}>IN ALBUM</span>
                                )}
                              </div>
                            <div style={{ fontSize: 12, color: '#94a3b8' }}>
                              Q{Math.round(s.quality)} â€¢ Pop {s.popularity || 0} â€¢ Age {s.age || 0}w â€¢ Streams {s.streams || 0} (wk {s.weeklyStreams || 0}) â€¢ Plays {s.plays || 0}
                            </div>
                          </div>
                        ))}
                      </div>
                      </>
                    )}
                  </div>
                  <div className="card">
                    <h2>Music Promotion</h2>
                    <div className="grid">
                      <div className="mini-card">
                        <h3>Promote Single</h3>
                        <p>Light promotion nudges your strongest song forward. No back-to-back runs.</p>
                        <button className="btn" onClick={() => {
                          const top = state.songs[0];
                          if (!top || state.promoteCooldown > 0) return;
                          advanceWeek(
                            (s) => {
                              const boosted = [...s.songs].sort((a,b) => (b.popularity||0) - (a.popularity||0));
                              if (boosted.length) {
                                const currentPop = boosted[0].popularity || 0;
                                const popGain = Math.max(3, Math.round(10 - currentPop * 0.05));
                                boosted[0] = {
                                  ...boosted[0],
                                  popularity: Math.min(100, currentPop + popGain),
                                  age: Math.max(0, (boosted[0].age || 0) - 0.5)
                                };
                              }
                              const promoCost = 170 + Math.max(0, boosted.length - 3) * 18;
                              return { ...s, songs: boosted, money: s.money - promoCost, fame: s.fame + 1, promoteCooldown: 2 };
                            },
                            'Promoted your top single. Smaller bump with diminishing returns and a cooldown.',
                            'promote'
                          );
                        }} disabled={!state.songs.length || state.promoteCooldown > 0}>
                          {state.promoteCooldown > 0 ? `Cooldown (${state.promoteCooldown}w)` : 'Promote'}
                        </button>
                      </div>
                      <div className="mini-card">
                        <h3>Music Video</h3>
                        <p>Film a video for your top single to slow decay and boost streams.</p>
                        <button className="btn" onClick={() => {
                          if (!state.songs.length) return;
                          const topSong = [...state.songs].sort((a,b) => (b.popularity||0) - (a.popularity||0))[0];
                          const baseCost = 400;
                          const difficultyMultiplier = state.difficulty === 'easy' ? 0.8 : state.difficulty === 'hard' ? 1.2 : 1;
                          const finalCost = Math.floor(baseCost * difficultyMultiplier);
                          
                          advanceWeek(
                            (s) => {
                              const songs = [...s.songs].sort((a,b) => (b.popularity||0) - (a.popularity||0));
                              if (songs.length) {
                                const videoBoost = Math.floor(10 + (s.fame / 20)); // Better videos with more fame
                                songs[0] = { 
                                  ...songs[0], 
                                  popularity: Math.min(100, (songs[0].popularity || 0) + videoBoost), 
                                  age: Math.max(0, (songs[0].age || 0) - 2), 
                                  videoBoost: true 
                                };
                              }
                              const albums = [...(s.albums || [])];
                              if (albums.length) {
                                const latest = [...albums].sort((a,b) => (b.week||0) - (a.week||0))[0];
                                latest.promoBoost = Math.min(18, (latest.promoBoost || 0) + 6);
                              }
                              
                              // Track music video
                              const newVideo = {
                                songTitle: songs[0]?.title || 'Unknown',
                                week: s.week,
                                cost: finalCost,
                                views: Math.floor((s.fame * 100) + (songs[0]?.popularity || 0) * 50)
                              };
                              
                              return { 
                                ...s, 
                                songs, 
                                albums, 
                                money: s.money - finalCost, 
                                fame: s.fame + 4,
                                musicVideos: [...(s.musicVideos || []), newVideo]
                              };
                            },
                            `Shot a music video for "${topSong.title}": gains popularity and freshness. -$${finalCost}, +4 fame.`,
                            'video'
                          );
                        }} disabled={!state.songs.length || state.money < 400}>
                          Shoot Video (-${state.difficulty === 'easy' ? 320 : state.difficulty === 'hard' ? 480 : 400})
                        </button>
                        {state.musicVideos && state.musicVideos.length > 0 && (
                          <p style={{ fontSize: '0.85em', color: '#94a3b8', marginTop: '8px' }}>
                            {state.musicVideos.length} video{state.musicVideos.length !== 1 ? 's' : ''} produced
                          </p>
                        )}
                      </div>
                      <div className="mini-card">
                        <h3>Media Push</h3>
                        <p>Climb the media ladder (radio â†’ TV â†’ satellite).</p>
                        <select value={state.mediaTier || 'tinpot'} onChange={(e) => setState((s) => ({ ...s, mediaTier: e.target.value }))}>
                          <option value="tinpot">Radio Tinpot (cost $120, fame +3, fans +40)</option>
                          <option value="regional">Regional Radio Tour (cost $260, fame +6, fans +120)</option>
                          <option value="tv">National TV (cost $520, fame +12, fans +260)</option>
                          <option value="satellite">World Satellite (cost $900, fame +20, fans +420)</option>
                        </select>
                        <button className="btn" onClick={() => {
                          const tier = state.mediaTier || 'tinpot';
                          const cfg = {
                            tinpot: { cost: 120, fame: 3, fans: 40, req: 0 },
                            regional: { cost: 260, fame: 6, fans: 120, req: 50 },
                            tv: { cost: 520, fame: 12, fans: 260, req: 120 },
                            satellite: { cost: 900, fame: 20, fans: 420, req: 220 }
                          }[tier];
                          if (!cfg) return;
                          if (state.fame < cfg.req) {
                            alert(`Need ${cfg.req} fame for this tier.`);
                            return;
                          }
                          advanceWeek(
                            (s) => ({
                              ...s,
                              money: s.money - cfg.cost,
                              fame: s.fame + cfg.fame,
                              fans: s.fans + cfg.fans,
                              songs: s.songs.map((song, idx) => idx === 0 ? { ...song, popularity: Math.min(100, (song.popularity || 0) + Math.ceil(cfg.fame / 2)) } : song)
                            }),
                            `${tier === 'tinpot' ? 'Radio Tinpot' : tier === 'regional' ? 'Regional radio' : tier === 'tv' ? 'National TV' : 'World Satellite'} push: +${cfg.fame} fame, +${cfg.fans} fans, top song boosted.`
                          );
                        }}>
                          Run Push
                        </button>
                      </div>
                    </div>
                  </div>
                </>
              )}

              {/* SOCIAL TAB */}
              {currentTab === 'social' && (
                <>
                  <div className="card">
                    <h2>Social Media & Engagement</h2>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px', marginBottom: '20px' }}>
                      <div style={{ 
                        padding: '16px', 
                        background: '#000000', 
                        borderRadius: '8px',
                        border: '1px solid #334155'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                          <Sparkles size={20} color="#ff0050" />
                          <h3 style={{ margin: 0, fontSize: '1.1em' }}>TikTok</h3>
                        </div>
                        <div style={{ fontSize: '0.9em', color: '#94a3b8', marginBottom: '4px' }}>Followers</div>
                        <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#ff0050' }}>
                          {(state.socialMedia?.tiktok?.followers || 0).toLocaleString()}
                        </div>
                        <div style={{ fontSize: '0.85em', color: '#64748b', marginTop: '4px' }}>
                          Engagement: {((state.socialMedia?.tiktok?.engagementRate || 0) * 100).toFixed(1)}%
                        </div>
                      </div>

                      <div style={{ 
                        padding: '16px', 
                        background: '#000000', 
                        borderRadius: '8px',
                        border: '1px solid #334155'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                          <Heart size={20} color="#E4405F" />
                          <h3 style={{ margin: 0, fontSize: '1.1em' }}>Instagram</h3>
                        </div>
                        <div style={{ fontSize: '0.9em', color: '#94a3b8', marginBottom: '4px' }}>Followers</div>
                        <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#E4405F' }}>
                          {(state.socialMedia?.instagram?.followers || 0).toLocaleString()}
                        </div>
                        <div style={{ fontSize: '0.85em', color: '#64748b', marginTop: '4px' }}>
                          Engagement: {((state.socialMedia?.instagram?.engagementRate || 0) * 100).toFixed(1)}%
                        </div>
                      </div>

                      <div style={{ 
                        padding: '16px', 
                        background: '#000000', 
                        borderRadius: '8px',
                        border: '1px solid #334155'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                          <MessageCircle size={20} color="#1DA1F2" />
                          <h3 style={{ margin: 0, fontSize: '1.1em' }}>Twitter/X</h3>
                        </div>
                        <div style={{ fontSize: '0.9em', color: '#94a3b8', marginBottom: '4px' }}>Followers</div>
                        <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#1DA1F2' }}>
                          {(state.socialMedia?.twitter?.followers || 0).toLocaleString()}
                        </div>
                        <div style={{ fontSize: '0.85em', color: '#64748b', marginTop: '4px' }}>
                          Engagement: {((state.socialMedia?.twitter?.engagementRate || 0) * 100).toFixed(1)}%
                        </div>
                      </div>
                    </div>

                    <div className="card" style={{ marginBottom: '20px' }}>
                      <h3>Algorithm Favor</h3>
                      <p style={{ color: '#94a3b8', marginTop: -4, marginBottom: '12px' }}>
                        Higher favor increases playlist placement chances and viral potential.
                      </p>
                      <div className="meter">
                        <div className="meter-fill" style={{ 
                          width: `${state.algorithmFavor || 0}%`,
                          background: state.algorithmFavor >= 70 ? 'linear-gradient(135deg, #10b981, #059669)' : 
                                     state.algorithmFavor >= 40 ? 'linear-gradient(135deg, #3b82f6, #2563eb)' : 
                                     'linear-gradient(135deg, #64748b, #475569)'
                        }} />
                      </div>
                      <p style={{ fontWeight: 700, marginTop: '8px' }}>
                        {state.algorithmFavor || 0}/100
                        {state.algorithmFavor >= 70 && ' â€¢ Excellent!'}
                        {state.algorithmFavor >= 40 && state.algorithmFavor < 70 && ' â€¢ Good'}
                        {state.algorithmFavor < 40 && ' â€¢ Building'}
                      </p>
                      <div style={{ fontSize: '0.85em', color: '#64748b', marginTop: '4px' }}>
                        Boosted by: Consistent posting, engagement, playlist placements
                      </div>
                    </div>

                    <div className="card" style={{ marginBottom: '20px' }}>
                      <h3>Streaming Stats</h3>
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '12px' }}>
                        <div>
                          <div style={{ color: '#94a3b8', fontSize: '0.85em' }}>Monthly Listeners</div>
                          <div style={{ fontSize: '1.3em', fontWeight: 'bold', color: '#3b82f6' }}>
                            {(state.monthlyListeners || 0).toLocaleString()}
                          </div>
                        </div>
                        <div>
                          <div style={{ color: '#94a3b8', fontSize: '0.85em' }}>Playlist Placements</div>
                          <div style={{ fontSize: '1.3em', fontWeight: 'bold', color: '#8b5cf6' }}>
                            {(state.playlistPlacements || []).length}
                          </div>
                        </div>
                        <div>
                          <div style={{ color: '#94a3b8', fontSize: '0.85em' }}>Viral Moments</div>
                          <div style={{ fontSize: '1.3em', fontWeight: 'bold', color: '#f59e0b' }}>
                            {(state.viralMoments || []).length}
                          </div>
                        </div>
                      </div>
                    </div>

                    <div className="card">
                      <h3>Create Content</h3>
                      <div className="grid">
                        <div className="mini-card">
                          <h3>TikTok Video</h3>
                          <p>Create a short video. Low cost, high viral potential.</p>
                          <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Cost: $50-150 (quality dependent)</p>
                          <button className="btn" onClick={() => {
                            const cost = 50 + Math.floor(Math.random() * 100);
                            if (state.money < cost) {
                              addLog(`Need $${cost} to create TikTok content.`);
                              return;
                            }
                            advanceWeek(
                              (s) => {
                                const quality = Math.floor(Math.random() * 40) + 40; // 40-80
                                const viralChance = (quality / 100) * (s.algorithmFavor / 100) * 0.15;
                                const wentViral = Math.random() < viralChance;
                                
                                const followerGain = wentViral 
                                  ? Math.floor(500 + Math.random() * 2000)
                                  : Math.floor(10 + Math.random() * 50);
                                
                                const engagementBoost = wentViral ? 0.05 : 0.01;
                                
                                return {
                                  ...s,
                                  money: s.money - cost,
                                  socialMedia: {
                                    ...s.socialMedia,
                                    tiktok: {
                                      followers: (s.socialMedia?.tiktok?.followers || 0) + followerGain,
                                      engagementRate: Math.min(1, (s.socialMedia?.tiktok?.engagementRate || 0) + engagementBoost),
                                      lastPost: s.week
                                    }
                                  },
                                  algorithmFavor: Math.min(100, (s.algorithmFavor || 0) + (wentViral ? 5 : 1)),
                                  viralMoments: wentViral ? [...(s.viralMoments || []), { platform: 'TikTok', week: s.week }] : (s.viralMoments || [])
                                };
                              },
                              `Posted TikTok video. ${Math.random() < 0.15 ? 'WENT VIRAL! +' + Math.floor(500 + Math.random() * 2000) + ' followers!' : 'Gained some followers.'} -$${cost}`
                            );
                          }}>
                            Post TikTok Video
                          </button>
                        </div>

                        <div className="mini-card">
                          <h3>Instagram Post</h3>
                          <p>Visual content for branding and fan engagement.</p>
                          <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Cost: $80-200</p>
                          <button className="btn" onClick={() => {
                            const cost = 80 + Math.floor(Math.random() * 120);
                            if (state.money < cost) {
                              addLog(`Need $${cost} to create Instagram content.`);
                              return;
                            }
                            advanceWeek(
                              (s) => {
                                const followerGain = Math.floor(20 + Math.random() * 80);
                                const engagementBoost = 0.015;
                                
                                return {
                                  ...s,
                                  money: s.money - cost,
                                  socialMedia: {
                                    ...s.socialMedia,
                                    instagram: {
                                      followers: (s.socialMedia?.instagram?.followers || 0) + followerGain,
                                      engagementRate: Math.min(1, (s.socialMedia?.instagram?.engagementRate || 0) + engagementBoost),
                                      lastPost: s.week
                                    }
                                  },
                                  algorithmFavor: Math.min(100, (s.algorithmFavor || 0) + 1)
                                };
                              },
                              `Posted on Instagram. Gained ${Math.floor(20 + Math.random() * 80)} followers. -$${cost}`
                            );
                          }}>
                            Post to Instagram
                          </button>
                        </div>

                        <div className="mini-card">
                          <h3>Twitter/X Post</h3>
                          <p>Direct communication with fans. Can spark controversy.</p>
                          <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Cost: $30-80</p>
                          <button className="btn" onClick={() => {
                            const cost = 30 + Math.floor(Math.random() * 50);
                            if (state.money < cost) {
                              addLog(`Need $${cost} to post on Twitter.`);
                              return;
                            }
                            advanceWeek(
                              (s) => {
                                const controversial = Math.random() < 0.1; // 10% chance
                                const followerGain = controversial 
                                  ? Math.floor(100 + Math.random() * 200) // Controversy = more followers
                                  : Math.floor(10 + Math.random() * 40);
                                
                                const engagementBoost = controversial ? 0.02 : 0.01;
                                
                                return {
                                  ...s,
                                  money: s.money - cost,
                                  socialMedia: {
                                    ...s.socialMedia,
                                    twitter: {
                                      followers: (s.socialMedia?.twitter?.followers || 0) + followerGain,
                                      engagementRate: Math.min(1, (s.socialMedia?.twitter?.engagementRate || 0) + engagementBoost),
                                      lastPost: s.week
                                    }
                                  },
                                  algorithmFavor: Math.min(100, (s.algorithmFavor || 0) + (controversial ? 2 : 1)),
                                  fame: s.fame + (controversial ? 3 : 0) // Controversy can boost fame
                                };
                              },
                              `Posted on Twitter/X. ${Math.random() < 0.1 ? 'Sparked some controversy! Gained attention.' : 'Engaged with fans.'} -$${cost}`
                            );
                          }}>
                            Post to Twitter/X
                          </button>
                        </div>
                      </div>
                    </div>

                    {(state.playlistPlacements || []).length > 0 && (
                      <div className="card">
                        <h3>Recent Playlist Placements</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                          {[...(state.playlistPlacements || [])]
                            .sort((a, b) => (b.week || 0) - (a.week || 0))
                            .slice(0, 5)
                            .map((placement, idx) => (
                              <div key={idx} style={{ 
                                padding: '10px', 
                                background: '#000000', 
                                borderRadius: '6px',
                                border: '1px solid #334155'
                              }}>
                                <div style={{ fontWeight: 'bold' }}>{placement.playlistName}</div>
                                <div style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                                  {placement.type} â€¢ Week {placement.week} â€¢ +{placement.boost}% stream boost
                                </div>
                              </div>
                            ))}
                        </div>
                      </div>
                    )}

                    {(state.viralMoments || []).length > 0 && (
                      <div className="card">
                        <h3>Viral Moments</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                          {[...(state.viralMoments || [])]
                            .sort((a, b) => (b.week || 0) - (a.week || 0))
                            .slice(0, 5)
                            .map((moment, idx) => (
                              <div key={idx} style={{ 
                                padding: '10px', 
                                background: '#064e3b', 
                                borderRadius: '6px',
                                border: '1px solid #10b981'
                              }}>
                                <div style={{ fontWeight: 'bold', color: '#10b981' }}>
                                  <Sparkles size={14} style={{ display: 'inline', marginRight: '4px' }} />
                                  {moment.platform} Viral Moment
                                </div>
                                <div style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                                  Week {moment.week} â€¢ Massive follower boost!
                                </div>
                              </div>
                            ))}
                        </div>
                      </div>
                    )}
                  </div>
                </>
              )}

              {/* GIGS TAB */}
              {currentTab === 'gigs' && (
                <>
                  <div className="card">
                    <h2>Tours & Gigs</h2>
                    <div style={{ display: 'flex', gap: '8px', marginBottom: '16px', borderBottom: '1px solid #334155', paddingBottom: '12px' }}>
                      <button 
                        className="btn" 
                        onClick={() => setGigsView('local')}
                        style={{ 
                          background: gigsView === 'local' ? '#1e40af' : '#334155',
                          opacity: gigsView === 'local' ? 1 : 0.7
                        }}
                      >
                        Local Gigs
                      </button>
                      <button 
                        className="btn" 
                        onClick={() => setGigsView('tours')}
                        style={{ 
                          background: gigsView === 'tours' ? '#1e40af' : '#334155',
                          opacity: gigsView === 'tours' ? 1 : 0.7
                        }}
                      >
                        Tours
                      </button>
                    </div>
                  </div>

                  {gigsView === 'local' && (
                    <>
                      <div className="card">
                        <h2>Book Local Gig</h2>
                    <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Transport: {TRANSPORT_TIERS[state.transportTier || 0]?.name || 'Unknown'} â€¢ Gear: {GEAR_TIERS[state.gearTier || 0]?.name || 'Unknown'}</p>
                    {state.tourBan > 0 && <p style={{ color: '#f97316' }}>Gig booking locked for {state.tourBan} week(s) after a bust.</p>}
                    {availableVenues.length === 0 && <p>No venues yet. Build fame!</p>}
                    {availableVenues.length > 0 && (
                      <>
                        <select
                          value={selectedVenue?.name || ''}
                          onChange={(e) => {
                            const v = availableVenues.find((vn) => vn.name === e.target.value);
                            setSelectedVenue(v || null);
                          }}
                        >
                          {availableVenues.map((v) => {
                            const transport = TRANSPORT_TIERS[state.transportTier || 0] || TRANSPORT_TIERS[0];
                            const gear = GEAR_TIERS[state.gearTier || 0] || GEAR_TIERS[0];
                            const basePay = (v.basePay || 0) + Math.floor((state.fame || 0) * 1.5);
                            const finalPay = Math.floor(basePay * (transport?.gigBonus || 1.0) * (gear?.gigBonus || 1.0));
                            return (
                              <option key={v.name} value={v.name}>
                                {v.name} â€” ${finalPay} ({transport?.name || 'Unknown'} Ã—{(transport?.gigBonus || 1.0).toFixed(2)} Ã— {gear?.name || 'Unknown'} Ã—{(gear?.gigBonus || 1.0).toFixed(2)})
                              </option>
                            );
                          })}
                        </select>
                        <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>
                          <button className="btn" onClick={() => selectedVenue && bookGig(selectedVenue)} disabled={!selectedVenue || state.tourBan > 0} style={{ flex: 1 }}>
                            Play Gig
                          </button>
                          <button className="btn-secondary" onClick={() => setShowTransportModal(true)}>Transport</button>
                          <button className="btn-secondary" onClick={() => setShowGearModal(true)}>Gear</button>
                        </div>
                      </>
                    )}
                  </div>
                  <div className="card">
                    <h2>Available Venues</h2>
                    {availableVenues.length === 0 && <p>No venues yet. Build fame!</p>}
                    <div className="grid">
                      {availableVenues.map((v) => (
                        <div key={v.name} className="mini-card">
                          <h3>{v.name}</h3>
                          <p>{v.size} â€¢ Cap: {v.capacity}</p>
                          <p>Pay: ${v.basePay + Math.floor(state.fame * 2)}</p>
                          <button className="btn" onClick={() => bookGig(v)}>Book Gig</button>
                        </div>
                      ))}
                    </div>
                  </div>
                    </>
                  )}

                  {gigsView === 'tours' && (
                    <>
                      {state.activeTour && (
                        <div className="card" style={{ background: '#064e3b', borderColor: '#10b981' }}>
                          <h2>Active Tour: {TOUR_TYPES.find(t => t.id === state.activeTour.type)?.name}</h2>
                          <p>
                            <strong>{state.activeTour.region}</strong> â€¢ {state.activeTour.cities} cities â€¢ 
                            Week {state.week - state.activeTour.startWeek + 1}/{state.activeTour.duration}
                          </p>
                          <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                            Revenue so far: ${state.activeTour.revenue || 0}
                          </p>
                        </div>
                      )}

                      <div className="card">
                        <h2>Plan Tour</h2>
                        <div className="grid">
                          {TOUR_TYPES.filter(tour => {
                            // Filter by fame requirement
                            if (state.fame < tour.fameReq) return false;
                            // Filter by unlock requirements
                            if (tour.unlockReq) {
                              const rep = state.geographicReputation?.[tour.unlockReq.reputation] || 0;
                              if (rep < tour.unlockReq.value) return false;
                            }
                            return true;
                          }).map((tour) => {
                            const canAfford = state.money >= tour.cost;
                            const isUnlocked = !tour.unlockReq || (state.geographicReputation?.[tour.unlockReq.reputation] || 0) >= tour.unlockReq.value;
                            return (
                              <div key={tour.id} className="mini-card" style={{
                                opacity: canAfford && isUnlocked ? 1 : 0.6,
                                border: selectedTourType === tour.id ? '2px solid #7c3aed' : '1px solid #334155'
                              }}>
                                <h3>{tour.name}</h3>
                                <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>{tour.desc}</p>
                                <div style={{ fontSize: '0.9em', marginTop: '8px' }}>
                                  <div>Cost: <strong>${tour.cost}</strong></div>
                                  <div>Cities: <strong>{tour.cities}</strong></div>
                                  <div>Duration: <strong>{tour.duration} weeks</strong></div>
                                  {!isUnlocked && tour.unlockReq && (
                                    <div style={{ color: '#f59e0b', fontSize: '0.85em', marginTop: '4px' }}>
                                      Need {tour.unlockReq.reputation.toUpperCase()} rep: {tour.unlockReq.value}
                                    </div>
                                  )}
                                  {state.fame < tour.fameReq && (
                                    <div style={{ color: '#f59e0b', fontSize: '0.85em', marginTop: '4px' }}>
                                      Need fame: {tour.fameReq}
                                    </div>
                                  )}
                                </div>
                                <button 
                                  className="btn" 
                                  onClick={() => {
                                    if (tour.id === 'local' || tour.id === 'virtual') {
                                      // Single week tours
                                      startTour(tour, 'us');
                                    } else {
                                      setSelectedTourType(tour.id);
                                    }
                                  }}
                                  disabled={!canAfford || !isUnlocked || state.activeTour !== null || state.fame < tour.fameReq}
                                  style={{ width: '100%', marginTop: '8px' }}
                                >
                                  {tour.id === 'local' || tour.id === 'virtual' ? 'Start Tour' : 'Select Tour'}
                                </button>
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      {selectedTourType && selectedTourType !== 'local' && selectedTourType !== 'virtual' && (
                        <div className="card">
                          <h2>Select Region</h2>
                          <div className="grid">
                            {GEOGRAPHIC_REGIONS.filter(region => {
                              const tour = TOUR_TYPES.find(t => t.id === selectedTourType);
                              if (!tour?.unlockReq) return true;
                              return (state.geographicReputation?.[region.id] || 0) >= tour.unlockReq.value || region.id === 'us';
                            }).map((region) => {
                              const rep = state.geographicReputation?.[region.id] || 0;
                              const tour = TOUR_TYPES.find(t => t.id === selectedTourType);
                              const estimatedRevenue = Math.floor(tour.cost * 1.5 + (rep * tour.cities * 50));
                              return (
                                <div key={region.id} className="mini-card" style={{
                                  border: selectedTourRegion === region.id ? '2px solid #3b82f6' : '1px solid #334155'
                                }}>
                                  <h3>{region.name}</h3>
                                  <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                                    Reputation: <strong>{rep}</strong>
                                  </p>
                                  <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                                    Est. Revenue: <strong>${estimatedRevenue}</strong>
                                  </p>
                                  <button 
                                    className="btn" 
                                    onClick={() => {
                                      startTour(tour, region.id);
                                      setSelectedTourType(null);
                                      setSelectedTourRegion('us');
                                    }}
                                    style={{ width: '100%', marginTop: '8px' }}
                                  >
                                    Start {tour.name} in {region.name}
                                  </button>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      <div className="card">
                        <h2>Geographic Reputation</h2>
                        <div className="grid">
                          {GEOGRAPHIC_REGIONS.map((region) => {
                            const rep = state.geographicReputation?.[region.id] || 0;
                            return (
                              <div key={region.id} className="mini-card">
                                <h3>{region.name}</h3>
                                <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: '#3b82f6', marginTop: '8px' }}>
                                  {rep}
                                </div>
                                <div style={{ fontSize: '0.85em', color: '#64748b', marginTop: '4px' }}>
                                  {rep < 20 && 'Unknown'}
                                  {rep >= 20 && rep < 50 && 'Building'}
                                  {rep >= 50 && rep < 80 && 'Established'}
                                  {rep >= 80 && 'Major'}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      {(state.tourHistory || []).length > 0 && (
                        <div className="card">
                          <h2>Tour History</h2>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            {[...(state.tourHistory || [])]
                              .sort((a, b) => (b.completedWeek || 0) - (a.completedWeek || 0))
                              .slice(0, 5)
                              .map((tour, idx) => (
                                <div key={idx} style={{ 
                                  padding: '10px', 
                                  background: '#000000', 
                                  borderRadius: '6px',
                                  border: '1px solid #334155'
                                }}>
                                  <div style={{ fontWeight: 'bold' }}>{tour.name}</div>
                                  <div style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                                    {GEOGRAPHIC_REGIONS.find(r => r.id === tour.region)?.name || tour.region} â€¢ {tour.cities} cities â€¢ Revenue: ${tour.revenue || 0} â€¢ Completed week {tour.completedWeek || 0}
                                  </div>
                                </div>
                              ))}
                          </div>
                        </div>
                      )}
                    </>
                  )}
                </>
              )}

              {/* UPGRADES TAB */}
              {currentTab === 'upgrades' && (
                <div className="card">
                  <h2>Upgrade Summary</h2>
                  <p style={{ color: '#94a3b8', marginBottom: '20px' }}>Click any category to open the upgrade shop.</p>
                  <div className="grid">
                    <button 
                      className="mini-card"
                      onClick={() => setShowStudioModal(true)}
                      style={{ cursor: 'pointer', border: '2px solid #10b981', background: '#064e3b' }}
                    >
                      <h3>ðŸŽ™ï¸ Recording Studios</h3>
                      <p><strong>Current:</strong> {STUDIO_TIERS[state.studioTier].name}</p>
                      <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Quality +{STUDIO_TIERS[state.studioTier].qualityBonus}% â€¢ Record cost ${STUDIO_TIERS[state.studioTier].recordCost}</p>
                    </button>
                    <button 
                      className="mini-card"
                      onClick={() => setShowTransportModal(true)}
                      style={{ cursor: 'pointer', border: '2px solid #3b82f6', background: '#1e3a8a' }}
                    >
                      <h3>ðŸš Transportation</h3>
                      <p><strong>Current:</strong> {TRANSPORT_TIERS[state.transportTier].name}</p>
                      <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Earnings Ã—{TRANSPORT_TIERS[state.transportTier].gigBonus.toFixed(2)} â€¢ Capacity Ã—{TRANSPORT_TIERS[state.transportTier].venueMult.toFixed(2)}</p>
                    </button>
                    <button 
                      className="mini-card"
                      onClick={() => setShowGearModal(true)}
                      style={{ cursor: 'pointer', border: '2px solid #a855f7', background: '#581c87' }}
                    >
                      <h3>ðŸŽ¸ Equipment & Gear</h3>
                      <p><strong>Current:</strong> {GEAR_TIERS[state.gearTier].name}</p>
                      <p style={{ fontSize: '0.85em', color: '#94a3b8' }}>Quality +{GEAR_TIERS[state.gearTier].qualityBonus}% â€¢ Earnings Ã—{GEAR_TIERS[state.gearTier].gigBonus.toFixed(2)}</p>
                    </button>
                  </div>
                </div>
              )}

              {/* ANALYTICS TAB */}
              {currentTab === 'analytics' && (
                <>
                  <div className="card" style={{ marginBottom: '16px' }}>
                    <h2>Revenue Breakdown</h2>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '12px' }}>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                        <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Total Revenue</div>
                        <div style={{ fontSize: '1.5em', fontWeight: 'bold' }}>${(state.totalRevenue || 0).toLocaleString()}</div>
                      </div>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                        <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Streaming Revenue</div>
                        <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
                          ${((state.songs || []).reduce((sum, s) => sum + (s.earnings || 0), 0) + 
                              (state.albums || []).reduce((sum, a) => {
                                const albumStreams = Math.floor((a.quality || 0) * 150 + (a.popularity || 0) * 80) * Math.max(0.3, 1 - (a.age || 0) * 0.02);
                                return sum + Math.floor(albumStreams * 0.004);
                              }, 0)).toLocaleString()}
                        </div>
                      </div>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                        <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Merchandise</div>
                        <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>${(state.totalMerchandise || 0).toLocaleString()}</div>
                      </div>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                        <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Tour Revenue</div>
                        <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
                          ${((state.tourHistory || []).reduce((sum, t) => sum + (t.revenue || 0), 0)).toLocaleString()}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="card" style={{ marginBottom: '16px' }}>
                    <h2>Streaming Analytics</h2>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '12px' }}>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                        <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Total Streams</div>
                        <div style={{ fontSize: '1.3em', fontWeight: 'bold' }}>
                          {((state.songs || []).reduce((sum, s) => sum + (s.streams || 0), 0) + 
                            (state.albums || []).reduce((sum, a) => {
                              const albumStreams = Math.floor((a.quality || 0) * 150 + (a.popularity || 0) * 80) * Math.max(0.3, 1 - (a.age || 0) * 0.02);
                              return sum + albumStreams;
                            }, 0)).toLocaleString()}
                        </div>
                        <div style={{ fontSize: '0.75em', color: '#64748b', marginTop: '4px' }}>
                          Weekly: {((state.songs || []).reduce((sum, s) => sum + (s.weeklyStreams || 0), 0)).toLocaleString()}
                        </div>
                      </div>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                        <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Monthly Listeners</div>
                        <div style={{ fontSize: '1.3em', fontWeight: 'bold' }}>{(state.monthlyListeners || 0).toLocaleString()}</div>
                      </div>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                        <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Top Song Streams</div>
                        <div style={{ fontSize: '1.1em', fontWeight: 'bold' }}>
                          {state.songs.length > 0 ? [...state.songs].sort((a,b) => (b.streams || 0) - (a.streams || 0))[0].title : 'N/A'}
                        </div>
                        <div style={{ fontSize: '0.9em', color: '#64748b', marginTop: '4px' }}>
                          {state.songs.length > 0 ? [...state.songs].sort((a,b) => (b.streams || 0) - (a.streams || 0))[0].streams.toLocaleString() : 0} streams
                        </div>
                      </div>
                      <div style={{ padding: '12px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                        <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Playlist Placements</div>
                        <div style={{ fontSize: '1.3em', fontWeight: 'bold' }}>{(state.playlistPlacements || []).length}</div>
                        <div style={{ fontSize: '0.75em', color: '#64748b', marginTop: '4px' }}>
                          {state.playlistPlacements && state.playlistPlacements.length > 0 && 
                            state.playlistPlacements[state.playlistPlacements.length - 1].playlistName}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="card">
                    <h2>Career Timeline</h2>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                      {state.albums && state.albums.length > 0 && (
                        <div style={{ padding: '10px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                          <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>ðŸ“€ Albums Released: {state.albums.length}</div>
                          <div style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                            Latest: {state.albums.sort((a,b) => (b.week || 0) - (a.week || 0))[0]?.name || 'N/A'}
                          </div>
                        </div>
                      )}
                      {state.tourHistory && state.tourHistory.length > 0 && (
                        <div style={{ padding: '10px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                          <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>ðŸŽ¤ Tours Completed: {state.tourHistory.length}</div>
                          <div style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                            Latest: {state.tourHistory[state.tourHistory.length - 1]?.name || 'N/A'}
                          </div>
                        </div>
                      )}
                      {state.industryEvents && state.industryEvents.length > 0 && (
                        <div style={{ padding: '10px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                          <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>ðŸ† Industry Events: {state.industryEvents.length}</div>
                          <div style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                            Awards Won: {state.industryEvents.filter(e => e.type === 'win').length}
                          </div>
                        </div>
                      )}
                      {state.achievements && state.achievements.length > 0 && (
                        <div style={{ padding: '10px', background: '#000000', borderRadius: '6px', border: '1px solid #334155' }}>
                          <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>â­ Achievements: {state.achievements.length}</div>
                          <div style={{ fontSize: '0.85em', color: '#94a3b8' }}>
                            Latest: {state.achievements.sort((a,b) => (b.week || 0) - (a.week || 0))[0]?.name || 'N/A'}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </>
              )}

              {/* LOG TAB */}
              {currentTab === 'log' && (
                <>
                  {currentEvent && (
                    <div className="card">
                      <h2 style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        {currentEvent.titleIcon && React.createElement(currentEvent.titleIcon, { size: 24, color: '#f59e0b' })}
                        Ongoing Event: {currentEvent.title}
                      </h2>
                      <p>{currentEvent.description}</p>
                      <div className="grid">
                        {currentEvent.choices.map((c, idx) => (
                          <div key={idx} className="mini-card">
                            <p><strong>{c.text}</strong></p>
                            <p>Money {c.money || 0} â€¢ Morale {c.morale || 0} â€¢ Fame {c.fame || 0}</p>
                            <button className="btn" onClick={() => resolveEvent(c)}>Choose</button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  <div className="card">
                    <h2>Recent Activity</h2>
                    {state.log.length === 0 && <p>No events yet.</p>}
                    <ul style={{ listStyle: 'none', padding: 0 }}>
                      {state.log.map((entry, idx) => {
                        const logItem = typeof entry === 'string' ? entry : entry.text || entry;
                        return (
                          <li 
                            key={idx}
                            style={{
                              padding: '12px',
                              marginBottom: '8px',
                              backgroundColor: '#0f172a',
                              borderLeft: '3px solid #3b82f6',
                              borderRadius: '4px',
                              fontSize: '0.9em',
                              lineHeight: '1.5',
                              color: '#e2e8f0'
                            }}
                          >
                            {logItem}
                          </li>
                        );
                      })}
                    </ul>
                  </div>
                </>
              )}

              {recruitOptions.length > 0 && (
                <div className="card">
                  <h2>Audition Candidates</h2>
                  <div className="grid">
                    {recruitOptions.map((c) => (
                      <div key={c.id} className="mini-card">
                        <div className="member-top" style={{ marginBottom: 6 }}>
                          <div className="instrument-icon">{renderInstrumentIcon(c.role)}</div>
                          <div>
                            <div className="member-name">{memberDisplayName(c)}</div>
                            <div className="member-role">{ROLE_OPTIONS.find((r) => r.key === c.role)?.label || c.role}</div>
                          </div>
                        </div>
                        {renderRadar(c.stats)}
                        <button className="btn" style={{ marginTop: 6 }} onClick={() => hireCandidate(c)}>
                          Hire
                        </button>
                      </div>
                    ))}
                  </div>
                  <button className="btn" style={{ marginTop: 8 }} onClick={skipRecruit}>Skip for now</button>
                </div>
              )}
            </div>

            <aside className="sidebar sidebar-right">
              {/* Right Sidebar Tabs */}
              <div style={{ display: 'flex', gap: '4px', marginBottom: '12px', flexWrap: 'wrap' }}>
                {[
                  { id: 'topChart', label: 'Top 20', icon: TrendingUp },
                  { id: 'albums', label: 'Albums', icon: Music },
                  { id: 'songChart', label: 'Songs', icon: ListMusic }
                ].map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setRightTab(tab.id)}
                    style={{
                      flex: 1,
                      minWidth: '70px',
                      padding: '6px 8px',
                      border: 'none',
                      background: rightTab === tab.id ? '#1e40af' : '#334155',
                      color: '#fff',
                      cursor: 'pointer',
                      borderRadius: '4px',
                      fontSize: '0.75em',
                      fontWeight: rightTab === tab.id ? 'bold' : 'normal',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '4px'
                    }}
                  >
                    <tab.icon size={12} />
                    {tab.label}
                  </button>
                ))}
              </div>
              
              {/* TOP CHART TAB */}
              {rightTab === 'topChart' && (
                <div className="card">
                  <h2>Top 20 Chart</h2>
                  <ol className="chart-list">
                    {chartLeaders.map((b) => {
                      const logoStyle = getBandLogoStyle(b.name, fontOptions);
                      return (
                        <li 
                          key={b.name} 
                          className={`chart-row ${b.isPlayer ? 'active' : ''}`}
                          onClick={() => setSelectedBandStats(b)}
                          style={{ cursor: 'pointer' }}
                        >
                          <div className="chart-line" style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-start', gap: '6px', width: '100%' }}>
                            <span className="chart-rank" style={{ fontSize: '0.85em', marginBottom: '4px' }}>#{b.position}</span>
                            <span 
                              style={{
                                ...logoStyle,
                                border: b.isPlayer ? '2px solid #3b82f6' : 'none',
                                transition: 'opacity 0.2s',
                                width: '100%',
                                maxWidth: 'calc(100% - 8px)' // Prevent overflow with padding
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.opacity = '0.8';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.opacity = '1';
                              }}
                              title={b.name} // Show full name on hover if truncated
                            >
                              {b.name}
                            </span>
                        </div>
                      </li>
                      );
                    })}
                  </ol>
                </div>
              )}
              
              {/* ALBUM CHART TAB */}
              {rightTab === 'albums' && (
                <div className="card">
                  <h2>Album Chart</h2>
                  {albumChart.length === 0 && <p>No albums yet.</p>}
                  {albumChart.length > 0 && (
                    <ol className="chart-list">
                      {albumChart.map((a) => (
                        <li key={a.name + (a.week || 0) + a.bandName} className={`chart-row ${a.isPlayer ? 'active' : ''}`}>
                          <div className="chart-line">
                            <span className="chart-rank">#{a.position}</span>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                            <span className="chart-name">{a.name}</span>
                              <span style={{ fontSize: '0.75em', color: '#64748b' }}>by {a.bandName}</span>
                          </div>
                          </div>
                          <span className="chart-meta">
                            Score {a.chartScore || 0} â€¢ Q{a.quality || 0} â€¢ Pop {a.popularity || 0} â€¢ {a.totalStreams ? `${(a.totalStreams / 1000).toFixed(1)}k streams/wk` : '0 streams'} â€¢ Age {a.age || 0}w
                          </span>
                        </li>
                      ))}
                    </ol>
                  )}
                </div>
              )}
              
              {/* SONG CHART TAB */}
              {rightTab === 'songChart' && (
                <div className="card">
                  <h2>Song Chart</h2>
                  {songChart.length === 0 && <p>No tracks released yet.</p>}
                  {songChart.length > 0 && (
                    <ol className="chart-list">
                      {songChart.map((s) => (
                        <li key={s.title + s.bandName} className={`chart-row ${s.isPlayer ? 'active' : ''}`}>
                            <div className="chart-line">
                            <span className="chart-rank">#{s.position}</span>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                              <span className="chart-name">{s.title}</span>
                              <span style={{ fontSize: '0.75em', color: '#64748b' }}>by {s.bandName}</span>
                            </div>
                            </div>
                            <span className="chart-meta">
                            Pop {s.popularity || 0} â€¢ Q{s.quality || 0} â€¢ {s.weeklyStreams ? `${(s.weeklyStreams / 1000).toFixed(1)}k` : '0'} streams/wk â€¢ Age {s.age || 0}w
                            </span>
                          </li>
                        ))}
                    </ol>
                  )}
                </div>
              )}
            </aside>
          </div>
        </section>
      )}

      {/* Studio Upgrade Modal */}
      {showStudioModal && (
        <div className="modal-overlay" onClick={() => setShowStudioModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '700px' }}>
            <h2 style={{ marginBottom: '12px' }}>Recording Studios</h2>
            <p style={{ marginBottom: '20px', color: '#94a3b8' }}>Upgrade your studio to record higher quality songs with better bonuses.</p>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px' }}>
              {STUDIO_TIERS.map((studio) => (
                <div 
                  key={studio.id}
                  className="mini-card"
                  style={{
                    border: state.studioTier === studio.id ? '2px solid #10b981' : '1px solid #334155',
                    backgroundColor: state.studioTier === studio.id ? '#064e3b' : '#1e293b',
                    position: 'relative'
                  }}
                >
                  {state.studioTier === studio.id && (
                    <div style={{ 
                      position: 'absolute', 
                      top: '8px', 
                      right: '8px', 
                      backgroundColor: '#10b981',
                      color: '#fff',
                      padding: '2px 8px',
                      borderRadius: '4px',
                      fontSize: '0.75em',
                      fontWeight: 'bold'
                    }}>
                      OWNED
                    </div>
                  )}
                  <h3 style={{ fontSize: '1.1em', marginBottom: '8px' }}>{studio.name}</h3>
                  <p style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '12px' }}>{studio.desc}</p>
                  
                  <div style={{ fontSize: '0.9em', marginBottom: '12px' }}>
                    <div style={{ marginBottom: '4px' }}>ðŸ’¿ Record Cost: <strong>${studio.recordCost}</strong></div>
                    {studio.qualityBonus > 0 && <div style={{ marginBottom: '4px', color: '#10b981' }}>âœ¨ Quality: <strong>+{studio.qualityBonus}%</strong></div>}
                    {studio.popBonus > 0 && <div style={{ marginBottom: '4px', color: '#3b82f6' }}>ðŸ“ˆ Popularity: <strong>+{studio.popBonus}</strong></div>}
                    {studio.freshnessBonus > 0 && <div style={{ color: '#a855f7' }}>ðŸŽµ Freshness: <strong>+{studio.freshnessBonus * 10}</strong></div>}
                  </div>

                  {studio.id === 0 ? (
                    <div style={{ textAlign: 'center', color: '#64748b', fontSize: '0.9em' }}>Starting studio</div>
                  ) : state.studioTier >= studio.id ? (
                    <div style={{ textAlign: 'center', color: '#10b981', fontSize: '0.9em', fontWeight: 'bold' }}>Unlocked âœ“</div>
                  ) : (
                    <button 
                      className="btn"
                      onClick={() => upgradeStudio(studio.id)}
                      disabled={state.money < studio.cost}
                      style={{ width: '100%' }}
                    >
                      Upgrade ${studio.cost}
                      {state.money < studio.cost && ' (Need more $)'}
                    </button>
                  )}
                </div>
              ))}
            </div>
            <button 
              className="btn-secondary" 
              onClick={() => setShowStudioModal(false)}
              style={{ marginTop: '20px', width: '100%' }}
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Transport Upgrade Modal */}
      {showTransportModal && (
        <div className="modal-overlay" onClick={() => setShowTransportModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '700px' }}>
            <h2 style={{ marginBottom: '12px' }}>Transportation Fleet</h2>
            <p style={{ marginBottom: '20px', color: '#94a3b8' }}>Upgrade your transport to increase gig earnings and unlock better venues.</p>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px' }}>
              {TRANSPORT_TIERS.map((transport) => (
                <div 
                  key={transport.id}
                  className="mini-card"
                  style={{
                    border: state.transportTier === transport.id ? '2px solid #3b82f6' : '1px solid #334155',
                    backgroundColor: state.transportTier === transport.id ? '#1e3a8a' : '#1e293b',
                    position: 'relative'
                  }}
                >
                  {state.transportTier === transport.id && (
                    <div style={{ 
                      position: 'absolute', 
                      top: '8px', 
                      right: '8px', 
                      backgroundColor: '#3b82f6',
                      color: '#fff',
                      padding: '2px 8px',
                      borderRadius: '4px',
                      fontSize: '0.75em',
                      fontWeight: 'bold'
                    }}>
                      IN USE
                    </div>
                  )}
                  <h3 style={{ fontSize: '1.1em', marginBottom: '8px' }}>ðŸš {transport.name}</h3>
                  <p style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '12px' }}>{transport.desc}</p>
                  
                  <div style={{ fontSize: '0.9em', marginBottom: '12px' }}>
                    {transport.id > 0 && <div style={{ marginBottom: '4px' }}>ðŸ’° Cost: <strong>${transport.cost}</strong></div>}
                    <div style={{ marginBottom: '4px', color: '#f59e0b' }}>ðŸ’µ Gig Earnings: <strong>Ã—{transport.gigBonus.toFixed(2)}</strong></div>
                    <div style={{ color: '#8b5cf6' }}>ðŸŽª Venue Capacity: <strong>Ã—{transport.venueMult.toFixed(2)}</strong></div>
                  </div>

                  {transport.id === 0 ? (
                    <div style={{ textAlign: 'center', color: '#64748b', fontSize: '0.9em' }}>Starting option</div>
                  ) : state.transportTier >= transport.id ? (
                    <div style={{ textAlign: 'center', color: '#3b82f6', fontSize: '0.9em', fontWeight: 'bold' }}>Owned âœ“</div>
                  ) : (
                    <button 
                      className="btn"
                      onClick={() => upgradeTransport(transport.id)}
                      disabled={state.money < transport.cost}
                      style={{ width: '100%' }}
                    >
                      Upgrade ${transport.cost}
                      {state.money < transport.cost && ' (Need more $)'}
                    </button>
                  )}
                </div>
              ))}
            </div>
            <p style={{ fontSize: '0.85em', color: '#94a3b8', marginTop: '16px' }}>ðŸ’¡ Better transport multiplies gig earnings and allows access to bigger venues with higher capacity rewards.</p>
            <button 
              className="btn-secondary" 
              onClick={() => setShowTransportModal(false)}
              style={{ marginTop: '20px', width: '100%' }}
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Write Song Modal */}
      <WriteSongModal
        isOpen={showWriteSongModal}
        onClose={() => {
          setShowWriteSongModal(false);
          setNewSongTitle('');
        }}
        onRecord={(title) => {
          writeSong(title);
          setShowWriteSongModal(false);
          setNewSongTitle('');
        }}
        studioTier={state.studioTier}
        difficulty={state.difficulty}
        defaultTitle={newSongTitle}
        addLog={addLog}
      />

      {/* Album Builder Modal */}
      <AlbumBuilderModal
        isOpen={showAlbumBuilderModal}
        onClose={() => {
          setShowAlbumBuilderModal(false);
        }}
        onRecordAlbum={(selectedTitles) => {
          recordAlbum(selectedTitles);
          setShowAlbumBuilderModal(false);
        }}
        songs={state.songs}
        studioTier={state.studioTier}
        difficulty={state.difficulty}
      />

      {/* Label Negotiation Modal */}
      {showLabelNegotiation && labelOffer && (
        <div className="modal-overlay" onClick={() => {
          setShowLabelNegotiation(false);
          setLabelOffer(null);
          setNegotiationStep('offer');
        }}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '700px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
              <h2 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '8px' }}>
                <Building2 size={24} /> Label Deal from {labelOffer.name}
              </h2>
              <button 
                onClick={() => {
                  setShowLabelNegotiation(false);
                  setLabelOffer(null);
                  setNegotiationStep('offer');
                }}
                style={{ background: 'none', border: 'none', color: '#94a3b8', cursor: 'pointer', padding: '4px' }}
              >
                <X size={20} />
              </button>
            </div>

            <div style={{ 
              padding: '16px', 
              background: '#064e3b', 
              borderRadius: '8px', 
              border: '1px solid #10b981',
              marginBottom: '20px'
            }}>
              <p style={{ margin: 0, color: '#e2e8f0', fontSize: '0.95em' }}>
                <strong>{labelOffer.name}</strong> is offering you a <strong>{labelOffer.name.includes('Independent') ? 'Distribution' : labelOffer.type}</strong> deal. Review the terms below.
              </p>
            </div>

            <div style={{ marginBottom: '20px' }}>
              <h3 style={{ marginBottom: '12px', fontSize: '1.1em' }}>Contract Terms</h3>
              <div style={{ display: 'grid', gap: '12px' }}>
                <div style={{ 
                  padding: '12px', 
                  background: '#000000', 
                  borderRadius: '8px',
                  border: '1px solid #334155'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                    <span style={{ color: '#94a3b8' }}>ðŸ’° Advance</span>
                    <strong style={{ color: '#10b981', fontSize: '1.1em' }}>${labelOffer.advance.toLocaleString()}</strong>
                  </div>
                  <div style={{ fontSize: '0.85em', color: '#64748b' }}>One-time payment upon signing</div>
                </div>

                <div style={{ 
                  padding: '12px', 
                  background: '#000000', 
                  borderRadius: '8px',
                  border: '1px solid #334155'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                    <span style={{ color: '#94a3b8' }}>ðŸ’µ Royalty Split</span>
                    <strong style={{ color: labelOffer.royaltySplit > 30 ? '#ef4444' : labelOffer.royaltySplit > 15 ? '#f59e0b' : '#10b981' }}>
                      {labelOffer.royaltySplit}% to label, {100 - labelOffer.royaltySplit}% to you
                    </strong>
                  </div>
                  <div style={{ fontSize: '0.85em', color: '#64748b' }}>Applied to all streaming and sales revenue</div>
                </div>

                <div style={{ 
                  padding: '12px', 
                  background: '#000000', 
                  borderRadius: '8px',
                  border: '1px solid #334155'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                    <span style={{ color: '#94a3b8' }}>ðŸ“… Contract Length</span>
                    <strong>{labelOffer.contractLength} weeks ({Math.floor(labelOffer.contractLength / 52)} year{Math.floor(labelOffer.contractLength / 52) > 1 ? 's' : ''})</strong>
                  </div>
                </div>

                <div style={{ 
                  padding: '12px', 
                  background: '#000000', 
                  borderRadius: '8px',
                  border: '1px solid #334155'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                    <span style={{ color: '#94a3b8' }}>ðŸ“¢ Marketing Budget</span>
                    <strong style={{ color: '#3b82f6' }}>${labelOffer.marketingBudget}/week</strong>
                  </div>
                  <div style={{ fontSize: '0.85em', color: '#64748b' }}>Label promotes your music each week</div>
                </div>
              </div>
            </div>

            <div style={{ marginBottom: '20px' }}>
              <h3 style={{ marginBottom: '12px', fontSize: '1.1em' }}>Benefits</h3>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {labelOffer.benefits?.map((benefit, idx) => (
                  <div key={idx} style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px',
                    padding: '8px',
                    background: '#000000',
                    borderRadius: '6px'
                  }}>
                    <CheckCircle size={16} color="#10b981" />
                    <span style={{ fontSize: '0.9em' }}>{benefit}</span>
                  </div>
                ))}
                {labelOffer.playlistPitch && (
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px',
                    padding: '8px',
                    background: '#000000',
                    borderRadius: '6px'
                  }}>
                    <CheckCircle size={16} color="#10b981" />
                    <span style={{ fontSize: '0.9em' }}>Playlist pitch opportunities</span>
                  </div>
                )}
                {labelOffer.syncLicensing && (
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px',
                    padding: '8px',
                    background: '#000000',
                    borderRadius: '6px'
                  }}>
                    <CheckCircle size={16} color="#10b981" />
                    <span style={{ fontSize: '0.9em' }}>Sync licensing opportunities (TV/film/games)</span>
                  </div>
                )}
                {labelOffer.radioPromo && (
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px',
                    padding: '8px',
                    background: '#000000',
                    borderRadius: '6px'
                  }}>
                    <CheckCircle size={16} color="#10b981" />
                    <span style={{ fontSize: '0.9em' }}>Radio promotion support</span>
                  </div>
                )}
              </div>
            </div>

            {labelOffer.type !== 'independent' && (
              <div style={{ 
                padding: '12px', 
                                background: '#000000',
                borderRadius: '8px',
                border: '1px solid #475569',
                marginBottom: '20px'
              }}>
                <strong style={{ color: '#f59e0b' }}>Contract Obligations:</strong>
                <div style={{ marginTop: '8px', fontSize: '0.9em', color: '#94a3b8' }}>
                  <div>â€¢ Deliver {Math.floor(labelOffer.contractLength / 26)} album(s) during contract</div>
                  <div>â€¢ Complete {Math.floor(labelOffer.contractLength / 52)} tour(s) during contract</div>
                  <div style={{ marginTop: '4px', fontSize: '0.85em', color: '#64748b' }}>
                    Failure to meet obligations may result in contract termination or penalties.
                  </div>
                </div>
              </div>
            )}

            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
              <button 
                className="btn-secondary"
                onClick={() => {
                  setShowLabelNegotiation(false);
                  setLabelOffer(null);
                  setNegotiationStep('offer');
                  addLog('Declined label offer. Staying independent.');
                }}
              >
                Decline
              </button>
              {negotiationStep === 'offer' && (
                <button 
                  className="btn-secondary"
                  onClick={counterOffer}
                  style={{ background: 'linear-gradient(135deg, #f59e0b, #ef4444)' }}
                >
                  Counter-Offer
                </button>
              )}
              {(negotiationStep === 'offer' || negotiationStep === 'accept' || negotiationStep === 'final') && (
                <button 
                  className="btn"
                  onClick={() => signLabelDeal(labelOffer)}
                >
                  {negotiationStep === 'final' ? 'Accept Final Offer' : 'Sign Deal'}
                </button>
              )}
            </div>

            {negotiationStep === 'accept' && (
              <div style={{ 
                marginTop: '16px', 
                padding: '12px', 
                background: '#064e3b', 
                borderRadius: '8px',
                border: '1px solid #10b981',
                textAlign: 'center',
                color: '#10b981',
                fontSize: '0.9em'
              }}>
                âœ“ Label accepted your counter-offer! Improved terms secured.
              </div>
            )}
            {negotiationStep === 'final' && (
              <div style={{ 
                marginTop: '16px', 
                padding: '12px', 
                background: '#7c2d12', 
                borderRadius: '8px',
                border: '1px solid #f59e0b',
                textAlign: 'center',
                color: '#f59e0b',
                fontSize: '0.9em'
              }}>
                This is the label's final offer. Take it or leave it.
              </div>
            )}
          </div>
        </div>
      )}

      {/* Band Stats Modal */}
      <BandStatsModal
        isOpen={!!selectedBandStats}
        onClose={() => setSelectedBandStats(null)}
        bandStats={selectedBandStats}
        fontOptions={fontOptions}
      />

      {/* Gear Upgrade Modal */}
      {showGearModal && (
        <div className="modal-overlay" onClick={() => setShowGearModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '700px' }}>
            <h2 style={{ marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
              <Guitar size={24} /> Equipment & Gear
            </h2>
            <p style={{ marginBottom: '20px', color: '#94a3b8' }}>Upgrade your instruments and sound system to improve recordings and gig earnings.</p>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px' }}>
              {GEAR_TIERS.map((gear) => {
                const GearIcon = gear.icon;
                return (
                  <div 
                    key={gear.id}
                    className="mini-card"
                    style={{
                      border: state.gearTier === gear.id ? '2px solid #a855f7' : '1px solid #334155',
                      backgroundColor: state.gearTier === gear.id ? '#581c87' : '#1e293b',
                      position: 'relative'
                    }}
                  >
                    {state.gearTier === gear.id && (
                      <div style={{ 
                        position: 'absolute', 
                        top: '8px', 
                        right: '8px', 
                        backgroundColor: '#a855f7',
                        color: '#fff',
                        padding: '2px 8px',
                        borderRadius: '4px',
                        fontSize: '0.75em',
                        fontWeight: 'bold'
                      }}>
                        EQUIPPED
                      </div>
                    )}
                    <h3 style={{ fontSize: '1.1em', marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                      <GearIcon size={18} /> {gear.name}
                    </h3>
                    <p style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '12px' }}>{gear.desc}</p>
                    
                    <div style={{ fontSize: '0.9em', marginBottom: '12px' }}>
                      {gear.id > 0 && <div style={{ marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '4px' }}><DollarSign size={14} /> Cost: <strong>${gear.cost}</strong></div>}
                      {gear.qualityBonus > 0 && <div style={{ marginBottom: '4px', color: '#10b981', display: 'flex', alignItems: 'center', gap: '4px' }}><Gem size={14} /> Quality: <strong>+{gear.qualityBonus}%</strong></div>}
                      {gear.soundBonus > 0 && <div style={{ marginBottom: '4px', color: '#f59e0b', display: 'flex', alignItems: 'center', gap: '4px' }}><Radio size={14} /> Sound: <strong>+{gear.soundBonus}%</strong></div>}
                      <div style={{ color: '#8b5cf6', display: 'flex', alignItems: 'center', gap: '4px' }}><TrendingUp size={14} /> Gig Earnings: <strong>Ã—{gear.gigBonus.toFixed(2)}</strong></div>
                    </div>

                    {gear.id === 0 ? (
                      <div style={{ textAlign: 'center', color: '#64748b', fontSize: '0.9em' }}>Starting gear</div>
                    ) : state.gearTier >= gear.id ? (
                      <div style={{ textAlign: 'center', color: '#a855f7', fontSize: '0.9em', fontWeight: 'bold' }}>Owned âœ“</div>
                    ) : (
                      <button 
                        className="btn"
                        onClick={() => upgradeGear(gear.id)}
                        disabled={state.money < gear.cost}
                        style={{ width: '100%' }}
                      >
                        Upgrade ${gear.cost}
                        {state.money < gear.cost && ' (Need more $)'}
                      </button>
                    )}
                  </div>
                );
              })}
            </div>
            <p style={{ fontSize: '0.85em', color: '#94a3b8', marginTop: '16px' }}>ðŸ’¡ Better gear increases the quality of your recordings and directly multiplies gig earnings. Invest wisely!</p>
            <button 
              className="btn-secondary" 
              onClick={() => setShowGearModal(false)}
              style={{ marginTop: '20px', width: '100%' }}
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Save Game Modal */}
      <SaveModal
        isOpen={showSaveModal}
        onClose={() => setShowSaveModal(false)}
        onSave={(name) => {
          saveGame(name);
          setShowSaveModal(false);
        }}
        onDelete={deleteSave}
        saveSlots={saveSlots}
        autoSaveEnabled={autoSaveEnabled}
        onToggleAutoSave={(enabled) => {
          setAutoSaveEnabled(enabled);
          localStorage.setItem('bandManager_autoSave', enabled.toString());
        }}
      />

      {/* Load Game Modal */}
      <LoadModal
        isOpen={showLoadModal}
        onClose={() => setShowLoadModal(false)}
        onLoad={(name) => {
          loadGame(name);
          setShowLoadModal(false);
        }}
        saveSlots={saveSlots}
      />

      {/* Settings Modal */}
      {showSettings && (
        <div className="modal-overlay" onClick={() => setShowSettings(false)}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
              <h2>Settings</h2>
              <button className="btn-secondary" onClick={() => setShowSettings(false)}>âœ•</button>
            </div>
            
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              <div className="card">
                <h3>Game Settings</h3>
                <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                  <input
                    type="checkbox"
                    checked={autoSaveEnabled}
                    onChange={(e) => {
                      setAutoSaveEnabled(e.target.checked);
                      localStorage.setItem('bandManager_autoSave', e.target.checked.toString());
                    }}
                  />
                  Enable Auto-Save
                </label>
                <p style={{ fontSize: '0.85em', color: '#94a3b8', marginTop: '8px' }}>
                  Automatically saves your game each week
                </p>
              </div>

              <div className="card">
                <h3>Keyboard Shortcuts</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', fontSize: '0.9em' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span><kbd>Ctrl</kbd> + <kbd>S</kbd></span>
                    <span style={{ color: '#94a3b8' }}>Save game</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span><kbd>Ctrl</kbd> + <kbd>L</kbd></span>
                    <span style={{ color: '#94a3b8' }}>Load game</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span><kbd>1</kbd> - <kbd>7</kbd></span>
                    <span style={{ color: '#94a3b8' }}>Switch tabs</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span><kbd>Esc</kbd></span>
                    <span style={{ color: '#94a3b8' }}>Close modals</span>
                  </div>
                </div>
              </div>

              <div className="card">
                <h3>Export & Share</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  <button className="btn" onClick={() => {
                    const exportData = {
                      bandName: state.bandName,
                      genre: state.genre,
                      week: state.week,
                      fame: state.fame,
                      money: state.money,
                      fans: state.fans,
                      albums: state.albums?.length || 0,
                      songs: state.songs?.length || 0,
                      tours: state.tourHistory?.length || 0,
                      achievements: state.achievements?.length || 0,
                      careerStats: state.careerStats,
                      exportDate: new Date().toISOString()
                    };
                    const json = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${state.bandName || 'band'}-export-${state.week || 1}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    addLog('Game data exported!');
                  }}>
                    Export Game Data (JSON)
                  </button>
                  <button className="btn-secondary" onClick={() => {
                    const shareText = `ðŸŽ¸ ${state.bandName || 'My Band'} - Week ${state.week || 1}\n` +
                      `Fame: ${state.fame || 0} | Money: $${(state.money || 0).toLocaleString()}\n` +
                      `Albums: ${state.albums?.length || 0} | Songs: ${state.songs?.length || 0}\n` +
                      `Tours: ${state.tourHistory?.length || 0} | Achievements: ${state.achievements?.length || 0}`;
                    
                    if (navigator.share) {
                      navigator.share({
                        title: `${state.bandName} - Band Manager Progress`,
                        text: shareText
                      }).catch(() => {
                        navigator.clipboard.writeText(shareText);
                        addLog('Progress copied to clipboard!');
                      });
                    } else {
                      navigator.clipboard.writeText(shareText);
                      addLog('Progress copied to clipboard!');
                    }
                  }}>
                    Share Progress
                  </button>
                </div>
              </div>

              <div className="card">
                <h3>Theme</h3>
                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                  {['theme-modern', 'theme-warm', 'theme-neon', 'theme-pop'].map(t => (
                    <button
                      key={t}
                      className={theme === t ? 'btn' : 'btn-secondary'}
                      onClick={() => setTheme(t)}
                      style={{ fontSize: '12px', padding: '6px 12px' }}
                    >
                      {t.replace('theme-', '').charAt(0).toUpperCase() + t.replace('theme-', '').slice(1)}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Tooltip */}
      {showTooltip && (
        <div
          style={{
            position: 'fixed',
            left: `${tooltipPosition.x}px`,
            top: `${tooltipPosition.y}px`,
            background: '#000000',
            border: '1px solid #334155',
            borderRadius: '6px',
            padding: '8px 12px',
            fontSize: '0.85em',
            color: '#e2e8f0',
            zIndex: 10000,
            pointerEvents: 'none',
            maxWidth: '250px',
            boxShadow: '0 4px 12px rgba(0,0,0,0.5)',
            transform: 'translate(-50%, -100%)',
            marginTop: '-8px'
          }}
        >
          {showTooltip}
        </div>
      )}

      {/* Tutorial Modal */}
      {showTutorial && step === STEPS.GAME && (
        <div className="modal-overlay" onClick={() => {}}>
          <div className="modal" style={{ maxWidth: '600px' }} onClick={(e) => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
              <h2>Tutorial</h2>
              <button className="btn-secondary" onClick={() => {
                setShowTutorial(false);
                setState((s) => ({ ...s, tutorialCompleted: true }));
              }}>âœ•</button>
            </div>
            
            {tutorialStep === 0 && (
              <div>
                <h3>Welcome to Band Manager!</h3>
                <p>This tutorial will guide you through the basics of managing your band. You can skip it anytime or revisit it from the header.</p>
                <div style={{ marginTop: '16px', padding: '12px', background: '#000000', borderRadius: '6px' }}>
                  <strong>Goal:</strong> Build your band's fame, release music, and become a rockstar!
                </div>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '20px' }}>
                  <button className="btn-secondary" onClick={() => {
                    setShowTutorial(false);
                    setState((s) => ({ ...s, tutorialCompleted: true }));
                  }}>Skip Tutorial</button>
                  <button className="btn" onClick={() => setTutorialStep(1)}>Next â†’</button>
                </div>
              </div>
            )}
            
            {tutorialStep === 1 && (
              <div>
                <h3>1. Recording Music</h3>
                <p>Start by recording songs in the <strong>Actions</strong> tab. Each song costs money but generates streaming revenue over time.</p>
                <ul style={{ marginTop: '12px', paddingLeft: '20px' }}>
                  <li>Better studios = better song quality</li>
                  <li>Quality affects popularity and streams</li>
                  <li>Albums (8-12 songs) provide sustained revenue</li>
                </ul>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '20px' }}>
                  <button className="btn-secondary" onClick={() => setTutorialStep(0)}>â† Back</button>
                  <button className="btn" onClick={() => setTutorialStep(2)}>Next â†’</button>
                </div>
              </div>
            )}
            
            {tutorialStep === 2 && (
              <div>
                <h3>2. Managing Finances</h3>
                <p>Watch your money carefully! You have weekly expenses:</p>
                <ul style={{ marginTop: '12px', paddingLeft: '20px' }}>
                  <li>Base expenses: $100/week</li>
                  <li>Member salaries: $50 per member</li>
                  <li>Equipment and transport costs</li>
                  <li>Staff (manager, lawyer) if hired</li>
                </ul>
                <p style={{ marginTop: '12px' }}>Revenue comes from streaming, tours, merchandise (at 50+ fame), and gigs.</p>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '20px' }}>
                  <button className="btn-secondary" onClick={() => setTutorialStep(1)}>â† Back</button>
                  <button className="btn" onClick={() => setTutorialStep(3)}>Next â†’</button>
                </div>
              </div>
            )}
            
            {tutorialStep === 3 && (
              <div>
                <h3>3. Building Fame</h3>
                <p>Fame unlocks new opportunities:</p>
                <ul style={{ marginTop: '12px', paddingLeft: '20px' }}>
                  <li>Better venues and tours</li>
                  <li>Label deals (at higher fame)</li>
                  <li>Merchandise sales (50+ fame)</li>
                  <li>Collaborations (50+ fame)</li>
                  <li>More fans and revenue</li>
                </ul>
                <p style={{ marginTop: '12px' }}>Fame grows from successful releases, tours, and events.</p>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '20px' }}>
                  <button className="btn-secondary" onClick={() => setTutorialStep(2)}>â† Back</button>
                  <button className="btn" onClick={() => setTutorialStep(4)}>Next â†’</button>
                </div>
              </div>
            )}
            
            {tutorialStep === 4 && (
              <div>
                <h3>4. Social Media & Modern Features</h3>
                <p>The <strong>Social</strong> tab lets you:</p>
                <ul style={{ marginTop: '12px', paddingLeft: '20px' }}>
                  <li>Post on TikTok, Instagram, Twitter</li>
                  <li>Build algorithm favor for better discovery</li>
                  <li>Go viral for massive boosts</li>
                  <li>Get playlist placements</li>
                </ul>
                <p style={{ marginTop: '12px' }}>Social media is crucial for modern music success!</p>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '20px' }}>
                  <button className="btn-secondary" onClick={() => setTutorialStep(3)}>â† Back</button>
                  <button className="btn" onClick={() => setTutorialStep(5)}>Next â†’</button>
                </div>
              </div>
            )}
            
            {tutorialStep === 5 && (
              <div>
                <h3>5. Tours & Geographic Reach</h3>
                <p>In the <strong>Gigs</strong> tab, you can:</p>
                <ul style={{ marginTop: '12px', paddingLeft: '20px' }}>
                  <li>Book local gigs for quick cash</li>
                  <li>Plan tours (Regional, National, International)</li>
                  <li>Build reputation in different regions</li>
                  <li>Virtual concerts for global reach</li>
                </ul>
                <p style={{ marginTop: '12px' }}>Tours take multiple weeks but provide significant revenue and reputation.</p>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '20px' }}>
                  <button className="btn-secondary" onClick={() => setTutorialStep(4)}>â† Back</button>
                  <button className="btn" onClick={() => setTutorialStep(6)}>Next â†’</button>
                </div>
              </div>
            )}
            
            {tutorialStep === 6 && (
              <div>
                <h3>6. Tips & Strategy</h3>
                <ul style={{ marginTop: '12px', paddingLeft: '20px' }}>
                  <li><strong>Start small:</strong> Record a few singles before making albums</li>
                  <li><strong>Manage morale:</strong> Use Rest to keep band happy</li>
                  <li><strong>Upgrade wisely:</strong> Better studios = better music</li>
                  <li><strong>Watch expenses:</strong> Don't overspend early</li>
                  <li><strong>Use keyboard shortcuts:</strong> Ctrl+S to save, 1-7 for tabs</li>
                  <li><strong>Check Analytics:</strong> Track your revenue sources</li>
                </ul>
                <div style={{ marginTop: '16px', padding: '12px', background: '#064e3b', borderRadius: '6px', color: '#10b981' }}>
                  <strong>Pro Tip:</strong> Albums provide sustained revenue, but singles are faster to release!
                </div>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '20px' }}>
                  <button className="btn-secondary" onClick={() => setTutorialStep(5)}>â† Back</button>
                  <button className="btn" onClick={() => {
                    setShowTutorial(false);
                    setTutorialStep(0);
                    setState((s) => ({ ...s, tutorialCompleted: true }));
                  }}>Complete Tutorial</button>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Event Popup Modal */}
      {showEventPopup && eventPopupData && (
        <div className="modal-overlay" onClick={(e) => {
          // Don't close if clicking on choices
          if (!eventPopupData.choices || eventPopupData.choices.length === 0) {
            setShowEventPopup(false);
          }
        }}>
          <div className="modal" style={{ maxWidth: '600px' }} onClick={(e) => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
              <h2 style={{ 
                color: eventPopupData.type === 'success' ? '#10b981' : 
                       eventPopupData.type === 'error' ? '#ef4444' : 
                       eventPopupData.type === 'warning' ? '#f59e0b' : '#3b82f6'
              }}>
                {eventPopupData.title}
              </h2>
              {(!eventPopupData.choices || eventPopupData.choices.length === 0) && (
                <button className="btn-secondary" onClick={() => setShowEventPopup(false)}>âœ•</button>
              )}
            </div>
            
            <div style={{ marginBottom: '16px' }}>
              <p style={{ fontSize: '1em', lineHeight: '1.6', color: '#e2e8f0' }}>
                {eventPopupData.message}
              </p>
            </div>

            {eventPopupData.details && (
              <div style={{ 
                padding: '12px', 
                background: '#000000', 
                borderRadius: '6px', 
                border: '1px solid #334155',
                marginBottom: '16px'
              }}>
                <h3 style={{ fontSize: '0.9em', color: '#94a3b8', marginBottom: '8px' }}>Details:</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                  {Object.entries(eventPopupData.details).map(([key, value]) => (
                    <div key={key} style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.9em' }}>
                      <span style={{ color: '#94a3b8', textTransform: 'capitalize' }}>{key.replace(/([A-Z])/g, ' $1').trim()}:</span>
                      <strong style={{ color: '#e2e8f0' }}>{value}</strong>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Event Choices */}
            {eventPopupData.choices && eventPopupData.choices.length > 0 && (
              <div style={{ marginBottom: '16px' }}>
                <h3 style={{ fontSize: '1em', color: '#e2e8f0', marginBottom: '12px' }}>Choose your action:</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                  {eventPopupData.choices.map((choice, idx) => {
                    const effects = [];
                    if (choice.money !== 0) effects.push(`$${choice.money > 0 ? '+' : ''}${choice.money}`);
                    if (choice.morale !== 0) effects.push(`Morale ${choice.morale > 0 ? '+' : ''}${choice.morale}`);
                    if (choice.fame !== 0) effects.push(`Fame ${choice.fame > 0 ? '+' : ''}${choice.fame}`);
                    
                    return (
                      <button
                        key={idx}
                        className="btn"
                        onClick={() => {
                          // If it's an event with choices, resolve it
                          if (eventPopupData.isEvent && currentEvent) {
                            resolveEvent(choice);
                          } else if (eventPopupData.isEvent) {
                            // Handle custom onClick if provided (e.g., for member quit)
                            if (choice.onClick) {
                              choice.onClick();
                            } else {
                              // Fallback: apply choice effects directly if no currentEvent
                              setState((s) => ({
                                ...s,
                                money: s.money + (choice.money || 0),
                                morale: clampMorale(s.morale + (choice.morale || 0)),
                                fame: s.fame + (choice.fame || 0),
                                fans: s.fans + (choice.fans || 0)
                              }));
                              addLog(`${eventPopupData.title}: ${choice.text}`);
                            }
                          }
                          setShowEventPopup(false);
                          setEventPopupData(null);
                        }}
                        style={{
                          width: '100%',
                          textAlign: 'left',
                          padding: '14px',
                          background: choice.money > 0 || choice.fame > 0 ? '#064e3b' : 
                                     choice.money < -200 || choice.morale < -10 ? '#7f1d1d' : '#1e3a8a',
                          border: '1px solid',
                          borderColor: choice.money > 0 || choice.fame > 0 ? '#10b981' : 
                                      choice.money < -200 || choice.morale < -10 ? '#ef4444' : '#3b82f6',
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '4px'
                        }}
                      >
                        <strong>{choice.text}</strong>
                        {effects.length > 0 && (
                          <span style={{ fontSize: '0.85em', opacity: 0.9 }}>
                            {effects.join(' â€¢ ')}
                          </span>
                        )}
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            {(!eventPopupData.choices || eventPopupData.choices.length === 0) && (
              <button 
                className="btn" 
                onClick={() => setShowEventPopup(false)}
                style={{ width: '100%' }}
              >
                Continue
              </button>
            )}
          </div>
        </div>
      )}

      {/* Weekly Summary Popup */}
      {showWeeklyPopup && weeklyPopupData && (
        <div className="modal-overlay" onClick={() => setShowWeeklyPopup(false)}>
          <div className="modal" style={{ maxWidth: '600px' }} onClick={(e) => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
              <h2 style={{ color: '#3b82f6' }}>
                Week {weeklyPopupData.week} Summary
              </h2>
              <button className="btn-secondary" onClick={() => setShowWeeklyPopup(false)}>âœ•</button>
            </div>
            
            <div style={{ marginBottom: '16px' }}>
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))',
                gap: '12px',
                marginBottom: '16px'
              }}>
                <div style={{ 
                  padding: '12px', 
                  background: '#7f1d1d', 
                  borderRadius: '6px', 
                  border: '1px solid #ef4444'
                }}>
                  <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Expenses</div>
                  <div style={{ fontSize: '1.3em', fontWeight: 'bold', color: '#ef4444' }}>
                    -${weeklyPopupData.expenses.toLocaleString()}
                  </div>
                </div>
                <div style={{ 
                  padding: '12px', 
                  background: '#064e3b', 
                  borderRadius: '6px', 
                  border: '1px solid #10b981'
                }}>
                  <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Royalties</div>
                  <div style={{ fontSize: '1.3em', fontWeight: 'bold', color: '#10b981' }}>
                    +${weeklyPopupData.royalties.toLocaleString()}
                  </div>
                </div>
                <div style={{ 
                  padding: '12px', 
                  background: '#1e3a8a', 
                  borderRadius: '6px', 
                  border: '1px solid #3b82f6'
                }}>
                  <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>Net</div>
                  <div style={{ fontSize: '1.3em', fontWeight: 'bold', color: '#3b82f6' }}>
                    ${(weeklyPopupData.royalties - weeklyPopupData.expenses).toLocaleString()}
                  </div>
                </div>
                <div style={{ 
                  padding: '12px', 
                  background: '#422006', 
                  borderRadius: '6px', 
                  border: '1px solid #f59e0b'
                }}>
                  <div style={{ fontSize: '0.85em', color: '#94a3b8', marginBottom: '4px' }}>New Fans</div>
                  <div style={{ fontSize: '1.3em', fontWeight: 'bold', color: '#f59e0b' }}>
                    +{weeklyPopupData.fanGrowth.toLocaleString()}
                  </div>
                </div>
              </div>

              {weeklyPopupData.highlights.length > 0 && (
                <div style={{ 
                  padding: '12px', 
                  background: '#0f172a', 
                  borderRadius: '6px', 
                  border: '1px solid #334155'
                }}>
                  <h3 style={{ fontSize: '0.9em', color: '#94a3b8', marginBottom: '8px' }}>Highlights:</h3>
                  <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                    {weeklyPopupData.highlights.map((highlight, idx) => (
                      <li key={idx} style={{ 
                        padding: '6px 0',
                        fontSize: '0.9em',
                        color: '#e2e8f0',
                        borderBottom: idx < weeklyPopupData.highlights.length - 1 ? '1px solid #334155' : 'none'
                      }}>
                        {highlight}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            <button 
              className="btn" 
              onClick={() => setShowWeeklyPopup(false)}
              style={{ width: '100%' }}
            >
              Continue
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

export default App;
